

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/bg/%E5%A4%B4%E5%83%8F.jpg">
  <link rel="icon" href="/img/bg/%E5%A4%B4%E5%83%8F.jpg">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="John Doe">
  <meta name="keywords" content="">
  
    <meta name="description" content="1、技术点一、安装docker、mysql、redis1、centos7安装docker1、卸载系统之前的docker1sudo yum remove docker docker-client docker-client-latest docker-common docker-latest docker-latest-logrotate docker-logrotate docker-engine">
<meta property="og:type" content="article">
<meta property="og:title" content="谷粒商城">
<meta property="og:url" content="http://example.com/2024/02/26/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="1、技术点一、安装docker、mysql、redis1、centos7安装docker1、卸载系统之前的docker1sudo yum remove docker docker-client docker-client-latest docker-common docker-latest docker-latest-logrotate docker-logrotate docker-engine">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/img/guli_img/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E.jpg">
<meta property="article:published_time" content="2024-02-25T17:36:27.000Z">
<meta property="article:modified_time" content="2024-03-03T16:20:55.747Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="Java">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://example.com/img/guli_img/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E.jpg">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>谷粒商城 - Hexo</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.9.7","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":false,"loading_img":"/img/loading.gif","onlypost":true,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":null,"google":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false},"gtag":null},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  

  

  

  

  

  



  
<meta name="generator" content="Hexo 7.1.1"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Taoao</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/bg/aaaa.jpg') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="谷粒商城"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2024-02-26 01:36" pubdate>
          2024年2月26日 凌晨
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          24k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          204 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">谷粒商城</h1>
            
            
              <div class="markdown-body">
                
                <h2 id="1、技术点"><a href="#1、技术点" class="headerlink" title="1、技术点"></a>1、技术点</h2><h3 id="一、安装docker、mysql、redis"><a href="#一、安装docker、mysql、redis" class="headerlink" title="一、安装docker、mysql、redis"></a>一、安装docker、mysql、redis</h3><h4 id="1、centos7安装docker"><a href="#1、centos7安装docker" class="headerlink" title="1、centos7安装docker"></a>1、centos7安装docker</h4><h5 id="1、卸载系统之前的docker"><a href="#1、卸载系统之前的docker" class="headerlink" title="1、卸载系统之前的docker"></a>1、卸载系统之前的docker</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">sudo yum remove docker docker-client docker-client-latest docker-common docker-latest docker-latest-logrotate docker-logrotate docker-engine<br></code></pre></td></tr></table></figure>

<h5 id="2、安装依赖包"><a href="#2、安装依赖包" class="headerlink" title="2、安装依赖包"></a>2、安装依赖包</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">sudo yum install -y yum-utils device-mapper-persistent-data lvm2<br></code></pre></td></tr></table></figure>

<h5 id="3、设置docker的安装地址"><a href="#3、设置docker的安装地址" class="headerlink" title="3、设置docker的安装地址"></a>3、设置docker的安装地址</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">sudo yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo<br></code></pre></td></tr></table></figure>

<h5 id="4、安装docker"><a href="#4、安装docker" class="headerlink" title="4、安装docker"></a>4、安装docker</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">sudo yum install docker-ce docker-ce-cli containerd.io<br></code></pre></td></tr></table></figure>

<h5 id="5、设置docker开机启动"><a href="#5、设置docker开机启动" class="headerlink" title="5、设置docker开机启动"></a>5、设置docker开机启动</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">sudo systemctl enable docker<br></code></pre></td></tr></table></figure>

<h5 id="6、启动docker"><a href="#6、启动docker" class="headerlink" title="6、启动docker"></a>6、启动docker</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">sudo systemctl start docker<br></code></pre></td></tr></table></figure>

<h5 id="7、为docker配置阿里云镜像加速"><a href="#7、为docker配置阿里云镜像加速" class="headerlink" title="7、为docker配置阿里云镜像加速"></a>7、为docker配置阿里云镜像加速</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">sudo mkdir -p /etc/docker<br></code></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">sudo tee /etc/docker/daemon.json &lt;&lt;-&#x27;EOF&#x27;<br>&#123;<br>  &quot;registry-mirrors&quot;: [&quot;阿里云镜像加速器地址&quot;]<br>&#125;<br>EOF<br></code></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">sudo systemctl daemon-reload<br></code></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">sudo systemctl restart docker<br></code></pre></td></tr></table></figure>

<h4 id="2、使用docker安装MySQL"><a href="#2、使用docker安装MySQL" class="headerlink" title="2、使用docker安装MySQL"></a>2、使用docker安装MySQL</h4><h5 id="1、拉取镜像"><a href="#1、拉取镜像" class="headerlink" title="1、拉取镜像"></a>1、拉取镜像</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">sudo docker pull mysql:5.7<br></code></pre></td></tr></table></figure>

<h5 id="2、创建实例并启动"><a href="#2、创建实例并启动" class="headerlink" title="2、创建实例并启动"></a>2、创建实例并启动</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell">sudo docker run -p 3306:3306 --name mysql \<br>-v /mydata/mysql/log:/var/log/mysql \<br>-v /mydata/mysql/data:/var/lib/mysql \<br>-v /mydata/mysql/conf:/etc/mysql \<br>-e MYSQL_ROOT_PASSWORD=root \<br>--restart=always \<br>-d mysql:5.7<br></code></pre></td></tr></table></figure>

<h5 id="3、修改MySQL的配置文件"><a href="#3、修改MySQL的配置文件" class="headerlink" title="3、修改MySQL的配置文件"></a>3、修改MySQL的配置文件</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">vim /mydata/mysql/conf/my.cnf<br></code></pre></td></tr></table></figure>

<p>添加</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs shell">[client]<br>default-character-set=utf8<br><br>[mysql]<br>default-character-set=utf8<br><br>[mysqld]<br>init_connect=&#x27;SET collation_connection = utf8_unicode_ci&#x27;<br>init_connect=&#x27;SET NAMES utf8&#x27;<br>character-set-server=utf8<br>collation-server=utf8_unicode_ci<br>skip-character-set-client-handshake<br>skip-name-resolve<br></code></pre></td></tr></table></figure>



<h4 id="3、使用docker安装Redis"><a href="#3、使用docker安装Redis" class="headerlink" title="3、使用docker安装Redis"></a>3、使用docker安装Redis</h4><h5 id="1、拉取镜像-1"><a href="#1、拉取镜像-1" class="headerlink" title="1、拉取镜像"></a>1、拉取镜像</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker pull redis<br></code></pre></td></tr></table></figure>

<h5 id="2、创建实例并启动-1"><a href="#2、创建实例并启动-1" class="headerlink" title="2、创建实例并启动"></a>2、创建实例并启动</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">mkdir -p /mydata/redis/conf<br></code></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">touch /mydata/redis/conf/redis.conf<br></code></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker run -p 6379:6379 \<br>--name redis \<br>-v /mydata/redis/data:/data \<br>-v /mydata/redis/conf/redis.conf:/etc/redis/redis.conf \<br>--restart=always \<br>-d redis \<br>redis-server /etc/redis/redis.conf<br></code></pre></td></tr></table></figure>

<p>redis 自描述文件：<a target="_blank" rel="noopener" href="https://raw.githubusercontent.com/antirez/redis/4.0/redis.conf">https://raw.githubusercontent.com/antirez/redis/4.0/redis.conf</a></p>
<h5 id="3、编辑配置文件"><a href="#3、编辑配置文件" class="headerlink" title="3、编辑配置文件"></a>3、编辑配置文件</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">vim /mydata/redis/conf/redis.conf<br></code></pre></td></tr></table></figure>

<p>添加，让redis数据持久化</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">appendonly yes<br></code></pre></td></tr></table></figure>

<h5 id="3、使用redis镜像执行redis-cli命令连接"><a href="#3、使用redis镜像执行redis-cli命令连接" class="headerlink" title="3、使用redis镜像执行redis-cli命令连接"></a>3、使用redis镜像执行redis-cli命令连接</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker exec -it redis redis-cli<br></code></pre></td></tr></table></figure>

<h4 id="4、"><a href="#4、" class="headerlink" title="4、"></a>4、</h4><h3 id="二、spring-cloud-alibaba介绍"><a href="#二、spring-cloud-alibaba介绍" class="headerlink" title="二、spring-cloud-alibaba介绍"></a>二、spring-cloud-alibaba介绍</h3><h4 id="1、Nacos介绍"><a href="#1、Nacos介绍" class="headerlink" title="1、Nacos介绍"></a>1、Nacos介绍</h4><h5 id="1、docker安装nacos"><a href="#1、docker安装nacos" class="headerlink" title="1、docker安装nacos"></a>1、docker安装nacos</h5><p>1、拉取镜像</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker pull nacos/nacos-server:1.1.3<br></code></pre></td></tr></table></figure>

<p>2、创建本地的映射文件，custom.properties</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">mkdir -p /mydata/nacos/init.d /mydata/nacos/logs<br></code></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">touch /mydata/nacos/init.d/custom.properties<br></code></pre></td></tr></table></figure>

<p> 在custom.properties文件中写入以下配置:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">management.endpoints.web.exposure.include=*<br></code></pre></td></tr></table></figure>

<p>3、创建容器：使用standalone模式并开放8848端口，并映射配置文件和日志目录，数据库默认使用 Derby</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker run -d -p 8848:8848 -e MODE=standalone -e PREFER_HOST_MODE=hostname  -v /mydata/nacos/init.d/custom.properties:/home/nacos/init.d/custom.properties  -v /mydata/nacos/logs:/home/nacos/logs  --restart always  --name nacos nacos/nacos-server:1.1.3<br></code></pre></td></tr></table></figure>

<p>4、访问Nacos</p>
<p><code>http://192.168.100.135:8848/nacos</code></p>
<h5 id="2、Nacos作为注册中心"><a href="#2、Nacos作为注册中心" class="headerlink" title="2、Nacos作为注册中心"></a>2、Nacos作为注册中心</h5><h6 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h6><blockquote>
<p>1、引入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml">&gt;<span class="hljs-comment">&lt;!--Nacos注册中心--&gt;</span><br>&gt;<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br> <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br> <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>&gt;<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>2、添加配置：配置注册中心的地址</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">&gt;spring:</span><br><span class="hljs-string">&gt;cloud:</span><br><span class="hljs-string">&gt;nacos:</span><br><span class="hljs-string">&gt;discovery:</span><br><span class="hljs-string">&gt;server-addr:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.100</span><span class="hljs-number">.135</span><span class="hljs-string">:8848</span>  <span class="hljs-comment"># nacos注册中心的地址</span><br><span class="hljs-string">&gt;application:</span><br><span class="hljs-string">&gt;name:</span> <span class="hljs-string">gulimall-coupon</span>  <span class="hljs-comment"># 给这个服务起个名字 （这样Nacos注册中心就能发现这个服务了）</span><br></code></pre></td></tr></table></figure>

<p>3、在启动类上使用<code>@EnableDiscoveryClient</code> 注解 开启服务注册与发现功能</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java">&gt;<span class="hljs-keyword">import</span> org.springframework.boot.SpringApplication;<br>&gt;<span class="hljs-keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;<br>&gt;<span class="hljs-keyword">import</span> org.springframework.cloud.client.discovery.EnableDiscoveryClient;<br><br>&gt;<span class="hljs-meta">@SpringBootApplication</span><br>&gt;<span class="hljs-meta">@EnableDiscoveryClient</span>  <span class="hljs-comment">// Nacos注册中心 开启服务注册与发现 功能</span><br>&gt;<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GulimallCouponApplication</span> &#123;<br>&gt;<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>&gt;SpringApplication.run(GulimallCouponApplication.class, args);<br>&gt;&#125;<br>&gt;&#125;<br></code></pre></td></tr></table></figure>
</blockquote>
<p><img src="/img/guli_img/Nacos%E6%B3%A8%E5%86%8C%E6%88%90%E5%8A%9F.jpg" alt="Nacos注册成功"></p>
<h5 id="3、Nacos作为配置中心"><a href="#3、Nacos作为配置中心" class="headerlink" title="3、Nacos作为配置中心"></a>3、Nacos作为配置中心</h5><h6 id="1、基本使用步骤"><a href="#1、基本使用步骤" class="headerlink" title="1、基本使用步骤"></a>1、基本使用步骤</h6><blockquote>
<p>1、引入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml">&gt;<span class="hljs-comment">&lt;!--Nacos配置中心--&gt;</span><br>&gt;<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br> <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br> <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-config<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>&gt;<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>2、在应用的 &#x2F;src&#x2F;main&#x2F;resources&#x2F;bootstrap.properties 配置文件中配置 Nacos Config 元数据</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-attr">&gt;#</span> <span class="hljs-string">应用名称</span><br><span class="hljs-attr">&gt;spring.application.name</span>=<span class="hljs-string">gulimall_coupon</span><br><span class="hljs-attr">&gt;#</span> <span class="hljs-string">Nacos配置中心地址</span><br><span class="hljs-attr">&gt;spring.cloud.nacos.config.server-addr</span>=<span class="hljs-string">192.168.100.135:8848</span><br></code></pre></td></tr></table></figure>

<p>3、需要给配置中心默认添加一个叫 <code>当前应用名.properties</code> 的配置文件,添加任何配置</p>
<p><img src="/img/guli_img/Nacos%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83.jpg" alt="Nacos配置中心"></p>
<p>4、给controller上加上注解<code>@RefreshScope</code> ，可以动态刷新配置</p>
<p>5、使用注解<code>@Value(&quot;$&#123;配置项&#125;&quot;)</code> 可以动态获取配置</p>
</blockquote>
<h6 id="2、Nacos作为配置中心的细节"><a href="#2、Nacos作为配置中心的细节" class="headerlink" title="2、Nacos作为配置中心的细节"></a>2、Nacos作为配置中心的细节</h6><ul>
<li><p>1、命名空间：用来做配置隔离</p>
<ul>
<li><p>默认的命名空间是：public（保留空间）：默认新增的所有配置都在public空间下</p>
</li>
<li><p>1、开发（dev）、测试（test）、生产（prop）:可以利用命名空间来做环境隔离</p>
<p><img src="/img/guli_img/Nacos%E6%96%B0%E5%BB%BA%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4.jpg" alt="Nacos新建命名空间"></p>
<p><img src="/img/guli_img/Nacos%E6%96%B0%E5%BB%BA%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B42.jpg" alt="Nacos新建命名空间2"></p>
<ul>
<li><p>需要在<code>bootstrap.properties</code> 中指定命名空间ID使用哪个命名空间下的配置</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-comment"># 应用名称</span><br><span class="hljs-attr">spring.application.name</span>=<span class="hljs-string">gulimall_coupon</span><br><span class="hljs-comment"># Nacos配置中心地址</span><br><span class="hljs-attr">spring.cloud.nacos.config.server-addr</span>=<span class="hljs-string">192.168.100.135:8848</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"># 指定使用哪个命名空间, = 号后面的是 prop 命名空间的 命名空间ID</span><br><span class="hljs-attr">spring.cloud.nacos.config.namespace</span>=<span class="hljs-string">d4ece6ea-351b-43f5-b2c6-9cd8283cd20c</span><br></code></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>2、可以基于每一个微服务之间互相隔离配置，给每一个微服务都创建一个自己的命名空间，这样就只加载自己命名空间下的配置</p>
<p><img src="/img/guli_img/%E7%BB%99%E6%AF%8F%E4%B8%80%E4%B8%AA%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%88%9B%E5%BB%BA%E8%87%AA%E5%B7%B1%E7%9A%84%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4.jpg" alt="给每一个微服务创建自己的命名空间"></p>
<p><img src="/img/guli_img/%E7%BB%99%E6%AF%8F%E4%B8%80%E4%B8%AA%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%88%9B%E5%BB%BA%E8%87%AA%E5%B7%B1%E7%9A%84%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B42.jpg" alt="给每一个微服务创建自己的命名空间2"></p>
<ul>
<li><p>在这里指定coupon命名空间的ID</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-comment"># 应用名称</span><br><span class="hljs-attr">spring.application.name</span>=<span class="hljs-string">gulimall_coupon</span><br><span class="hljs-comment"># Nacos配置中心地址</span><br><span class="hljs-attr">spring.cloud.nacos.config.server-addr</span>=<span class="hljs-string">192.168.100.135:8848</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"># 指定使用哪个命名空间, = 号后面的是 coupon 命名空间的 命名空间ID</span><br><span class="hljs-attr">spring.cloud.nacos.config.namespace</span>=<span class="hljs-string">fe5f45d3-cafc-41f7-8c6c-7083d0f0e477</span><br></code></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
</li>
<li><p>2、配置集：所有的配置的集合</p>
</li>
<li><p>3、配置集ID：类似配置文件名 【就是<code>Data ID</code>】</p>
<p><img src="/img/guli_img/%E9%85%8D%E7%BD%AE%E9%9B%86ID.jpg" alt="配置集ID"></p>
</li>
<li><p>4、配置分组</p>
<ul>
<li><p>默认所有的配置集都属于<code>DEFAULT_GROUP</code></p>
</li>
<li><p>可以随意定制组名</p>
<p><img src="/img/guli_img/%E9%85%8D%E7%BD%AE%E5%88%86%E7%BB%84.jpg" alt="配置分组"></p>
<p><img src="/img/guli_img/%E9%85%8D%E7%BD%AE%E5%88%86%E7%BB%842.jpg" alt="配置分组2"></p>
</li>
<li><p>在<code>bootstarp.properties</code> 中可以指定分组</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-comment"># 应用名称</span><br><span class="hljs-attr">spring.application.name</span>=<span class="hljs-string">gulimall_coupon</span><br><span class="hljs-comment"># Nacos配置中心地址</span><br><span class="hljs-attr">spring.cloud.nacos.config.server-addr</span>=<span class="hljs-string">192.168.100.135:8848</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"># 指定使用哪个命名空间, = 号后面的是 coupon 命名空间的 命名空间ID</span><br><span class="hljs-attr">spring.cloud.nacos.config.namespace</span>=<span class="hljs-string">fe5f45d3-cafc-41f7-8c6c-7083d0f0e477</span><br><span class="hljs-comment"># 这里可以指定分组 1111</span><br><span class="hljs-attr">spring.cloud.nacos.config.group</span>=<span class="hljs-string">1111</span><br></code></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<p><strong>流程：</strong> 每个微服务都创建自己的命名空间，然后使用配置分组来区分环境【dev、test、prop环境】</p>
<p><img src="/img/guli_img/%E4%BD%BF%E7%94%A8%E4%B8%8D%E5%90%8C%E5%88%86%E7%BB%84%E6%9D%A5%E5%8C%BA%E5%88%86%E4%B8%8D%E5%90%8C%E7%8E%AF%E5%A2%83.jpg" alt="使用不同分组来区分不同环境"></p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-comment"># 应用名称</span><br><span class="hljs-attr">spring.application.name</span>=<span class="hljs-string">gulimall_coupon</span><br><span class="hljs-comment"># Nacos配置中心地址</span><br><span class="hljs-attr">spring.cloud.nacos.config.server-addr</span>=<span class="hljs-string">192.168.100.135:8848</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"># 指定使用哪个命名空间, = 号后面的是 coupon 命名空间的 命名空间ID</span><br><span class="hljs-attr">spring.cloud.nacos.config.namespace</span>=<span class="hljs-string">fe5f45d3-cafc-41f7-8c6c-7083d0f0e477</span><br><span class="hljs-comment"># 这里可以指定分组 dev</span><br><span class="hljs-attr">spring.cloud.nacos.config.group</span>=<span class="hljs-string">dev</span><br></code></pre></td></tr></table></figure>

<h6 id="3、从配置中心中同时加载多个配置集"><a href="#3、从配置中心中同时加载多个配置集" class="headerlink" title="3、从配置中心中同时加载多个配置集"></a>3、从配置中心中同时加载多个配置集</h6><ul>
<li>微服务的任何配置信息，任何配置文件都可以放在配置中心中</li>
<li>只需要在<code>bootstrap.properties </code> 中说明加载配置中心的哪些配置文件即可</li>
</ul>
<p><img src="/img/guli_img/%E5%9C%A8coupon%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4%E4%B8%8B%E5%88%9B%E5%BB%BA%E5%90%84%E7%A7%8D%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6.jpg" alt="在coupon命名空间下创建各种配置文件"></p>
<p><img src="/img/guli_img/%E5%9C%A8bootstrap.properties%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E4%B8%8B%E6%8C%87%E5%AE%9A%E5%8A%A0%E8%BD%BD%E5%A4%9A%E4%B8%AA%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6.jpg" alt="在bootstrap.properties配置文件下指定加载多个配置文件"></p>
<h3 id="三、SpringCloud介绍"><a href="#三、SpringCloud介绍" class="headerlink" title="三、SpringCloud介绍"></a>三、SpringCloud介绍</h3><h4 id="1、Feign声明式远程调用"><a href="#1、Feign声明式远程调用" class="headerlink" title="1、Feign声明式远程调用"></a>1、Feign声明式远程调用</h4><h5 id="步骤-1"><a href="#步骤-1" class="headerlink" title="步骤"></a>步骤</h5><blockquote>
<p>首先，远程有一个接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java">&gt;<span class="hljs-meta">@RestController</span><br>&gt;<span class="hljs-meta">@RequestMapping(&quot;coupon/coupon&quot;)</span><br>&gt;<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CouponController</span> &#123;<br><br> <span class="hljs-meta">@RequestMapping(&quot;/member/list&quot;)</span><br> <span class="hljs-keyword">public</span> R <span class="hljs-title function_">membercoupons</span><span class="hljs-params">()</span>&#123;<br>     <span class="hljs-type">CouponEntity</span> <span class="hljs-variable">couponEntity</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CouponEntity</span>();<br>     couponEntity.setCouponName(<span class="hljs-string">&quot;满100减10&quot;</span>);<br>     <span class="hljs-keyword">return</span> R.ok().put(<span class="hljs-string">&quot;coupons&quot;</span>,Arrays.asList(couponEntity));<br> &#125;<br>&gt;&#125;<br></code></pre></td></tr></table></figure>



<p>1、引入open-feign</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml">&gt;<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br> <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br> <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>&gt;<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>2、在启动类上加上注解<code>@EnableFeignClients</code>,开启远程调用功能</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java">&gt;<span class="hljs-keyword">import</span> org.springframework.boot.SpringApplication;<br>&gt;<span class="hljs-keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;<br>&gt;<span class="hljs-keyword">import</span> org.springframework.cloud.client.discovery.EnableDiscoveryClient;<br>&gt;<span class="hljs-keyword">import</span> org.springframework.cloud.openfeign.EnableFeignClients;<br><br>&gt;<span class="hljs-meta">@SpringBootApplication</span><br>&gt;<span class="hljs-meta">@EnableDiscoveryClient</span><br>&gt;<span class="hljs-meta">@EnableFeignClients(basePackages = &quot;远程调用的类所在包的全包名&quot;)</span>  <span class="hljs-comment">// 开启远程调用功能</span><br>&gt;<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GulimallMemberApplication</span> &#123;<br><br>&gt;<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>&gt;SpringApplication.run(GulimallMemberApplication.class, args);<br>&gt;&#125;<br>&gt;&#125;<br></code></pre></td></tr></table></figure>

<p>3、编写一个接口，告诉SpringCloud这个接口需要调用远程服务</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java">&gt;<span class="hljs-keyword">import</span> com.example.common.utils.R;<br>&gt;<span class="hljs-keyword">import</span> org.springframework.cloud.openfeign.FeignClient;<br>&gt;<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;<br><br>&gt;<span class="hljs-meta">@FeignClient(&quot;被远程调用的服务名称&quot;)</span>  <span class="hljs-comment">// 告诉SpringCloud这个接口是一个远程客户端</span><br>&gt;<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">CouponFeignService</span> &#123;<br>&gt;<span class="hljs-meta">@RequestMapping(&quot;/coupon/coupon/member/list&quot;)</span><br>&gt;<span class="hljs-keyword">public</span> R <span class="hljs-title function_">membercoupons</span><span class="hljs-params">()</span>;<br>&gt;&#125;<br></code></pre></td></tr></table></figure>

<p>4、 远程调用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java">&gt;<span class="hljs-meta">@RestController</span><br>&gt;<span class="hljs-meta">@RequestMapping(&quot;member/member&quot;)</span><br>&gt;<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MemberController</span> &#123;<br>&gt;<span class="hljs-comment">//注入</span><br>&gt;<span class="hljs-meta">@Autowired</span><br>&gt;CouponFeignService couponFeignService;<br><br>&gt;<span class="hljs-meta">@RequestMapping(&quot;/coupons&quot;)</span><br>&gt;<span class="hljs-keyword">public</span> R <span class="hljs-title function_">test</span><span class="hljs-params">()</span> &#123;<br>&gt;<span class="hljs-type">MemberEntity</span> <span class="hljs-variable">memberEntity</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MemberEntity</span>();<br>&gt;memberEntity.setNickname(<span class="hljs-string">&quot;张三&quot;</span>);<br>&gt;<span class="hljs-type">R</span> <span class="hljs-variable">membercoupons</span> <span class="hljs-operator">=</span> couponFeignService.membercoupons();<br>&gt;<span class="hljs-keyword">return</span> R.ok().put(<span class="hljs-string">&quot;member&quot;</span>,memberEntity).put(<span class="hljs-string">&quot;coupons&quot;</span>,membercoupons.get(<span class="hljs-string">&quot;coupons&quot;</span>));<br>&gt;&#125;<br>&gt;&#125;<br></code></pre></td></tr></table></figure>
</blockquote>
<p><img src="/img/guli_img/Feign%E8%BF%9C%E7%A8%8B%E8%B0%83%E7%94%A8%E6%88%90%E5%8A%9F.jpg" alt="Feign远程调用成功"></p>
<h4 id="2、Gateway网关"><a href="#2、Gateway网关" class="headerlink" title="2、Gateway网关"></a>2、Gateway网关</h4><p>网关作为流量的入口，常用功能包括路由转发、权限校验、限流控制等</p>
<h5 id="步骤-2"><a href="#步骤-2" class="headerlink" title="步骤"></a>步骤</h5><blockquote>
<h3 id="1、开启服务的注册发现"><a href="#1、开启服务的注册发现" class="headerlink" title="1、开启服务的注册发现"></a>1、开启服务的注册发现</h3><ul>
<li>1、在main方法中添加<code>@EnableDiscoveryClient</code>注解</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java">&gt;<span class="hljs-keyword">import</span> org.springframework.boot.SpringApplication;<br>&gt;<span class="hljs-keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;<br>&gt;<span class="hljs-keyword">import</span> org.springframework.boot.autoconfigure.jdbc.DataSourceAutoConfiguration;<br>&gt;<span class="hljs-keyword">import</span> org.springframework.cloud.client.discovery.EnableDiscoveryClient;<br><br>&gt;<span class="hljs-meta">@SpringBootApplication(exclude = &#123;DataSourceAutoConfiguration.class&#125;)</span>   <span class="hljs-comment">// 排除跟数据库有关的配置</span><br>&gt;<span class="hljs-meta">@EnableDiscoveryClient</span>  <span class="hljs-comment">// 开启服务的注册发现</span><br>&gt;<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GulimallGatewayApplication</span> &#123;<br> <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>     SpringApplication.run(GulimallGatewayApplication.class, args);<br> &#125;<br>&gt;&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>2、在<code>application.properties</code>配置文件中配置Nacos注册中心地址</li>
</ul>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-attr">&gt;#</span> <span class="hljs-string">配置nacos 注册中心的地址</span><br><span class="hljs-attr">&gt;spring.cloud.nacos.discovery.server-addr</span>=<span class="hljs-string">192.168.100.135:8848</span><br><span class="hljs-attr">&gt;#</span> <span class="hljs-string">配置当前应用的名字</span><br><span class="hljs-attr">&gt;spring.application.name</span>=<span class="hljs-string">gulimall-gateway</span><br><span class="hljs-attr">&gt;#</span> <span class="hljs-string">端口</span><br><span class="hljs-attr">&gt;server.port</span>=<span class="hljs-string">88</span><br></code></pre></td></tr></table></figure>

<p><img src="/img/guli_img/gateway%E7%BD%91%E5%85%B3%E7%9A%84%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6.png" alt="gateway网关的配置文件"></p>
<p><img src="/img/guli_img/gateway%E7%BD%91%E5%85%B3%E5%9C%A8Nacos%E4%B8%AD%E5%88%9B%E5%BB%BA%E7%9A%84%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4.png" alt="gateway网关在Nacos中创建的命名空间"></p>
<ul>
<li>3、添加<code>bootstrap.properties</code>  Nacos 配置中心的配置文件</li>
</ul>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-attr">&gt;#</span><br><span class="hljs-attr">&gt;spring.application.name</span>=<span class="hljs-string">gulimall-coupon</span><br><span class="hljs-attr">&gt;#</span> <span class="hljs-string">Nacos 配置中心的地址</span><br><span class="hljs-attr">&gt;spring.cloud.nacos.config.server-addr</span>=<span class="hljs-string">192.168.100.135:8848</span><br><span class="hljs-attr">&gt;#</span> <span class="hljs-string">Nacos 命名空间地址</span><br><span class="hljs-attr">&gt;spring.cloud.nacos.config.namespace</span>=<span class="hljs-string">e5c12626-5582-4f1b-b866-6d51fbf49fe3</span><br></code></pre></td></tr></table></figure>

<h3 id="2、网关测试"><a href="#2、网关测试" class="headerlink" title="2、网关测试"></a>2、网关测试</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">&gt;spring:</span><br><span class="hljs-string">&gt;cloud:</span><br> <span class="hljs-attr">gateway:</span><br>   <span class="hljs-comment"># 路由规则</span><br>   <span class="hljs-attr">routes:</span><br>       <span class="hljs-comment"># id：每一个路由规则都要有一个唯一的自定义id</span><br>     <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">test_route</span><br>       <span class="hljs-comment"># uri：想要去哪个地方</span><br>       <span class="hljs-attr">uri:</span> <span class="hljs-string">https://www.baidu.com</span><br>       <span class="hljs-comment"># 断言</span><br>       <span class="hljs-attr">predicates:</span><br>           <span class="hljs-comment"># Query ： 代表参数有url=baidu  就会跳转到百度 https://www.baidu.com</span><br>         <span class="hljs-bullet">-</span> <span class="hljs-string">Query=url,baidu</span><br>     <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">qq_route</span><br>       <span class="hljs-attr">uri:</span> <span class="hljs-string">https://www.qq.com</span><br>       <span class="hljs-attr">predicates:</span><br>         <span class="hljs-bullet">-</span> <span class="hljs-string">Query=url,qq</span><br></code></pre></td></tr></table></figure>
</blockquote>
<h3 id="四、ElasticSearch"><a href="#四、ElasticSearch" class="headerlink" title="四、ElasticSearch"></a>四、ElasticSearch</h3><h4 id="1、基本概念"><a href="#1、基本概念" class="headerlink" title="1、基本概念"></a>1、基本概念</h4><h5 id="1、index（索引）"><a href="#1、index（索引）" class="headerlink" title="1、index（索引）"></a>1、index（索引）</h5><blockquote>
<p>动词，相当于MySQL 中的insert ；</p>
<p>名词，相当于MySQL 中的Database ；</p>
</blockquote>
<h5 id="2、type（类型）【-6-0之后就没有类型了-】"><a href="#2、type（类型）【-6-0之后就没有类型了-】" class="headerlink" title="2、type（类型）【 6.0之后就没有类型了 】"></a>2、type（类型）【 6.0之后就没有类型了 】</h5><blockquote>
<p>在index（索引）中，可以定义一个或多个类型。</p>
<p>类似于MySQL 中的Table ；每一种类型的数据放在一起</p>
</blockquote>
<h5 id="3、Document（文档）"><a href="#3、Document（文档）" class="headerlink" title="3、Document（文档）"></a>3、Document（文档）</h5><blockquote>
<p>保存在某个索引（index）下，某种类型（type）的一个数据（document），文档是JSON 格式的，document 就像是MySQL 中的某个Table 里面的内容。</p>
</blockquote>
<h5 id="4、倒排索引机制"><a href="#4、倒排索引机制" class="headerlink" title="4、倒排索引机制"></a>4、倒排索引机制</h5><h6 id="4-1、分词"><a href="#4-1、分词" class="headerlink" title="4.1、分词"></a>4.1、分词</h6><blockquote>
<p>将整句拆分成单词</p>
</blockquote>
<h4 id="2、Docker-安装ElasticSearch"><a href="#2、Docker-安装ElasticSearch" class="headerlink" title="2、Docker 安装ElasticSearch"></a>2、Docker 安装ElasticSearch</h4><h5 id="2-1、下载镜像文件"><a href="#2-1、下载镜像文件" class="headerlink" title="2.1、下载镜像文件"></a>2.1、下载镜像文件</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">存储和检索数据</span><br>docker pull elasticsearch:7.4.2<br><span class="hljs-meta prompt_"># </span><span class="language-bash">可视化检索数据</span><br>docker pull kibana:7.4.2<br></code></pre></td></tr></table></figure>

<h5 id="2-2、创建实例"><a href="#2-2、创建实例" class="headerlink" title="2.2、创建实例"></a>2.2、创建实例</h5><h6 id="2-2-1、安装ElasticSearch"><a href="#2-2-1、安装ElasticSearch" class="headerlink" title="2.2.1、安装ElasticSearch"></a>2.2.1、安装ElasticSearch</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell">mkdir -p /mydata/elasticsearch/config<br>mkdir -p /mydata/elasticsearch/data<br>mkdir -p /mydata/elasticsearch/plugins<br><span class="hljs-meta prompt_"># </span><span class="language-bash">代表每个机器都可以访问到这里的elasticsearch</span><br>echo &quot;http.host: 0.0.0.0&quot;&gt;&gt;/mydata/elasticsearch/config/elasticsearch.yml <br><br>chmod -R 777 /mydata/elasticsearch/<br></code></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">-p 9200:9200   9200是发送restfulAPI的时候给ElasticSearch的9200端口发请求</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">-p 9300:9300   9300是ElasticSearch在分布式集群状态下 节点之间的通信端口</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">-e <span class="hljs-string">&quot;discovery.type=single-node&quot;</span>      代表当前ElasticSearch以单节点模式运行</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">-e ES_JAVA_OPTS=<span class="hljs-string">&quot;-Xms64m -Xmx256m&quot;</span>   设置ElasticSearch的初始内存64M，最大内存占用256M</span><br><br>docker run --name elasticsearch \<br>-p 9200:9200 -p 9300:9300 \<br>-e &quot;discovery.type=single-node&quot; \<br>-e ES_JAVA_OPTS=&quot;-Xms64m -Xmx512m&quot; \<br>-v /mydata/elasticsearch/config/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml \<br>-v /mydata/elasticsearch/data:/usr/share/elasticsearch/data \<br>-v /mydata/elasticsearch/plugins:/usr/share/elasticsearch/plugins \<br>-d elasticsearch:7.4.2<br><br>docker update elasticsearch --restart=always<br></code></pre></td></tr></table></figure>

<h6 id="2-2-2、安装Kibana"><a href="#2-2-2、安装Kibana" class="headerlink" title="2.2.2、安装Kibana"></a>2.2.2、安装Kibana</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">-e ELASTICSEARCH_HOSTS=http://虚拟机的地址:9200   9200是ElasticSearch的端口</span><br><br>docker run --name kibana \<br>-e ELASTICSEARCH_HOSTS=http://192.168.100.135:9200 \<br>-p 5601:5601 \<br>-d kibana:7.4.2<br><br>docker update kibana --restart=always<br></code></pre></td></tr></table></figure>

<h6 id="2-2-3、安装ik-分词器"><a href="#2-2-3、安装ik-分词器" class="headerlink" title="2.2.3、安装ik 分词器"></a>2.2.3、安装ik 分词器</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">下载wget 和 unzip</span><br>yum install -y wget<br>yum install -y unzip<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">进入目录</span><br>mkdir -p /mydata/elasticsearch/plugins/ik<br>chmod -R 777 /mydata/elasticsearch/<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">下载ik分词器安装包</span><br>wget https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v7.4.2/elasticsearch-analysis-ik-7.4.2.zip<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">解压</span><br>unzip elasticsearch-analysis-ik-7.4.2.zip -d /mydata/elasticsearch/plugins/ik<br>mv elasticsearch-analysis-ik-7.4.2.zip /mydata/elasticsearch/plugins/ik/<br></code></pre></td></tr></table></figure>

<ul>
<li><p>可以进入容器后检查是否安装成功</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker exec -it elasticsearch bash<br><br>cd /usr/share/elasticsearch/bin<br>elasticsearch-plugin list<br><br>exit;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">重启ES</span><br>docker restart elasticsearch<br></code></pre></td></tr></table></figure></li>
</ul>
<h4 id="3、初步检索"><a href="#3、初步检索" class="headerlink" title="3、初步检索"></a>3、初步检索</h4><h5 id="1、-cat"><a href="#1、-cat" class="headerlink" title="1、_cat"></a>1、_cat</h5><blockquote>
<p>GET	&#x2F;_cat&#x2F;nodes					查看所有节点</p>
<p>GET	&#x2F;_cat&#x2F;health					查看ES的健康状况</p>
<p>GET	&#x2F;_cat&#x2F;master					查看主节点</p>
<p>GET	&#x2F;_cat&#x2F;indices					查看所有索引（ show databases; ）</p>
</blockquote>
<h5 id="2、索引一个文档（保存）"><a href="#2、索引一个文档（保存）" class="headerlink" title="2、索引一个文档（保存）"></a>2、索引一个文档（保存）</h5><blockquote>
<p>保存一个数据，保存在哪个索引的哪个类型下，指定用哪个唯一标识</p>
<p>在customer 索引下的external 类型下，保存1号数据</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs http">&gt;/索引/类型/id<br>&gt;PUT	/customer/external/1<br>&gt;&#123;<br>&quot;name&quot;: &quot;John Doe&quot;<br>&gt;&#125;<br></code></pre></td></tr></table></figure>

<p><img src="/img/guli_img/ES_PUT%E4%BF%9D%E5%AD%98%E4%B8%80%E6%9D%A1%E6%95%B0%E6%8D%AE.jpg" alt="ES_PUT保存一条数据"></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs json">&gt;<span class="hljs-comment">// PUT新增一条数据响应</span><br>&gt;<span class="hljs-comment">// http://192.168.100.135:9200/customer/external/2			PUT</span><br>&gt;<span class="hljs-punctuation">&#123;</span><br>&gt;<span class="hljs-attr">&quot;_index&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;customer&quot;</span><span class="hljs-punctuation">,</span>  <span class="hljs-comment">// 索引</span><br>&gt;<span class="hljs-attr">&quot;_type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;external&quot;</span><span class="hljs-punctuation">,</span>  <span class="hljs-comment">// 类型</span><br>&gt;<span class="hljs-attr">&quot;_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;2&quot;</span><span class="hljs-punctuation">,</span>  <span class="hljs-comment">// id</span><br>&gt;<span class="hljs-attr">&quot;_version&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>  <span class="hljs-comment">// 版本</span><br>&gt;<span class="hljs-attr">&quot;result&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;created&quot;</span><span class="hljs-punctuation">,</span>  <span class="hljs-comment">// 结果 新增 【如果是多次带同一个id的话，结果是修改】</span><br>&gt;<span class="hljs-attr">&quot;_shards&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span>  <span class="hljs-comment">// 分片信息</span><br>&gt;<span class="hljs-attr">&quot;total&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span><br>&gt;<span class="hljs-attr">&quot;successful&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>&gt;<span class="hljs-attr">&quot;failed&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><br>&gt;<span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>&gt;<span class="hljs-attr">&quot;_seq_no&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span><br>&gt;<span class="hljs-attr">&quot;_primary_term&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><br>&gt;<span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>



<p>PUT 和POST 都可以新增数据</p>
<p>POST 新增：如果不指定id，会自动生成id。指定id 就会修改这个数据，并新增版本号</p>
<p><img src="/img/guli_img/ES_POST%E4%BF%9D%E5%AD%98%E4%B8%80%E6%9D%A1%E6%95%B0%E6%8D%AE.jpg" alt="ES_POST保存一条数据"></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs json">&gt;<span class="hljs-comment">// POST新增一条数据响应</span><br>&gt;<span class="hljs-comment">// http://192.168.100.135:9200/customer/external/		POST</span><br>&gt;<span class="hljs-punctuation">&#123;</span><br>&gt;<span class="hljs-attr">&quot;_index&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;customer&quot;</span><span class="hljs-punctuation">,</span><br>&gt;<span class="hljs-attr">&quot;_type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;external&quot;</span><span class="hljs-punctuation">,</span><br>&gt;<span class="hljs-attr">&quot;_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;O4dJdowBneFFuLYJx-GG&quot;</span><span class="hljs-punctuation">,</span>  <span class="hljs-comment">// 如果不带id 会自动生成一个id</span><br>&gt;<span class="hljs-attr">&quot;_version&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>&gt;<span class="hljs-attr">&quot;result&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;created&quot;</span><span class="hljs-punctuation">,</span><br>&gt;<span class="hljs-attr">&quot;_shards&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>&gt;<span class="hljs-attr">&quot;total&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span><br>&gt;<span class="hljs-attr">&quot;successful&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>&gt;<span class="hljs-attr">&quot;failed&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><br>&gt;<span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>&gt;<span class="hljs-attr">&quot;_seq_no&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span><br>&gt;<span class="hljs-attr">&quot;_primary_term&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><br>&gt;<span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>



<p>PUT 修改：可以新增可以修改。<strong>PUT 必须指定id。</strong>由于PUT 需要指定id，一般都用来修改操作，不指定id 会报错</p>
<p><img src="/img/guli_img/ES_PUT%E4%B8%8D%E5%B8%A6id%E4%BC%9A%E6%8A%A5%E9%94%99.jpg" alt="ES_PUT不带id会报错"></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs json">&gt;<span class="hljs-comment">// 响应：PUT 不带id会报错</span><br>&gt;<span class="hljs-comment">// http://192.168.100.135:9200/customer/external/		PUT</span><br>&gt;<span class="hljs-punctuation">&#123;</span><br>&gt;<span class="hljs-attr">&quot;error&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Incorrect HTTP method for uri [/customer/external/] and method [PUT], allowed: [POST]&quot;</span><span class="hljs-punctuation">,</span><br>&gt;<span class="hljs-attr">&quot;status&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">405</span><br>&gt;<span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>
</blockquote>
<h5 id="3、查询文档"><a href="#3、查询文档" class="headerlink" title="3、查询文档"></a>3、查询文档</h5><blockquote>
<p>查询哪个索引下的哪个类型下的哪一条数据</p>
<p>查询customer 索引下的external 类型下的id 为1的数据</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs http">&gt;/索引/类型/id<br>&gt;GET	/customer/external/1<br></code></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs json">&gt;<span class="hljs-comment">// 响应：</span><br>&gt;<span class="hljs-punctuation">&#123;</span><br>&gt;<span class="hljs-attr">&quot;_index&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;customer&quot;</span><span class="hljs-punctuation">,</span>  <span class="hljs-comment">// 索引</span><br>&gt;<span class="hljs-attr">&quot;_type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;external&quot;</span><span class="hljs-punctuation">,</span>  <span class="hljs-comment">// 类型</span><br>&gt;<span class="hljs-attr">&quot;_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1&quot;</span><span class="hljs-punctuation">,</span>  <span class="hljs-comment">// id</span><br>&gt;<span class="hljs-attr">&quot;_version&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span>  <span class="hljs-comment">// 版本</span><br>&gt;<span class="hljs-attr">&quot;_seq_no&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>  <span class="hljs-comment">// 并发控制字段，每次更新就会+1 【用来作乐观锁】</span><br>&gt;<span class="hljs-attr">&quot;_primary_term&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>  <span class="hljs-comment">// 同上，主分片重新分配，如重启，就会变化 【用来作乐观锁用的】</span><br>&gt;<span class="hljs-attr">&quot;found&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>  <span class="hljs-comment">// 是否找到数据</span><br>&gt;<span class="hljs-attr">&quot;_source&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span>  <span class="hljs-comment">// 查询的内容</span><br>&gt;<span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;John Doe&quot;</span><br>&gt;<span class="hljs-punctuation">&#125;</span><br>&gt;<span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<p>更新操作时可以用到 _seq_no 和 _primary_term 这两个字段</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs http">&gt;PUT	http://192.168.100.135:9200/customer/external/1?if_seq_no=1&amp;if_primary_term=1<br>&gt;/索引/类型/id?if_seq_no=【 _seq_no的值 】&amp;if_parmary_term=【 _primary_term的值 】<br>&gt;&#123;<br>&gt;&quot;name&quot;: &quot;第一个人修改&quot;<br>&gt;&#125;<br><br>&gt;# 可以在这里指定它俩的值，如果满足要求才会更改，如果不满足要求，会报错409<br></code></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs json">&gt;<span class="hljs-comment">// 不满足要求时的报错信息</span><br>&gt;<span class="hljs-punctuation">&#123;</span><br>&gt;<span class="hljs-attr">&quot;error&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>&gt;<span class="hljs-attr">&quot;root_cause&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br> <span class="hljs-punctuation">&#123;</span><br>     <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;version_conflict_engine_exception&quot;</span><span class="hljs-punctuation">,</span><br>     <span class="hljs-attr">&quot;reason&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;[1]: version conflict, required seqNo [1], primary term [1]. current document has seqNo [4] and primary term [1]&quot;</span><span class="hljs-punctuation">,</span><br>     <span class="hljs-attr">&quot;index_uuid&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;_wgpWk5ZSD2y_XO05lGYbw&quot;</span><span class="hljs-punctuation">,</span><br>     <span class="hljs-attr">&quot;shard&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;0&quot;</span><span class="hljs-punctuation">,</span><br>     <span class="hljs-attr">&quot;index&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;customer&quot;</span><br> <span class="hljs-punctuation">&#125;</span><br>&gt;<span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>&gt;<span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;version_conflict_engine_exception&quot;</span><span class="hljs-punctuation">,</span><br>&gt;<span class="hljs-attr">&quot;reason&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;[1]: version conflict, required seqNo [1], primary term [1]. current document has seqNo [4] and primary term [1]&quot;</span><span class="hljs-punctuation">,</span><br>&gt;<span class="hljs-attr">&quot;index_uuid&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;_wgpWk5ZSD2y_XO05lGYbw&quot;</span><span class="hljs-punctuation">,</span><br>&gt;<span class="hljs-attr">&quot;shard&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;0&quot;</span><span class="hljs-punctuation">,</span><br>&gt;<span class="hljs-attr">&quot;index&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;customer&quot;</span><br>&gt;<span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>&gt;<span class="hljs-attr">&quot;status&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">409</span><br>&gt;<span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>
</blockquote>
<h5 id="4、更新文档"><a href="#4、更新文档" class="headerlink" title="4、更新文档"></a>4、更新文档</h5><blockquote>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs http">&gt;# 会对比原来的数据，如果与原来一样就什么都不做   result会返回 noop；version、seq_no 都不会增加<br>&gt;/索引/类型/id/_update<br>&gt;POST	/costomer/external/1/_update<br>&gt;&#123;<br>&quot;doc&quot;: &#123;<br>	&quot;name&quot;: &quot;John Doew&quot;<br>&#125;<br>&gt;&#125;<br></code></pre></td></tr></table></figure>

<p>或者</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs http">&gt;# 不对比原来的数据<br>&gt;/索引/类型/id<br>&gt;POST	/customer/external/1<br>&gt;&#123;<br>&quot;name&quot;: &quot;John Doe2&quot;<br>&gt;&#125;<br></code></pre></td></tr></table></figure>

<p>或者</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs http">&gt;# 不对比原来的数据  【 与POST 不带 _update 一样 】<br>&gt;/索引/类型/id<br>&gt;PUT	/customer/external/1<br>&gt;&#123;<br>&quot;name&quot;: &quot;John Doe&quot;<br>&gt;&#125;<br></code></pre></td></tr></table></figure>

<p>不同：</p>
<ul>
<li>POST 操作会对比源文档数据，如果相同不会有什么操作，文档version 不增加</li>
<li>PUT 操作总会将数据重新保存并增加version 版本</li>
<li>看场景：</li>
<li>对于大并发更新，不带update</li>
<li>对于大并发查询偶尔更新，带update；对比更新，重新计算分配规则。</li>
</ul>
<p><strong>以上三种方式都可以在更新时增加属性</strong></p>
</blockquote>
<h5 id="5、删除文档-索引"><a href="#5、删除文档-索引" class="headerlink" title="5、删除文档&amp;索引"></a>5、删除文档&amp;索引</h5><blockquote>
<p>删除文档：	&#x2F;索引&#x2F;类型&#x2F;id</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">&gt;DELETE	/customer/external/1<br></code></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs json">&gt;<span class="hljs-comment">// 响应</span><br>&gt;<span class="hljs-punctuation">&#123;</span><br>&gt;<span class="hljs-attr">&quot;_index&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;customer&quot;</span><span class="hljs-punctuation">,</span><br>&gt;<span class="hljs-attr">&quot;_type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;external&quot;</span><span class="hljs-punctuation">,</span><br>&gt;<span class="hljs-attr">&quot;_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1&quot;</span><span class="hljs-punctuation">,</span><br>&gt;<span class="hljs-attr">&quot;_version&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">16</span><span class="hljs-punctuation">,</span><br>&gt;<span class="hljs-attr">&quot;result&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;deleted&quot;</span><span class="hljs-punctuation">,</span><br>&gt;<span class="hljs-attr">&quot;_shards&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>&gt;<span class="hljs-attr">&quot;total&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span><br>&gt;<span class="hljs-attr">&quot;successful&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>&gt;<span class="hljs-attr">&quot;failed&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><br>&gt;<span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>&gt;<span class="hljs-attr">&quot;_seq_no&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">17</span><span class="hljs-punctuation">,</span><br>&gt;<span class="hljs-attr">&quot;_primary_term&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><br>&gt;<span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<p>删除索引：		&#x2F;索引</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">&gt;DELETE	/customer<br></code></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs json">&gt;<span class="hljs-comment">// 响应</span><br>&gt;<span class="hljs-punctuation">&#123;</span><br>&gt;<span class="hljs-attr">&quot;acknowledged&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><br>&gt;<span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>


</blockquote>
<h5 id="6、bulk-批量API"><a href="#6、bulk-批量API" class="headerlink" title="6、bulk 批量API"></a>6、bulk 批量API</h5><blockquote>
<p>bulk API 以此顺序执行所有的action（动作）。如果一个单个的动作因任何原因而失败，它将继续处理它后面剩余的动作。</p>
<p>当bulk API 返回时，它将提供每个动作的状态（与发送的顺序相同），所以可以检查是否一个指定的动作是不是失败了。</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs http">&gt;POST	/customer/external/_bulk		【 没办法用Postman 测试，只能用Kibana 】<br><br>&gt;&#123;&quot;index&quot;: &#123;&quot;_id&quot;: &quot;1&quot;&#125;&#125;<br>&gt;&#123;&quot;name&quot;: &quot;John Doe&quot;&#125;<br>&gt;&#123;&quot;index&quot;: &#123;&quot;_id&quot;: &quot;2&quot;&#125;&#125;<br>&gt;&#123;&quot;name&quot;: &quot;John Rambo&quot;&#125;<br></code></pre></td></tr></table></figure>

<p><strong>语法格式：</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs json">&gt;<span class="hljs-punctuation">&#123;</span>action<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span>metadata<span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">&#125;</span>\n<br>&gt;<span class="hljs-punctuation">&#123;</span>request body	<span class="hljs-punctuation">&#125;</span>\n<br>&gt;<span class="hljs-punctuation">&#123;</span>action<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span>metadata<span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">&#125;</span>\n<br>&gt;<span class="hljs-punctuation">&#123;</span>request body	<span class="hljs-punctuation">&#125;</span>\n<br></code></pre></td></tr></table></figure>

<p><strong>复杂实例：</strong></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs http">&gt;POST /_bulk<br><br>&gt;&#123;&quot;delete&quot;: &#123;&quot;_index&quot;: &quot;website&quot; , &quot;_type&quot;: &quot;blog&quot; , &quot;_id&quot;: &quot;123&quot;&#125;&#125;<br>&gt;&#123;&quot;create&quot;: &#123;&quot;_index&quot;: &quot;website&quot; , &quot;_type&quot;: &quot;blog&quot; , &quot;_id&quot;: &quot;123&quot;&#125;&#125;<br>&gt;&#123;&quot;title&quot;: &quot;My first blog post&quot;&#125;<br>&gt;&#123;&quot;index&quot;: &#123;&quot;_index&quot;: &quot;website&quot; , &quot;_type&quot;: &quot;blog&quot;&#125;&#125;<br>&gt;&#123;&quot;title&quot;: &quot;My Second blog post&quot;&#125;<br>&gt;&#123;&quot;update&quot;: &#123;&quot;_index&quot;: &quot;website&quot; , &quot;_type&quot;: &quot;blog&quot; , &quot;_id&quot;: &quot;123&quot;&#125;&#125;<br>&gt;&#123;&quot;doc&quot;: &#123;&quot;title&quot;: &quot;My Update blog post&quot;&#125;&#125;<br></code></pre></td></tr></table></figure>

<p><strong>测试步骤：</strong></p>
<p><img src="/img/guli_img/ES_%E4%BD%BF%E7%94%A8Kibana%E6%AD%A5%E9%AA%A41.jpg" alt="ES_使用Kibana步骤1"></p>
<p><img src="/img/guli_img/ES_%E4%BD%BF%E7%94%A8Kibana%E6%AD%A5%E9%AA%A42.jpg" alt="ES_使用Kibana步骤2"></p>
<p><img src="/img/guli_img/ES_%E4%BD%BF%E7%94%A8Kibana%E6%AD%A5%E9%AA%A43.jpg" alt="ES_使用Kibana步骤3"></p>
<p><img src="/img/guli_img/ES_bulk%E6%B5%8B%E8%AF%95.jpg" alt="ES_bulk测试"></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs json">&gt;<span class="hljs-comment">// 这是响应</span><br>&gt;#! Deprecation<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>types removal<span class="hljs-punctuation">]</span> Specifying types in bulk requests is deprecated.<br>&gt;<span class="hljs-punctuation">&#123;</span><br>&gt;<span class="hljs-attr">&quot;took&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">26</span><span class="hljs-punctuation">,</span>  <span class="hljs-comment">// 花费了26毫秒</span><br>&gt;<span class="hljs-attr">&quot;errors&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span>  <span class="hljs-comment">// 没有发生错误</span><br>&gt;<span class="hljs-attr">&quot;items&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>  <span class="hljs-comment">// 结果</span><br>&gt;<span class="hljs-punctuation">&#123;</span><br>&gt;<span class="hljs-attr">&quot;index&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>&gt;<span class="hljs-attr">&quot;_index&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;customer&quot;</span><span class="hljs-punctuation">,</span><br>&gt;<span class="hljs-attr">&quot;_type&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;external&quot;</span><span class="hljs-punctuation">,</span><br>&gt;<span class="hljs-attr">&quot;_id&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1&quot;</span><span class="hljs-punctuation">,</span><br>&gt;<span class="hljs-attr">&quot;_version&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>&gt;<span class="hljs-attr">&quot;result&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;created&quot;</span><span class="hljs-punctuation">,</span><br>&gt;<span class="hljs-attr">&quot;_shards&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>&gt;<span class="hljs-attr">&quot;total&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span><br>&gt;<span class="hljs-attr">&quot;successful&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>&gt;<span class="hljs-attr">&quot;failed&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><br>&gt;<span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>&gt;<span class="hljs-attr">&quot;_seq_no&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>&gt;<span class="hljs-attr">&quot;_primary_term&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>&gt;<span class="hljs-attr">&quot;status&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">201</span>  <br>&gt;<span class="hljs-punctuation">&#125;</span><br>&gt;<span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>&gt;<span class="hljs-punctuation">&#123;</span><br>&gt;<span class="hljs-attr">&quot;index&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>&gt;<span class="hljs-attr">&quot;_index&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;customer&quot;</span><span class="hljs-punctuation">,</span><br>&gt;<span class="hljs-attr">&quot;_type&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;external&quot;</span><span class="hljs-punctuation">,</span><br>&gt;<span class="hljs-attr">&quot;_id&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;2&quot;</span><span class="hljs-punctuation">,</span><br>&gt;<span class="hljs-attr">&quot;_version&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>&gt;<span class="hljs-attr">&quot;result&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;created&quot;</span><span class="hljs-punctuation">,</span><br>&gt;<span class="hljs-attr">&quot;_shards&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>&gt;<span class="hljs-attr">&quot;total&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span><br>&gt;<span class="hljs-attr">&quot;successful&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>&gt;<span class="hljs-attr">&quot;failed&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><br>&gt;<span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>&gt;<span class="hljs-attr">&quot;_seq_no&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>&gt;<span class="hljs-attr">&quot;_primary_term&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>&gt;<span class="hljs-attr">&quot;status&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">201</span><br>&gt;<span class="hljs-punctuation">&#125;</span><br>&gt;<span class="hljs-punctuation">&#125;</span><br>&gt;<span class="hljs-punctuation">]</span><br>&gt;<span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>
</blockquote>
<h4 id="4、进阶检索"><a href="#4、进阶检索" class="headerlink" title="4、进阶检索"></a>4、进阶检索</h4><h5 id="1、SearchAPI"><a href="#1、SearchAPI" class="headerlink" title="1、SearchAPI"></a>1、SearchAPI</h5><blockquote>
<p>ES 支持两种基本方式检索：</p>
<p>1、一个是通过使用<code>REST request URI </code>发送搜索参数（ uri+检索参数 ）</p>
<p>检索信息</p>
<ul>
<li>一切检索从<code>_search</code>开始</li>
</ul>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs http">&gt;GET	/索引/_search		// 检索索引下的所有信息，包括type 和docs<br>&gt;GET	/索引/_search?q=*&amp;sort=account_number:asc			// 请求参数方式检索<br><br>&gt;q=*		查询所有<br>&gt;sort=account_number:asc		排序方式是按照account_number 升序<br></code></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs json">&gt;<span class="hljs-comment">// 响应</span><br>&gt;<span class="hljs-punctuation">&#123;</span><br>&gt;<span class="hljs-attr">&quot;took&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">40</span><span class="hljs-punctuation">,</span>  <span class="hljs-comment">// 花费了40毫秒</span><br>&gt;<span class="hljs-attr">&quot;timed_out&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span>  <span class="hljs-comment">// 没有超时</span><br>&gt;<span class="hljs-attr">&quot;_shards&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span>  <span class="hljs-comment">// 集群环境下每一个分片都为这个检索作了什么操作</span><br> <span class="hljs-attr">&quot;total&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br> <span class="hljs-attr">&quot;successful&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br> <span class="hljs-attr">&quot;skipped&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br> <span class="hljs-attr">&quot;failed&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><br>&gt;<span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>&gt;<span class="hljs-attr">&quot;hits&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span>  <span class="hljs-comment">// 命中的记录</span><br> <span class="hljs-attr">&quot;total&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span>  <span class="hljs-comment">// 总记录数</span><br>   <span class="hljs-attr">&quot;value&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">1000</span><span class="hljs-punctuation">,</span>  <span class="hljs-comment">// 检索出了1000条记录</span><br>   <span class="hljs-attr">&quot;relation&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;eq&quot;</span>  <br> <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br> <span class="hljs-attr">&quot;max_score&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span>  <span class="hljs-comment">// 最大得分</span><br> <span class="hljs-attr">&quot;hits&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>  <span class="hljs-comment">// 命中的记录</span><br>   <span class="hljs-punctuation">&#123;</span><br>     <span class="hljs-attr">&quot;_index&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;bank&quot;</span><span class="hljs-punctuation">,</span>  <span class="hljs-comment">// 索引</span><br>     <span class="hljs-attr">&quot;_type&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;account&quot;</span><span class="hljs-punctuation">,</span>  <span class="hljs-comment">// 类型</span><br>     <span class="hljs-attr">&quot;_id&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;0&quot;</span><span class="hljs-punctuation">,</span>  <span class="hljs-comment">// id</span><br>     <span class="hljs-attr">&quot;_score&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span>  <span class="hljs-comment">// 得分</span><br>     <span class="hljs-attr">&quot;_source&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span>  <span class="hljs-comment">// 保存的数据</span><br>       <span class="hljs-attr">&quot;account_number&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>       <span class="hljs-attr">&quot;balance&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">16623</span><span class="hljs-punctuation">,</span><br>       <span class="hljs-attr">&quot;firstname&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Bradshaw&quot;</span><span class="hljs-punctuation">,</span><br>       <span class="hljs-attr">&quot;lastname&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Mckenzie&quot;</span><span class="hljs-punctuation">,</span><br>       <span class="hljs-attr">&quot;age&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">29</span><span class="hljs-punctuation">,</span><br>       <span class="hljs-attr">&quot;gender&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;F&quot;</span><span class="hljs-punctuation">,</span><br>       <span class="hljs-attr">&quot;address&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;244 Columbus Place&quot;</span><span class="hljs-punctuation">,</span><br>       <span class="hljs-attr">&quot;employer&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Euron&quot;</span><span class="hljs-punctuation">,</span><br>       <span class="hljs-attr">&quot;email&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;bradshawmckenzie@euron.com&quot;</span><span class="hljs-punctuation">,</span><br>       <span class="hljs-attr">&quot;city&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Hobucken&quot;</span><span class="hljs-punctuation">,</span><br>       <span class="hljs-attr">&quot;state&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;CO&quot;</span><br>     <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>     <span class="hljs-attr">&quot;sort&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>  <span class="hljs-comment">// 排序</span><br>       <span class="hljs-number">0</span><br>     <span class="hljs-punctuation">]</span><br>   <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>   <span class="hljs-punctuation">&#123;</span><br>     <span class="hljs-attr">&quot;_index&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;bank&quot;</span><span class="hljs-punctuation">,</span><br>     <span class="hljs-attr">&quot;_type&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;account&quot;</span><span class="hljs-punctuation">,</span><br>     <span class="hljs-attr">&quot;_id&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1&quot;</span><span class="hljs-punctuation">,</span><br>     <span class="hljs-attr">&quot;_score&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>     <span class="hljs-attr">&quot;_source&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>       <span class="hljs-attr">&quot;account_number&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>       <span class="hljs-attr">&quot;balance&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">39225</span><span class="hljs-punctuation">,</span><br>       <span class="hljs-attr">&quot;firstname&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Amber&quot;</span><span class="hljs-punctuation">,</span><br>       <span class="hljs-attr">&quot;lastname&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Duke&quot;</span><span class="hljs-punctuation">,</span><br>       <span class="hljs-attr">&quot;age&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">32</span><span class="hljs-punctuation">,</span><br>       <span class="hljs-attr">&quot;gender&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;M&quot;</span><span class="hljs-punctuation">,</span><br>       <span class="hljs-attr">&quot;address&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;880 Holmes Lane&quot;</span><span class="hljs-punctuation">,</span><br>       <span class="hljs-attr">&quot;employer&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Pyrami&quot;</span><span class="hljs-punctuation">,</span><br>       <span class="hljs-attr">&quot;email&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;amberduke@pyrami.com&quot;</span><span class="hljs-punctuation">,</span><br>       <span class="hljs-attr">&quot;city&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Brogan&quot;</span><span class="hljs-punctuation">,</span><br>       <span class="hljs-attr">&quot;state&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;IL&quot;</span><br>     <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>     <span class="hljs-attr">&quot;sort&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>       <span class="hljs-number">1</span><br>     <span class="hljs-punctuation">]</span><br>   <span class="hljs-punctuation">&#125;</span><br> <span class="hljs-punctuation">]</span><br>&gt;<span class="hljs-punctuation">&#125;</span><br>&gt;<span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>



<p>2、另一个是通过使用<code>REST request body</code> 来发送它们（ uri+请求体 ）</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs http">&gt;GET /bank/_search<br>&gt;&#123;<br> &quot;query&quot;: &#123;<br>     &quot;match_all&quot;: &#123;&#125;<br> &#125;,<br> &quot;sort&quot;: [<br>     &#123;<br>         &quot;account_number&quot;: &quot;asc&quot;<br>     &#125;<br> ]<br>&gt;&#125;<br></code></pre></td></tr></table></figure>
</blockquote>
<h5 id="2、Query-DSL"><a href="#2、Query-DSL" class="headerlink" title="2、Query DSL"></a>2、Query DSL</h5><h6 id="1）、基本语法格式"><a href="#1）、基本语法格式" class="headerlink" title="1）、基本语法格式"></a>1）、基本语法格式</h6><p>ElasticSearch提供了一个可以执行查询的Json风格的DSL（domain-specific-language 领域特定语言）。这个被称为Query DSL。该查询语言非常全面，并且刚开始的时候感觉有点复杂，真正学好它的方法是从一些基础的示例开始的。</p>
<ul>
<li><p>一个查询语句的典型结构</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs http">&#123;<br>	query_name: &#123;<br>		argument: value,<br>		argument: value,...<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li><p>如果是针对某个字段，那么它的结构是：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs http">&#123;<br>	query_name: &#123;<br>		field_name: &#123;<br>         	 argument: value,<br>			argument: value,...<br>		&#125;<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h6 id="2）、返回部分字段"><a href="#2）、返回部分字段" class="headerlink" title="2）、返回部分字段"></a>2）、返回部分字段</h6><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs http">GET /bank/_search<br>&#123;<br>    &quot;query&quot;: &#123;<br>        &quot;match_all&quot;: &#123;&#125;  // match_all 查询所有<br>    &#125;,<br>    &quot;sort&quot;: [<br>      &#123;<br>        &quot;balance&quot;: &#123;<br>          &quot;order&quot;: &quot;desc&quot;<br>        &#125;<br>      &#125;<br>    ],<br>    &quot;from&quot;: 0,<br>    &quot;size&quot;: 5,<br>    &quot;_source&quot;: [&quot;balance&quot;,&quot;firstname&quot;]  // 只返回balance 和firstname 两个字段<br>&#125;<br></code></pre></td></tr></table></figure>

<h6 id="3）、match-全文检索"><a href="#3）、match-全文检索" class="headerlink" title="3）、	match 全文检索"></a>3）、	match 全文检索</h6><p><strong>全文检索最终会按照评分进行排序，会对检索条件进行分词匹配</strong></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs http">GET /bank/_search<br>&#123;<br>  &quot;query&quot;:&#123;<br>    &quot;match&quot;: &#123;<br>      &quot;address&quot;: &quot;mill road&quot;   // 查询address 中包含mill 或road 或mill road 的所有记录，并给出相关性得分<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h6 id="4）、match-phrase-短语匹配"><a href="#4）、match-phrase-短语匹配" class="headerlink" title="4）、match_phrase 短语匹配"></a>4）、match_phrase 短语匹配</h6><p><strong>将需要匹配的值当成一个整体单词（不分词）进行检索</strong></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs http">GET /bank/_search<br>&#123;<br>  &quot;query&quot;: &#123;<br>    &quot;match_phrase&quot;: &#123;<br>      &quot;address&quot;: &quot;mill lane&quot;  // 不分词<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h6 id="5）、multi-match-多字段匹配"><a href="#5）、multi-match-多字段匹配" class="headerlink" title="5）、multi_match 多字段匹配"></a>5）、multi_match 多字段匹配</h6><p><strong>在多个字段中去匹配某个值</strong></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs http">GET /bank/_search<br>&#123;<br>  &quot;query&quot;: &#123;<br>    &quot;multi_match&quot;: &#123;<br>      &quot;query&quot;: &quot;mill&quot;,<br>      &quot;fields&quot;: [&quot;state&quot;,&quot;address&quot;]   // 查询 state字段或 address字段 中包含 mill 的数据<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h6 id="6）、bool-复合查询"><a href="#6）、bool-复合查询" class="headerlink" title="6）、bool 复合查询"></a>6）、bool 复合查询</h6><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs http">GET /bank/_search<br>&#123;<br>  &quot;query&quot;: &#123;<br>    &quot;bool&quot;: &#123;  // 复合查询<br>      &quot;must&quot;: [  // 必须满足的<br>        &#123;<br>          &quot;match&quot;: &#123;<br>            &quot;gender&quot;: &quot;M&quot;<br>          &#125;<br>        &#125;,<br>        &#123;<br>          &quot;match&quot;: &#123;<br>            &quot;address&quot;: &quot;mill&quot;<br>          &#125;<br>        &#125;<br>      ],<br>      &quot;must_not&quot;: [  // 必须不满足的<br>        &#123;<br>          &quot;match&quot;: &#123;<br>            &quot;age&quot;: 28<br>          &#125;<br>        &#125;<br>      ],<br>      &quot;should&quot;: [  // 最好满足，满足的话得分会高；不满足也没事<br>        &#123;<br>          &quot;match&quot;: &#123;<br>            &quot;lastname&quot;: &quot;Wallace&quot;<br>          &#125;<br>        &#125;<br>      ]<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h6 id="7）、filter-结果过滤"><a href="#7）、filter-结果过滤" class="headerlink" title="7）、filter 结果过滤"></a>7）、filter 结果过滤</h6><p><strong>filter 不会计算得分</strong></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs http">GET /bank/_search<br>&#123;<br>  &quot;query&quot;: &#123;<br>    &quot;bool&quot;: &#123;<br>      &quot;filter&quot;: &#123;<br>        &quot;range&quot;: &#123;<br>          &quot;age&quot;: &#123;<br>            &quot;gte&quot;: 18,<br>            &quot;lte&quot;: 30<br>          &#125;<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h6 id="8）、term-精确匹配"><a href="#8）、term-精确匹配" class="headerlink" title="8）、term 精确匹配"></a>8）、term 精确匹配</h6><p><strong>和match 一样，匹配某个属性的值。全文检索字段用match ，其他非text 字段匹配用term 。</strong></p>
<ul>
<li><p>如果匹配文本字段的精确值，可以使用<code>match_phrase</code>   【 可以匹配字段的一部分 】</p>
</li>
<li><p>也可以使用<code>match</code> ，然后检索的时候指定 <code>文本字段.keyword </code>   【 整个字段的内容都要完全匹配上 】 【 不常用 】 </p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs http">GET /bank/_search<br>&#123;<br>  &quot;query&quot;: &#123;<br>    &quot;match&quot;: &#123;<br>      &quot;address.keyword&quot;: &quot;789 Madison Street&quot;  // 只查询789 Madison Street ， 不分词<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li>
</ul>
<h6 id="9）、aggregations（执行聚合）"><a href="#9）、aggregations（执行聚合）" class="headerlink" title="9）、aggregations（执行聚合）"></a>9）、aggregations（执行聚合）</h6><p>聚合提供了从数据中分组和提取数据的能力。最简单的聚合方法大致等于 SQL group by 和 SQL 聚合函数。在ElasticSearch 中，有执行搜索返回 hits（命中结果），并且同时返回聚合结果，把一个响应中的所有 hits（命中结果）分隔开的能力。可以执行查询和多个聚合，并且在一次使用中得到各自的（任何一个的）返回结果，使用一次简洁和简化的API来避免网络往返。</p>
<ul>
<li><p>搜索address 中包含mill 的所有人的年龄分布以及平均年龄，但不显示这些人的详情：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs http">GET /bank/_search<br>&#123;<br>  &quot;query&quot;: &#123;<br>    &quot;match&quot;: &#123;<br>      &quot;address&quot;: &quot;mill&quot;<br>    &#125;<br>  &#125;,<br>  &quot;aggs&quot;: &#123;<br>    &quot;ageAgg&quot;: &#123;  // 聚合的名字（自定义）<br>      &quot;terms&quot;: &#123;  // 分布情况<br>        &quot;field&quot;: &quot;age&quot;,  // 查看年龄的分布情况<br>        &quot;size&quot;: 10  <br>      &#125;<br>    &#125;,<br>    &quot;ageAvg&quot;: &#123;  // 聚合的名字<br>      &quot;avg&quot;: &#123;  // 求平均值<br>        &quot;field&quot;: &quot;age&quot;  // 对年龄求平均值<br>      &#125;<br>    &#125;<br>  &#125;,<br>  &quot;size&quot;: 0  // 不显示这些人的记录<br>&#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p>按照年龄聚合，并且请求这些年龄段的这些人的平均薪资</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs http">GET /bank/_search<br>&#123;<br>  &quot;query&quot;: &#123;<br>    &quot;match_all&quot;: &#123;&#125;<br>  &#125;,<br>  &quot;aggs&quot;: &#123;<br>    &quot;ageAgg&quot;: &#123;<br>      &quot;terms&quot;: &#123;<br>        &quot;field&quot;: &quot;age&quot;,<br>        &quot;size&quot;: 100<br>      &#125;,<br>      &quot;aggs&quot;: &#123;  // 在上一次聚合的基础上，再进行聚合<br>        &quot;ageAvg&quot;: &#123;  // 聚合的名字<br>          &quot;avg&quot;: &#123;  // 求平均值<br>            &quot;field&quot;: &quot;balance&quot;  // 对薪资求平均值<br>          &#125;<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p>查询所有年龄分布，并且这些年龄段中M的平均薪资和F的平均薪资以及这个年龄段的总体平均薪资</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs http">GET /bank/_search<br>&#123;<br>  &quot;query&quot;: &#123;<br>    &quot;match_all&quot;: &#123;&#125;<br>  &#125;,<br>  &quot;aggs&quot;: &#123;<br>    &quot;ageAgg&quot;: &#123;<br>      &quot;terms&quot;: &#123;<br>        &quot;field&quot;: &quot;age&quot;,<br>        &quot;size&quot;: 100<br>      &#125;,<br>      &quot;aggs&quot;: &#123;<br>        &quot;genderAgg&quot;: &#123;<br>          &quot;terms&quot;: &#123;<br>            &quot;field&quot;: &quot;gender.keyword&quot;<br>          &#125;,<br>          &quot;aggs&quot;: &#123;<br>            &quot;balanceAvg&quot;: &#123;<br>              &quot;avg&quot;: &#123;<br>                &quot;field&quot;: &quot;balance&quot;<br>              &#125;<br>            &#125;<br>          &#125;<br>        &#125;,<br>        &quot;ageBalanceAvg&quot;:&#123;<br>          &quot;avg&quot;: &#123;<br>            &quot;field&quot;: &quot;balance&quot;<br>          &#125;<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;,<br>  &quot;size&quot;: 0<br>&#125;<br></code></pre></td></tr></table></figure></li>
</ul>
<h5 id="3、Mapping-映射"><a href="#3、Mapping-映射" class="headerlink" title="3、Mapping 映射"></a>3、Mapping 映射</h5><p>Mapping 是用来定义一个文档（Document），以及它所包含的属性（field）是如何存储和索引的。比如，使用Mapping来定义：</p>
<ul>
<li><p>哪些字符串属性应该被看做全文本属性（full text fields）；</p>
</li>
<li><p>哪些属性包含数字、日期或者地理位置；</p>
</li>
<li><p>文档中的所有属性是否都能被索引（_all 配置）；</p>
</li>
<li><p>日期的格式；</p>
</li>
<li><p>自定义映射规则来执行动态添加属性；</p>
</li>
<li><p>查看Mapping信息；</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">GET	/索引/_mapping<br></code></pre></td></tr></table></figure>
</li>
<li><p>修改Mapping信息；</p>
</li>
</ul>
<h6 id="3-1）、创建一个全新的索引时，可以指定字段的映射："><a href="#3-1）、创建一个全新的索引时，可以指定字段的映射：" class="headerlink" title="3.1）、创建一个全新的索引时，可以指定字段的映射："></a>3.1）、创建一个全新的索引时，可以指定字段的映射：</h6><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs http">PUT /my_indx<br>&#123;<br>  &quot;mappings&quot;: &#123;<br>    &quot;properties&quot;: &#123;<br>      &quot;age&quot;: &#123;<br>        &quot;type&quot;: &quot;integer&quot;<br>      &#125;,<br>      &quot;email&quot;: &#123;<br>        &quot;type&quot;: &quot;keyword&quot;<br>      &#125;,<br>      &quot;name&quot;: &#123;<br>        &quot;type&quot;: &quot;text&quot;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h6 id="3-2）、对于已经存在的索引，可以添加新的字段映射："><a href="#3-2）、对于已经存在的索引，可以添加新的字段映射：" class="headerlink" title="3.2）、对于已经存在的索引，可以添加新的字段映射："></a>3.2）、对于已经存在的索引，可以添加新的字段映射：</h6><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs http">PUT /my_indx/_mapping<br>&#123;<br>  &quot;properties&quot;: &#123;<br>    &quot;employee_id&quot;: &#123;<br>      &quot;type&quot;: &quot;keyword&quot;,<br>      &quot;index&quot;: false  // 不需要被索引，默认是true  【 如果不被索引，那么elployee_id 这个字段就不会被检索到 】<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h6 id="3-3）、对于已经存在的映射，不可以修改"><a href="#3-3）、对于已经存在的映射，不可以修改" class="headerlink" title="3.3）、对于已经存在的映射，不可以修改"></a>3.3）、对于已经存在的映射，不可以修改</h6><h6 id="3-4）、如果想要修改已经存在的映射，可以用新的映射规则-创建一个新的索引，重新保存一下数据到新的索引中"><a href="#3-4）、如果想要修改已经存在的映射，可以用新的映射规则-创建一个新的索引，重新保存一下数据到新的索引中" class="headerlink" title="3.4）、如果想要修改已经存在的映射，可以用新的映射规则 创建一个新的索引，重新保存一下数据到新的索引中"></a>3.4）、如果想要修改已经存在的映射，可以用新的映射规则 创建一个新的索引，重新保存一下数据到新的索引中</h6><ul>
<li>1、创建一个新的索引</li>
</ul>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs http">PUT /newbank<br>&#123;<br>  &quot;mappings&quot;: &#123;<br>    &quot;properties&quot;: &#123;<br>      &quot;account_number&quot;: &#123;<br>        &quot;type&quot;: &quot;long&quot;<br>      &#125;,<br>      &quot;address&quot;: &#123;<br>        &quot;type&quot;: &quot;text&quot;<br>      &#125;,<br>      &quot;age&quot;: &#123;<br>        &quot;type&quot;: &quot;integer&quot;<br>      &#125;,<br>      &quot;balance&quot;: &#123;<br>        &quot;type&quot;: &quot;long&quot;<br>      &#125;,<br>      &quot;city&quot;: &#123;<br>        &quot;type&quot;: &quot;keyword&quot;<br>      &#125;,<br>      &quot;email&quot;: &#123;<br>        &quot;type&quot;: &quot;keyword&quot;<br>      &#125;,<br>      &quot;employer&quot;: &#123;<br>        &quot;type&quot;: &quot;keyword&quot;<br>      &#125;,<br>      &quot;firstname&quot;: &#123;<br>        &quot;type&quot;: &quot;text&quot;<br>      &#125;,<br>      &quot;gender&quot;: &#123;<br>        &quot;type&quot;: &quot;keyword&quot;<br>      &#125;,<br>      &quot;lastname&quot;: &#123;<br>        &quot;type&quot;: &quot;text&quot;,<br>        &quot;fields&quot;: &#123;<br>          &quot;keyword&quot;: &#123;<br>            &quot;type&quot;: &quot;keyword&quot;,<br>            &quot;ignore_above&quot;: 256<br>          &#125;<br>        &#125;<br>      &#125;,<br>      &quot;state&quot;: &#123;<br>        &quot;type&quot;: &quot;keyword&quot;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>2、数据迁移</li>
</ul>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs http"># 6.0以后都没有类型的迁移<br>POST _reindex<br>&#123;<br>  &quot;source&quot;: &#123;<br>    &quot;index&quot;: &quot;老索引&quot;<br>  &#125;,<br>  &quot;dest&quot;: &#123;<br>    &quot;index&quot;: &quot;新索引&quot;<br>  &#125;<br>&#125;<br><br># 6.0之前的数据迁移到6.0之后不要类型的索引中<br>POST _reindex<br>&#123;<br>  &quot;source&quot;: &#123;<br>    &quot;index&quot;: &quot;老索引&quot;,<br>    &quot;type&quot;: &quot;指定老版本的类型&quot;<br>  &#125;,<br>  &quot;dest&quot;: &#123;<br>    &quot;index&quot;: &quot;新索引&quot;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="4、分词"><a href="#4、分词" class="headerlink" title="4、分词"></a>4、分词</h5><p>一个<strong>tokenizer</strong>（分词器）接收一个字符流，将它分割成独立的<strong>token</strong>（词元，通常是独立的单词），然后输出<strong>tokens</strong> 流。</p>
<h6 id="1、自定义拓展词库-【-docker安装nginx-】"><a href="#1、自定义拓展词库-【-docker安装nginx-】" class="headerlink" title="1、自定义拓展词库 【 docker安装nginx 】"></a>1、自定义拓展词库 【 docker安装nginx 】</h6><ul>
<li>1、docker安装nginx</li>
</ul>
<blockquote>
<ul>
<li>1、随便启动一个nginx实例，只是为了复制出配置</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">&gt;</span><span class="language-bash">docker run -p 80:80 --name nginx -d nginx:1.10</span><br></code></pre></td></tr></table></figure>

<ul>
<li>2、将容器内的配置文件拷贝到当前目录</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">&gt;</span><span class="language-bash"><span class="hljs-built_in">mkdir</span> -p /mydata/nginx</span><br><span class="hljs-meta prompt_">&gt;</span><span class="language-bash">docker container <span class="hljs-built_in">cp</span> nginx:/etc/nginx /mydata</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">&gt;</span><span class="language-bash"><span class="hljs-comment"># 删除这个容器</span></span><br><span class="hljs-meta prompt_">&gt;</span><span class="language-bash">docker stop nginx</span><br><span class="hljs-meta prompt_">&gt;</span><span class="language-bash">docker <span class="hljs-built_in">rm</span> nginx</span><br></code></pre></td></tr></table></figure>

<ul>
<li>3、修改文件名称</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">&gt;</span><span class="language-bash"><span class="hljs-built_in">mv</span> /mydata/nginx /mydata/conf</span><br><span class="hljs-meta prompt_">&gt;</span><span class="language-bash"><span class="hljs-built_in">mkdir</span> -p /mydata/nginx</span><br><span class="hljs-meta prompt_">&gt;</span><span class="language-bash"><span class="hljs-built_in">mv</span> /mydata/conf /mydata/nginx/conf</span><br></code></pre></td></tr></table></figure>

<ul>
<li>4、创建新的nginx</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">&gt;</span><span class="language-bash">docker run -p 80:80 \</span><br><span class="language-bash">&gt;--name nginx \</span><br><span class="language-bash">&gt;-v /mydata/nginx/html:/usr/share/nginx/html \</span><br><span class="language-bash">&gt;-v /mydata/nginx/logs:/var/log/nginx \</span><br><span class="language-bash">&gt;-v /mydata/nginx/conf:/etc/nginx \</span><br><span class="language-bash">&gt;-d nginx:1.10</span><br></code></pre></td></tr></table></figure>

<ul>
<li>5、安装完成之后测试</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">&gt;</span><span class="language-bash"><span class="hljs-built_in">cd</span> /mydata/nginx/html</span><br><span class="hljs-meta prompt_">&gt;</span><span class="language-bash">vim index.html     <span class="hljs-comment"># 在里面随便编写内容</span></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">&gt;</span><span class="language-bash"><span class="hljs-comment"># 通过浏览器访问 192.168.100.135 可以看到页面了</span></span><br></code></pre></td></tr></table></figure>
</blockquote>
<ul>
<li>2、配置ik 分词器自定义拓展词库</li>
</ul>
<blockquote>
<ul>
<li>1、在nginx中进行配置</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">&gt;</span><span class="language-bash"><span class="hljs-built_in">mkdir</span> -p /mydata/nginx/html/es</span><br><span class="hljs-meta prompt_">&gt;</span><span class="language-bash">vim /mydata/nginx/html/es/fenci.txt  <span class="hljs-comment"># 在其中写上词汇</span></span><br><span class="hljs-meta prompt_">&gt;</span><span class="language-bash">尚硅谷</span><br><span class="hljs-meta prompt_">&gt;</span><span class="language-bash">乔碧罗</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">&gt;</span><span class="language-bash"><span class="hljs-comment"># 之后可以通过浏览器访问  192.168.100.135/es/fenci.txt 可以看到页面了</span></span><br></code></pre></td></tr></table></figure>

<ul>
<li><p>2、配置ik 分词器的远程词库地址</p>
</li>
<li><p>修改ES容器中 <code>/usr/share/elasticsearch/plugins/ik/config </code>目录下的 <code>IKAnalyzer.cfg.xml</code> 【 也就是本机的 <code>/mydata/elasticsearch/plugins/ik/config</code> 目录下的 】</p>
</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">vim /mydata/elasticsearch/plugins/ik/config/IKAnalyzer.cfg.xml<br></code></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs xml">&gt;<span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br>&gt;<span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">properties</span> <span class="hljs-keyword">SYSTEM</span> <span class="hljs-string">&quot;http://java.sun.com/dtd/properties.dtd&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">comment</span>&gt;</span>IK Analyzer 扩展配置<span class="hljs-tag">&lt;/<span class="hljs-name">comment</span>&gt;</span><br>        <span class="hljs-comment">&lt;!--用户可以在这里配置自己的扩展字典 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">entry</span> <span class="hljs-attr">key</span>=<span class="hljs-string">&quot;ext_dict&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">entry</span>&gt;</span><br>         <span class="hljs-comment">&lt;!--用户可以在这里配置自己的扩展停止词字典--&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">entry</span> <span class="hljs-attr">key</span>=<span class="hljs-string">&quot;ext_stopwords&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">entry</span>&gt;</span><br>        <span class="hljs-comment">&lt;!--用户可以在这里配置远程扩展字典 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">entry</span> <span class="hljs-attr">key</span>=<span class="hljs-string">&quot;remote_ext_dict&quot;</span>&gt;</span>http://192.168.100.135/es/fenci.txt<span class="hljs-tag">&lt;/<span class="hljs-name">entry</span>&gt;</span>  # 只用修改这一行就可以<br>        <span class="hljs-comment">&lt;!--用户可以在这里配置远程扩展停止词字典--&gt;</span><br>        <span class="hljs-comment">&lt;!-- &lt;entry key=&quot;remote_ext_stopwords&quot;&gt;words_location&lt;/entry&gt; --&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span><br></code></pre></td></tr></table></figure>


<p><img src="/img/guli_img/ES_%E9%85%8D%E7%BD%AEik%E5%88%86%E8%AF%8D%E5%99%A8%E7%9A%84%E8%BF%9C%E7%A8%8B%E6%89%A9%E5%B1%95%E5%AD%97%E5%85%B8.jpg" alt="ES_配置ik分词器的远程扩展字典"></p>
<ul>
<li>修改完成后，重启ElasticSearch容器</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker restart elasticsearch<br></code></pre></td></tr></table></figure>

<ul>
<li>3、进行测试</li>
</ul>
<p><img src="/img/guli_img/ES_%E8%BF%9C%E7%A8%8B%E8%87%AA%E5%AE%9A%E4%B9%89%E5%AD%97%E5%85%B8%E9%85%8D%E7%BD%AE%E6%88%90%E5%8A%9F.jpg" alt="ES_远程自定义字典配置成功"></p>
</blockquote>
<h4 id="5、SpringBoot整合ElasticSearch-【-elasticsearch-rest-high-level-client-】"><a href="#5、SpringBoot整合ElasticSearch-【-elasticsearch-rest-high-level-client-】" class="headerlink" title="5、SpringBoot整合ElasticSearch  【 elasticsearch-rest-high-level-client 】"></a>5、SpringBoot整合ElasticSearch  【 <code>elasticsearch-rest-high-level-client</code> 】</h4><h5 id="1、介绍"><a href="#1、介绍" class="headerlink" title="1、介绍"></a>1、介绍</h5><h6 id="1、通过9300-TCP-端口操作-【-不建议-】"><a href="#1、通过9300-TCP-端口操作-【-不建议-】" class="headerlink" title="1、通过9300  TCP 端口操作  【 不建议 】"></a>1、通过9300  TCP 端口操作  【 不建议 】</h6><ul>
<li>使用 <code>spring-data-elasticsearch:transport-api.jar</code></li>
<li>特点：<ul>
<li>Spring版本不同，**transport-api.jar ** 就不同，不能适配ElasticSearch 的版本</li>
<li>7.x 已经不建议使用</li>
</ul>
</li>
</ul>
<h6 id="2、通过-9200-HTTP-操作"><a href="#2、通过-9200-HTTP-操作" class="headerlink" title="2、通过 9200 HTTP 操作"></a>2、通过 9200 HTTP 操作</h6><p>有多种方式：</p>
<ul>
<li>JestClient：非官方，更新慢                                    <strong>×</strong></li>
<li>RestTemplate：模拟发HTTP请求，ElasticSearch 很多操作需要自己封装，麻烦                           <strong>×</strong></li>
<li>HTTPClient：模拟发HTTP请求，ElasticSearch 很多操作需要自己封装，麻烦                         <strong>×</strong></li>
<li><strong>ElasticSearch-Rest-Client：官方RestClient ，封装了ES 操作，API 层次分明，上手简单</strong>                  <strong>√</strong></li>
</ul>
<h5 id="2、整合"><a href="#2、整合" class="headerlink" title="2、整合"></a>2、整合</h5><h6 id="1、导入依赖"><a href="#1、导入依赖" class="headerlink" title="1、导入依赖"></a>1、导入依赖</h6><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">java.version</span>&gt;</span>1.8<span class="hljs-tag">&lt;/<span class="hljs-name">java.version</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">spring-cloud.version</span>&gt;</span>Greenwich.SR3<span class="hljs-tag">&lt;/<span class="hljs-name">spring-cloud.version</span>&gt;</span><br>    <span class="hljs-comment">&lt;!--可以在这里指定ES的版本--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">elasticsearch.version</span>&gt;</span>7.4.2<span class="hljs-tag">&lt;/<span class="hljs-name">elasticsearch.version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span><br><br><br><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>    <span class="hljs-comment">&lt;!-- https://mvnrepository.com/artifact/org.elasticsearch.client/elasticsearch-rest-high-level-client --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.elasticsearch.client<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>elasticsearch-rest-high-level-client<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>7.4.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br></code></pre></td></tr></table></figure>

<h6 id="2、-编写配置：给容器中注入一个RestHighLevelClient"><a href="#2、-编写配置：给容器中注入一个RestHighLevelClient" class="headerlink" title="2、 编写配置：给容器中注入一个RestHighLevelClient"></a>2、 编写配置：给容器中注入一个RestHighLevelClient</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.apache.http.HttpHost;<br><span class="hljs-keyword">import</span> org.elasticsearch.client.RestClient;<br><span class="hljs-keyword">import</span> org.elasticsearch.client.RestHighLevelClient;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> taoao</span><br><span class="hljs-comment"> * 整合 elasticsearch-rest-high-level-client 步骤</span><br><span class="hljs-comment"> * 1、导入依赖</span><br><span class="hljs-comment"> * 2、编写配置：给容器中注入一个RestHighLevelClient</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GulimallElasticSearchConfig</span> &#123;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> RestHighLevelClient <span class="hljs-title function_">esRestClient</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">RestHighLevelClient</span> <span class="hljs-variable">client</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RestHighLevelClient</span>(<br>                RestClient.builder(  <span class="hljs-comment">// 它里面可以指定多个HttpHost</span><br>                        <span class="hljs-keyword">new</span> <span class="hljs-title class_">HttpHost</span>(<span class="hljs-string">&quot;192.168.100.135&quot;</span>, <span class="hljs-number">9200</span>, <span class="hljs-string">&quot;http&quot;</span>)<br>                )<br>        );<br>        <span class="hljs-keyword">return</span> client;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="3、测试保存数据"><a href="#3、测试保存数据" class="headerlink" title="3、测试保存数据"></a>3、测试保存数据</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"> 	<span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 测试给ES中存储数据</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">indexData</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-comment">// 步骤1：构造IndexRequest</span><br>        <span class="hljs-type">IndexRequest</span> <span class="hljs-variable">indexRequest</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IndexRequest</span>(<span class="hljs-string">&quot;users&quot;</span>);  <span class="hljs-comment">// 参数是索引名称</span><br>        indexRequest.id(<span class="hljs-string">&quot;1&quot;</span>);  <span class="hljs-comment">// 指定id</span><br><br><span class="hljs-comment">//        // 保存数据的方式1</span><br><span class="hljs-comment">//        indexRequest.source(&quot;userName&quot;, &quot;男&quot;, &quot;age&quot;, 18, &quot;gender&quot;, &quot;男&quot;);</span><br><br>        <span class="hljs-comment">// 保存数据的第二种方式</span><br>        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>();<br>        user.setUsername(<span class="hljs-string">&quot;张三&quot;</span>);<br>        user.setAge(<span class="hljs-number">23</span>);<br>        user.setGender(<span class="hljs-string">&quot;男&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">jsonString</span> <span class="hljs-operator">=</span> JSON.toJSONString(user);<br>        indexRequest.source(jsonString, XContentType.JSON);<br><br>        <span class="hljs-comment">// 步骤2：发送保存请求</span><br>        <span class="hljs-type">IndexResponse</span> <span class="hljs-variable">indexResponse</span> <span class="hljs-operator">=</span> client.index(indexRequest, GulimallElasticSearchConfig.COMMON_OPTIONS);<br><br>        System.out.println(<span class="hljs-string">&quot;indexResponse = &quot;</span> + indexResponse);<br><br>    &#125;<br><br>    <span class="hljs-meta">@Data</span><br>    <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> &#123;<br>        <span class="hljs-keyword">private</span> String username;<br>        <span class="hljs-keyword">private</span> String gender;<br>        <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> age;<br>    &#125;<br></code></pre></td></tr></table></figure>

<h5 id="4、测试复杂检索"><a href="#4、测试复杂检索" class="headerlink" title="4、测试复杂检索"></a>4、测试复杂检索</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs java"> 	<span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 测试检索功能</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">searchData</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-comment">// 1、创建检索请求</span><br>        <span class="hljs-type">SearchRequest</span> <span class="hljs-variable">searchRequest</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SearchRequest</span>();<br>        searchRequest.indices(<span class="hljs-string">&quot;bank&quot;</span>);  <span class="hljs-comment">// 指定索引</span><br>        <span class="hljs-type">SearchSourceBuilder</span> <span class="hljs-variable">sourceBuilder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SearchSourceBuilder</span>();<br>        <span class="hljs-comment">// 1.1、构造检索条件</span><br>        sourceBuilder.query(QueryBuilders.matchQuery(<span class="hljs-string">&quot;address&quot;</span>, <span class="hljs-string">&quot;mill&quot;</span>));  <span class="hljs-comment">// 查询address中包含mill的</span><br>        sourceBuilder.aggregation(AggregationBuilders.terms(<span class="hljs-string">&quot;ageAgg&quot;</span>).field(<span class="hljs-string">&quot;age&quot;</span>).size(<span class="hljs-number">10</span>));  <span class="hljs-comment">// 聚合：查询年龄分布</span><br>        sourceBuilder.aggregation(AggregationBuilders.avg(<span class="hljs-string">&quot;balanceAvg&quot;</span>).field(<span class="hljs-string">&quot;balance&quot;</span>));  <span class="hljs-comment">// 聚合：查询平均工资</span><br>        System.out.println(<span class="hljs-string">&quot;检索条件DSL = &quot;</span> + sourceBuilder);<br><br>        searchRequest.source(sourceBuilder); <span class="hljs-comment">// 指定DSL（检索条件）</span><br><br>        <span class="hljs-comment">// 2、执行检索</span><br>        <span class="hljs-type">SearchResponse</span> <span class="hljs-variable">searchResponse</span> <span class="hljs-operator">=</span> client.search(searchRequest, GulimallElasticSearchConfig.COMMON_OPTIONS);<br><br>        <span class="hljs-comment">// 3、分析结果  searchResponse</span><br>        System.out.println(<span class="hljs-string">&quot;结果 = &quot;</span> + searchResponse);<br><span class="hljs-comment">//        Map map = JSON.parseObject(searchResponse.toString(), Map.class);</span><br>        <span class="hljs-comment">// 3.1、获取所有查到的数据</span><br>        SearchHit[] hits = searchResponse.getHits().getHits();<br>        <span class="hljs-keyword">for</span> (SearchHit hit : hits) &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">hitSourceAsString</span> <span class="hljs-operator">=</span> hit.getSourceAsString();<br>            <span class="hljs-type">Account</span> <span class="hljs-variable">account</span> <span class="hljs-operator">=</span> JSON.parseObject(hitSourceAsString, Account.class);<br>            System.out.println(<span class="hljs-string">&quot;account = &quot;</span> + account);<br>        &#125;<br>        <span class="hljs-comment">// 3.2、获取这次检索到的聚合信息</span><br>        <span class="hljs-type">Aggregations</span> <span class="hljs-variable">aggregations</span> <span class="hljs-operator">=</span> searchResponse.getAggregations();<br>        <span class="hljs-type">Terms</span> <span class="hljs-variable">ageAgg</span> <span class="hljs-operator">=</span> aggregations.get(<span class="hljs-string">&quot;ageAgg&quot;</span>);<br>        <span class="hljs-keyword">for</span> (Terms.Bucket bucket : ageAgg.getBuckets()) &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">keyAsString</span> <span class="hljs-operator">=</span> bucket.getKeyAsString();<br>            System.out.println(<span class="hljs-string">&quot;keyAsString = &quot;</span> + keyAsString + <span class="hljs-string">&quot;==&gt;&quot;</span> +bucket.getDocCount());<br>        &#125;<br><br>        <span class="hljs-type">Avg</span> <span class="hljs-variable">balanceAvg</span> <span class="hljs-operator">=</span> aggregations.get(<span class="hljs-string">&quot;balanceAvg&quot;</span>);<br>        System.out.println(<span class="hljs-string">&quot;balanceAvg.getValue() = &quot;</span> + balanceAvg.getValue() + <span class="hljs-string">&quot;==&gt;&quot;</span>);<br><br>    &#125;<br><br>    <span class="hljs-meta">@Data</span><br>    <span class="hljs-meta">@ToString</span><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Account</span> &#123;<br><br>        <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> account_number;<br>        <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> balance;<br>        <span class="hljs-keyword">private</span> String firstname;<br>        <span class="hljs-keyword">private</span> String lastname;<br>        <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> age;<br>        <span class="hljs-keyword">private</span> String gender;<br>        <span class="hljs-keyword">private</span> String address;<br>        <span class="hljs-keyword">private</span> String employer;<br>        <span class="hljs-keyword">private</span> String email;<br>        <span class="hljs-keyword">private</span> String city;<br>        <span class="hljs-keyword">private</span> String state;<br>    &#125;<br></code></pre></td></tr></table></figure>



<h3 id="五、nginx搭建域名访问环境"><a href="#五、nginx搭建域名访问环境" class="headerlink" title="五、nginx搭建域名访问环境"></a>五、nginx搭建域名访问环境</h3><blockquote>
<p>nginx.conf 配置文件的各个部分的功能：</p>
<ul>
<li>全局块：配置影响nginx全局的指令。如：用户组，nginx进程pid存放路径，日志存放路径，配置文件引入，允许生成worker process数等</li>
<li>envents块：配置影响nginx服务器或与用户的网络连接。如：每个进程的最大连接数，选取哪种事件驱动模型处理连接请求，是否允许同时接受多个网络连接，开启多个网络连接序列化等</li>
<li>http块：可以嵌套多个server，配置代理，缓存，日志定义等绝大多数功能和第三方模块的配置。如文件引入，mime-type定义，日志自定义，是否使用sendfile传输文件，连接超时时间，单连接请求数等。</li>
<li>http全局块：如upstream，错误页面，连接超时等</li>
<li>server块：配置虚拟主机的相关参数，一个http中可以有多个server</li>
<li>location：配置请求的路由，以及各种页面的处理情况</li>
<li>location：…</li>
</ul>
</blockquote>
<p><code>nginx.conf</code> 配置文件各个部分的介绍:</p>
<p><img src="/img/guli_img/nginx%E7%82%B9conf%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E5%90%84%E4%B8%AA%E9%83%A8%E5%88%86%E7%9A%84%E4%BB%8B%E7%BB%8D.png" alt="nginx点conf配置文件各个部分的介绍"></p>
<p>nginx配置文件中引入的server块:</p>
<p><img src="/img/guli_img/nginx%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E4%B8%AD%E5%BC%95%E5%85%A5%E7%9A%84server%E5%9D%97.png" alt="nginx配置文件中引入的server块"></p>
<h4 id="1、步骤"><a href="#1、步骤" class="headerlink" title="1、步骤:"></a>1、步骤:</h4><h5 id="1-1、修改hosts-文件（使用火绒方便）"><a href="#1-1、修改hosts-文件（使用火绒方便）" class="headerlink" title="1.1、修改hosts 文件（使用火绒方便）"></a>1.1、修改hosts 文件（使用火绒方便）</h5><p>**hosts 文件路径： <code>C:\Windows\System32\drivers\etc\hosts</code> **</p>
<p><img src="/img/guli_img/%E4%BF%AE%E6%94%B9hosts%E6%96%87%E4%BB%B6.png" alt="修改hosts文件"></p>
<p><img src="/img/guli_img/hosts%E4%BF%AE%E6%94%B9%E6%88%90%E5%8A%9F%E6%B5%8B%E8%AF%95%E4%BD%BF%E7%94%A8%E5%9F%9F%E5%90%8D%E8%AE%BF%E9%97%AEES.png" alt="hosts修改成功测试使用域名访问ES"></p>
<h5 id="1-2、让nginx-进行反向代理"><a href="#1-2、让nginx-进行反向代理" class="headerlink" title="1.2、让nginx 进行反向代理"></a>1.2、让nginx 进行反向代理</h5><p><strong>让nginx 把请求转给网关，通过网关把请求转给各个服务</strong></p>
<h6 id="2-2-1、在nginx-conf-配置文件中配置上游服务器upstream"><a href="#2-2-1、在nginx-conf-配置文件中配置上游服务器upstream" class="headerlink" title="2.2.1、在nginx.conf 配置文件中配置上游服务器upstream"></a>2.2.1、在<code>nginx.conf</code> 配置文件中配置上游服务器upstream</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">upstream gulimall&#123;<br>    server  192.168.100.1:88;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="/img/guli_maill/%E9%85%8D%E7%BD%AEupstream%EF%BC%88%E4%B8%8A%E6%B8%B8%E6%9C%8D%E5%8A%A1%E5%99%A8%EF%BC%89.png" alt="配置upstream（上游服务器）"></p>
<h6 id="2-2-2、在-conf-d-目录下配置server"><a href="#2-2-2、在-conf-d-目录下配置server" class="headerlink" title="2.2.2、在 conf.d/目录下配置server"></a>2.2.2、在 <code>conf.d/</code>目录下配置server</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">复制出一份配置文件到conf.d 目录下</span><br>cp default.conf gulimall.conf<br>vim gulimall.conf<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">gulimall.conf:</span><br>server &#123;<br>    listen       80;  <br>    server_name  gulimall.com;  # 配置server_name为host的值<br><br>    #charset koi8-r;<br>    #access_log  /var/log/nginx/log/host.access.log  main;<br><br>    location / &#123;<br>        proxy_pass      http://gulimall;  # 配置上游服务器的名字<br>    &#125;<br><br></code></pre></td></tr></table></figure>

<p><img src="/img/guli_mall/%E9%85%8D%E7%BD%AEserver%E5%9D%97%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E5%88%B0%E7%BD%91%E5%85%B3.png" alt="配置server块负载均衡到网关"></p>
<h6 id="2-2-3、在网关中配置路由规则"><a href="#2-2-3、在网关中配置路由规则" class="headerlink" title="2.2.3、在网关中配置路由规则"></a>2.2.3、在网关中配置路由规则</h6><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># gulimall-gateway </span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">gulimall_host_route</span><br>          <span class="hljs-attr">uri:</span> <span class="hljs-string">lb://gulimall-product</span><br>          <span class="hljs-attr">predicates:</span><br>            <span class="hljs-comment"># 只要 请求体的Host中的值是 gulimall.com 就匹配到gulimall-product服务</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">Host=**.gulimall.com,gulimall.com</span><br></code></pre></td></tr></table></figure>

<p><img src="/img/guli_img/%E8%AF%B7%E6%B1%82%E5%A4%B4.png" alt="请求头"></p>
<h6 id="2-2-4-补-、由于nginx再转发到网关的时候，会丢掉Host请求头，所以要在server中的location中进行配置"><a href="#2-2-4-补-、由于nginx再转发到网关的时候，会丢掉Host请求头，所以要在server中的location中进行配置" class="headerlink" title="2.2.4(补)、由于nginx再转发到网关的时候，会丢掉Host请求头，所以要在server中的location中进行配置"></a>2.2.4(补)、由于nginx再转发到网关的时候，会丢掉Host请求头，所以要在server中的location中进行配置</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs shell">server &#123;<br>    listen       80;<br>    server_name  gulimall.com;<br><br>    #charset koi8-r;<br>    #access_log  /var/log/nginx/log/host.access.log  main;<br><br>    location / &#123;<br>        proxy_pass      http://gulimall;<br>        proxy_set_header Host $host;  # 配置proxy_set_header  设置 Host请求头，值为 $host<br>    &#125;<br></code></pre></td></tr></table></figure>

<h4 id="2、流程分析"><a href="#2、流程分析" class="headerlink" title="2、流程分析"></a>2、流程分析</h4><ul>
<li>1、浏览器发送gulimall.com 请求，这时候浏览器的请求头中就会自带 Host请求头 ，值是 gulimall.com</li>
<li>2、根据本地配置的Hosts文件，去找gulimall.com 对应的ip就是虚拟机的ip 192.168.100.135，默认80端口就会去找虚拟机中的nginx</li>
<li>3、nginx会监听浏览器发送的 gulimall.com 端口为80 的请求</li>
<li>4、nginx然后去找上游服务器，找到转发的地址，再通过server块中的location中的配置，去将请求转发到网关 <code>192.168.100.1:88</code>中</li>
<li>5、再通过网关去负载均衡到各个服务</li>
<li>6、由于nginx请求转发的时候会丢掉很多请求头，而网关又是根据请求头中的 Host 去路由到指定的服务的，所以需要在nginx中额外配置 <code>proxy_set_header Host $host; </code>  【 意思是： 配置proxy_set_header  设置 Host请求头，值为 $host 】</li>
</ul>
<h3 id="六、压力测试"><a href="#六、压力测试" class="headerlink" title="六、压力测试"></a>六、压力测试</h3><h4 id="1、JMeter-压力测试"><a href="#1、JMeter-压力测试" class="headerlink" title="1、JMeter 压力测试"></a>1、JMeter 压力测试</h4><h4 id="2、性能监控"><a href="#2、性能监控" class="headerlink" title="2、性能监控"></a>2、性能监控</h4><PDF>

<h4 id="3、docker-小技巧："><a href="#3、docker-小技巧：" class="headerlink" title="3、docker 小技巧："></a>3、docker 小技巧：</h4><p>输入 <code>docker stats</code> 可以监控容器的内存使用情况</p>
<p>![docker stats命令](&#x2F;img&#x2F;guli_img&#x2F;docker stats命令.png)</p>
<h4 id="4、nginx动静分离"><a href="#4、nginx动静分离" class="headerlink" title="4、nginx动静分离"></a>4、nginx动静分离</h4><h5 id="1、两步"><a href="#1、两步" class="headerlink" title="1、两步"></a>1、两步</h5><ul>
<li><p>1、将所有项目的静态资源都应该放在nginx里面</p>
<ul>
<li><pre><code class="shell">mkdir /mydata/nginx/html/static
# 然后将静态资源都放在static目录下
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs awk"><br>- <span class="hljs-number">2</span>、制定一个规则：只要是`<span class="hljs-regexp">/static/</span>**` 的所有请求，都由nginx直接返回静态资源（不过网关，不由tomcat处理）<br><br>  - 给index.html中所有的路径都加<span class="hljs-regexp">/static/</span><br><br>  - 配置nginx<br><br>    - ```shell<br>      vim <span class="hljs-regexp">/mydata/</span>nginx<span class="hljs-regexp">/conf/</span>conf.d/gulimall.conf<br>      <br>          location <span class="hljs-regexp">/static/</span> &#123;  <span class="hljs-comment"># 新添加的</span><br>              root   <span class="hljs-regexp">/usr/</span>share<span class="hljs-regexp">/nginx/</span>html;<br>          &#125;<br>      <br>          location / &#123;  <span class="hljs-comment"># 原来的不变</span><br>              proxy_pass      http:<span class="hljs-regexp">//gu</span>limall;<br>              proxy_set_header Host <span class="hljs-variable">$host</span>;<br>          &#125;<br></code></pre></td></tr></table></figure>
</code></pre>
</li>
</ul>
</li>
</ul>
<h3 id="七、缓存"><a href="#七、缓存" class="headerlink" title="七、缓存"></a>七、缓存</h3><h4 id="1、缓存使用"><a href="#1、缓存使用" class="headerlink" title="1、缓存使用"></a>1、缓存使用</h4><h5 id="1、缓存"><a href="#1、缓存" class="headerlink" title="1、缓存"></a>1、缓存</h5><h6 id="1、哪些数据适合放入缓存？"><a href="#1、哪些数据适合放入缓存？" class="headerlink" title="1、哪些数据适合放入缓存？"></a>1、哪些数据适合放入缓存？</h6><blockquote>
<p><strong>哪些数据适合放入缓存？</strong></p>
<ul>
<li>即时性、数据一致性要求不高的</li>
<li>访问量大且跟新频率不高的数据（读多，写少）</li>
</ul>
</blockquote>
<h6 id="2、使用Map作为缓存的伪代码"><a href="#2、使用Map作为缓存的伪代码" class="headerlink" title="2、使用Map作为缓存的伪代码"></a>2、使用Map作为缓存的伪代码</h6><blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java">&gt;<span class="hljs-comment">// 1、如果缓存中有，就用缓存的</span><br>&gt;Map&lt;String, List&lt;Catelog2Vo&gt;&gt; catalogJson = (Map&lt;String, List&lt;Catelog2Vo&gt;&gt;) cache.get(<span class="hljs-string">&quot;catalogJson&quot;</span>);<br>&gt;<span class="hljs-keyword">if</span> (catalogJson == <span class="hljs-literal">null</span>) &#123;<br> <span class="hljs-comment">// 调用业务，返回数据又放入缓存</span><br> cache.put(<span class="hljs-string">&quot;catalogJson&quot;</span>, map);<br> <span class="hljs-keyword">return</span> map;<br>&gt;&#125;<br>&gt;<span class="hljs-keyword">return</span> catalogJson;<br></code></pre></td></tr></table></figure>
</blockquote>
<h5 id="2、整合redis作为缓存"><a href="#2、整合redis作为缓存" class="headerlink" title="2、整合redis作为缓存"></a>2、整合redis作为缓存</h5><h6 id="1、引入-spring-boot-starter-data-redis-依赖"><a href="#1、引入-spring-boot-starter-data-redis-依赖" class="headerlink" title="1、引入 spring-boot-starter-data-redis 依赖"></a>1、引入 <code>spring-boot-starter-data-redis</code> 依赖</h6><blockquote>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml">&gt;<span class="hljs-comment">&lt;!--整合redis作为缓存--&gt;</span><br>&gt;<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br> <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br> <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>&gt;<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>
</blockquote>
<h6 id="2、配置redis的主机地址和端口"><a href="#2、配置redis的主机地址和端口" class="headerlink" title="2、配置redis的主机地址和端口"></a>2、配置redis的主机地址和端口</h6><blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">&gt;spring:</span><br><span class="hljs-string">&gt;redis:</span><br><span class="hljs-string">&gt;host:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.100</span><span class="hljs-number">.135</span><br><span class="hljs-string">&gt;port:</span> <span class="hljs-number">6379</span><br></code></pre></td></tr></table></figure>
</blockquote>
<h6 id="3、使用SpringBoot自动配置好的-StringRedisTemplate来操作redis"><a href="#3、使用SpringBoot自动配置好的-StringRedisTemplate来操作redis" class="headerlink" title="3、使用SpringBoot自动配置好的 StringRedisTemplate来操作redis"></a>3、<strong>使用SpringBoot自动配置好的 <code>StringRedisTemplate</code>来操作redis</strong></h6><blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java">&gt;<span class="hljs-comment">/**</span><br><span class="hljs-comment">  * 自动注入StringRedisTemplate，它的key和value都是String类型的</span><br><span class="hljs-comment">  */</span><br> <span class="hljs-meta">@Autowired</span><br> <span class="hljs-keyword">private</span> StringRedisTemplate stringRedisTemplate;<br><br> <span class="hljs-meta">@Test</span><br> <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testStringRedisTemplate</span><span class="hljs-params">()</span> &#123;<br>     ValueOperations&lt;String, String&gt; ops = stringRedisTemplate.opsForValue();<br><br>     <span class="hljs-comment">// 保存</span><br>     ops.set(<span class="hljs-string">&quot;hello&quot;</span>, <span class="hljs-string">&quot;world_&quot;</span> + UUID.randomUUID().toString());<br><br>     <span class="hljs-comment">// 查询</span><br>     <span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> ops.get(<span class="hljs-string">&quot;hello&quot;</span>);<br>     System.out.println(<span class="hljs-string">&quot;value = &quot;</span> + value);<br> &#125;<br></code></pre></td></tr></table></figure>
</blockquote>
<h5 id="3、缓存击穿、穿透、雪崩"><a href="#3、缓存击穿、穿透、雪崩" class="headerlink" title="3、缓存击穿、穿透、雪崩"></a>3、缓存击穿、穿透、雪崩</h5><h6 id="1、高并发下缓存失效问题-——-缓存穿透（查询一个不存在的数据）"><a href="#1、高并发下缓存失效问题-——-缓存穿透（查询一个不存在的数据）" class="headerlink" title="1、高并发下缓存失效问题 —— 缓存穿透（查询一个不存在的数据）"></a>1、高并发下缓存失效问题 —— 缓存穿透（查询一个不存在的数据）</h6><blockquote>
<p><strong>缓存穿透：</strong></p>
<p>指查询一个一定不存在的数据，由于缓存是不命中，将去查询数据库，但是数据库也没有这条记录。没有将这次查询的null写入缓存，这将导致这个不存在的数据每次请求都要去存储层去查询，失去了缓存的意义</p>
<p><strong>风险：</strong></p>
<p>利用不存在的数据进行攻击，数据库瞬时压力增大，最终导致崩溃</p>
<p><strong>解决：</strong></p>
<p>null结果缓存，并加入短暂过期时间</p>
</blockquote>
<h6 id="2、高并发下缓存失效问题-——-缓存雪崩（缓存同时失效）"><a href="#2、高并发下缓存失效问题-——-缓存雪崩（缓存同时失效）" class="headerlink" title="2、高并发下缓存失效问题 —— 缓存雪崩（缓存同时失效）"></a>2、高并发下缓存失效问题 —— 缓存雪崩（缓存同时失效）</h6><blockquote>
<p><strong>缓存雪崩：</strong></p>
<p>缓存雪崩是指在我们设置缓存时，key采用了相同的过期时间，导致缓存在某一时刻同时失效，请求全部转发到DB，DB瞬时压力过重雪崩。</p>
<p><strong>解决：</strong></p>
<p>原有的失效时间基础上增加一个随机值，比如1-5分钟随机，这样每一个缓存的过期时间的重复率就会降低，就很难引发集体失效的事件。</p>
</blockquote>
<h6 id="3、高并发下缓存失效问题-——-缓存击穿（大量请求访问一个刚好失效的key）"><a href="#3、高并发下缓存失效问题-——-缓存击穿（大量请求访问一个刚好失效的key）" class="headerlink" title="3、高并发下缓存失效问题 —— 缓存击穿（大量请求访问一个刚好失效的key）"></a>3、高并发下缓存失效问题 —— 缓存击穿（大量请求访问一个刚好失效的key）</h6><blockquote>
<p><strong>缓存击穿：</strong></p>
<ul>
<li>对于一些设置了过期时间的key，如果这些key可能会在某些时间点 被 超高并发地访问，是一种非常“热点”的数据。</li>
<li>如果这个key 在大量请求同时进来前正好失效，那么所有对这个key 的数据查询都落到DB，称为缓存击穿</li>
</ul>
<p><strong>解决：</strong></p>
<p>加锁。 大量并发只让一个去查，其他人等待，查到以后释放锁，其他人获取到锁，先查缓存，就会有数据，不用去DB。</p>
</blockquote>
<h4 id="2、分布式锁-Redission"><a href="#2、分布式锁-Redission" class="headerlink" title="2、分布式锁 Redission"></a>2、分布式锁 Redission</h4><h5 id="1、使用步骤"><a href="#1、使用步骤" class="headerlink" title="1、使用步骤"></a>1、使用步骤</h5><h6 id="1、导入依赖-1"><a href="#1、导入依赖-1" class="headerlink" title="1、导入依赖"></a>1、导入依赖</h6><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--以后使用redisson作为所有分布式锁，分布式对象等功能框架--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.redisson<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>redisson<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.12.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<h6 id="2、配置redisson"><a href="#2、配置redisson" class="headerlink" title="2、配置redisson"></a>2、配置redisson</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.redisson.Redisson;<br><span class="hljs-keyword">import</span> org.redisson.api.RedissonClient;<br><span class="hljs-keyword">import</span> org.redisson.config.Config;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> taoao</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyRedissonConfig</span> &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 所有对Redisson 的使用都是使用RedissonClient 对象</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean(destroyMethod = &quot;shutdown&quot;)</span><br>    <span class="hljs-keyword">public</span> RedissonClient <span class="hljs-title function_">redisson</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// 1、创建配置</span><br>        <span class="hljs-type">Config</span> <span class="hljs-variable">config</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Config</span>();<br>        config.useSingleServer().setAddress(<span class="hljs-string">&quot;redis://192.168.100.135:6379&quot;</span>);<br>        <span class="hljs-comment">// 2、根据config创建出 RedissonClient 实例</span><br>        <span class="hljs-type">RedissonClient</span> <span class="hljs-variable">redissonClient</span> <span class="hljs-operator">=</span> Redisson.create(config);<br>        <span class="hljs-keyword">return</span> redissonClient;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="2、Lock锁测试"><a href="#2、Lock锁测试" class="headerlink" title="2、Lock锁测试"></a>2、Lock锁测试</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java">   <span class="hljs-meta">@Autowired</span><br>   RedissonClient redisson;<br><br><span class="hljs-meta">@ResponseBody</span><br>   <span class="hljs-meta">@GetMapping(&quot;/hello&quot;)</span><br>   <span class="hljs-keyword">public</span> String <span class="hljs-title function_">hello</span><span class="hljs-params">()</span> &#123;<br>       <span class="hljs-comment">// 1、获取一把锁，锁的名字随便写，只要名字一样，就是同一把锁</span><br>       <span class="hljs-type">RLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> redisson.getLock(<span class="hljs-string">&quot;my-lock&quot;</span>);  <span class="hljs-comment">// 锁的名字随便写</span><br><br>       <span class="hljs-comment">// 2、加索</span><br>       lock.lock();  <span class="hljs-comment">// 阻塞式等待</span><br>       <span class="hljs-keyword">try</span> &#123;<br>           System.out.println(<span class="hljs-string">&quot;加锁成功，执行业务&quot;</span> + Thread.currentThread().getId());<br>           Thread.sleep(<span class="hljs-number">30000</span>);<br>       &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br><br>       &#125; <span class="hljs-keyword">finally</span> &#123;<br>           <span class="hljs-comment">// 3、解锁</span><br>           System.out.println(<span class="hljs-string">&quot;释放锁。。。&quot;</span> + Thread.currentThread().getId());<br>           lock.unlock();<br>       &#125;<br>       <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;hello&quot;</span>;<br>   &#125;<br></code></pre></td></tr></table></figure>

<p><strong>此时，调用两遍 <code>/hello</code> 接口，只要第一次锁不释放，第二次接口就一直等待</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">加锁成功，执行业务<span class="hljs-number">101</span><br>释放锁。。。<span class="hljs-number">101</span><br>加锁成功，执行业务<span class="hljs-number">103</span><br>释放锁。。。<span class="hljs-number">103</span><br></code></pre></td></tr></table></figure>

<p><img src="/img/guli_img/Redisson-%E6%B5%8B%E8%AF%95Lock%E9%94%81.png" alt="Redisson-测试Lock锁"></p>
<p>**Redisson的两大优点: **</p>
<ul>
<li>1、锁的自动续期，如果业务超长，Redisson会在代码运行期间自动给锁续上新的30秒周期。不用担心业务时间长，锁自动过期被删掉</li>
<li>2、加锁的业务只要运行完成，就不会给当前锁续期，即使不手动解锁，锁也会默认在30秒以后自动删除</li>
</ul>
<h5 id="3、看门狗原理"><a href="#3、看门狗原理" class="headerlink" title="3、看门狗原理"></a>3、看门狗原理</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 没有看门狗，推荐使用这个，需要把自动解锁时间设置的长一点  【 推荐指定过期时间 】</span><br>lock.lock(<span class="hljs-number">10</span>, TimeUnit.*SECONDS*);  <span class="hljs-comment">// 还可以在加锁的同时设置自动解锁，设置成10秒以后自动解锁 【 自动解锁时间，一定要大于业务的执行时间 】</span><br></code></pre></td></tr></table></figure>

<p>如果指定了过期时间，在锁时间到了以后，不会自动续期。</p>
<ul>
<li>1、如果我们传递了锁的超时时间，就发送给Redis，执行Lua脚本，进行占锁，默认超时时间就是我们指定的时间</li>
<li>2、如果我们没有传递锁的超时时间，就使用 30 * 1000 ，【 LockWatchdogTimeout 看门狗的默认事件 也就是30秒 】;<ul>
<li>2.1、只要占锁成功，就会启动一个定时任务【 重新给锁设置过期时间 （每隔10秒自动再次续期） 】</li>
</ul>
</li>
</ul>
<p>最佳实战: 一般使用lock.lock(10, TimeUnit.SECONDS); 省掉了整个续期操作</p>
<h5 id="4、读写锁"><a href="#4、读写锁" class="headerlink" title="4、读写锁"></a>4、读写锁</h5><ul>
<li>改数据加写锁，读数据加读锁</li>
<li>只要有写锁的存在，都必须等待</li>
<li>加读写锁的好处是：保证一定能读到最新数据 【 修改期间，写锁是一个排它锁（互斥锁），读锁是一个共享锁 】<ul>
<li>只要写锁没释放，读锁就必须等待</li>
</ul>
</li>
</ul>
<p><strong>案例：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">    * 测试读写锁</span><br><span class="hljs-comment">    * &lt;p&gt;</span><br><span class="hljs-comment">    * 加读写锁的好处是：保证一定能读到最新数据 【 修改期间，写锁是一个排它锁（互斥锁、独享锁），读锁是一个共享锁 】</span><br><span class="hljs-comment">    * 只要写锁没释放，读就必须等待</span><br><span class="hljs-comment">    * &lt;p&gt;</span><br><span class="hljs-comment">    * 写 + 读 ： 读锁要等待写锁释放</span><br><span class="hljs-comment">    * 写 + 写 ： 阻塞方式</span><br><span class="hljs-comment">    * 读 + 写 ： 写锁也要等待读锁释放</span><br><span class="hljs-comment">    * 读 + 读 ： 相当于没有锁 【 并发读，只会在redis中记录好所有当前的读锁。它们都会同时加锁成功 】</span><br><span class="hljs-comment">    * &lt;p&gt;</span><br><span class="hljs-comment">    * 只要有写锁的存在，都必须等待</span><br><span class="hljs-comment">    *</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">    */</span><br>   <span class="hljs-meta">@GetMapping(&quot;/write&quot;)</span><br>   <span class="hljs-meta">@ResponseBody</span><br>   <span class="hljs-keyword">public</span> String <span class="hljs-title function_">writeValue</span><span class="hljs-params">()</span> &#123;<br><br>       <span class="hljs-comment">// 创建读写锁</span><br>       <span class="hljs-type">RReadWriteLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> redisson.getReadWriteLock(<span class="hljs-string">&quot;rw-lock&quot;</span>);<br><br>       <span class="hljs-type">RLock</span> <span class="hljs-variable">rLock</span> <span class="hljs-operator">=</span> lock.writeLock();  <span class="hljs-comment">// 写锁</span><br>       <span class="hljs-type">String</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&quot;</span>;<br>       <span class="hljs-keyword">try</span> &#123;<br>           <span class="hljs-comment">// 1、改数据加写锁，读数据加读锁</span><br>           rLock.lock();  <span class="hljs-comment">// 加锁</span><br>           System.out.println(<span class="hljs-string">&quot;写锁加锁成功。。。&quot;</span> + Thread.currentThread().getId());<br><br>           s = UUID.randomUUID().toString();<br>           Thread.sleep(<span class="hljs-number">30</span> * <span class="hljs-number">1000</span>);  <span class="hljs-comment">// 等待30秒</span><br>           redisTemplate.opsForValue().set(<span class="hljs-string">&quot;writeValue&quot;</span>, s);<br>       &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>           e.printStackTrace();<br>       &#125; <span class="hljs-keyword">finally</span> &#123;<br>           rLock.unlock();  <span class="hljs-comment">// 释放锁</span><br>           System.out.println(<span class="hljs-string">&quot;写锁释放。。。&quot;</span> + Thread.currentThread().getId());<br>       &#125;<br><br>       <span class="hljs-keyword">return</span> s;<br>   &#125;<br><br>   <span class="hljs-comment">/**</span><br><span class="hljs-comment">    * 测试读写锁</span><br><span class="hljs-comment">    *</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">    */</span><br>   <span class="hljs-meta">@GetMapping(&quot;/read&quot;)</span><br>   <span class="hljs-meta">@ResponseBody</span><br>   <span class="hljs-keyword">public</span> String <span class="hljs-title function_">readValue</span><span class="hljs-params">()</span> &#123;<br>       <span class="hljs-type">RReadWriteLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> redisson.getReadWriteLock(<span class="hljs-string">&quot;rw-lock&quot;</span>);<br>       <span class="hljs-type">RLock</span> <span class="hljs-variable">rLock</span> <span class="hljs-operator">=</span> lock.readLock();  <span class="hljs-comment">// 读锁</span><br><br>       <span class="hljs-type">String</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&quot;</span>;<br>       <span class="hljs-keyword">try</span> &#123;<br>           rLock.lock();  <span class="hljs-comment">// 加锁</span><br>           System.out.println(<span class="hljs-string">&quot;读锁加锁成功。。。&quot;</span> + Thread.currentThread().getId());<br><br><br>           s = redisTemplate.opsForValue().get(<span class="hljs-string">&quot;writeValue&quot;</span>);<br>           Thread.sleep(<span class="hljs-number">30</span> * <span class="hljs-number">1000</span>);  <span class="hljs-comment">// 等待30秒</span><br>       &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>           e.printStackTrace();<br>       &#125; <span class="hljs-keyword">finally</span> &#123;<br>           rLock.unlock();<br>           System.out.println(<span class="hljs-string">&quot;读锁释放。。。&quot;</span> + Thread.currentThread().getId());<br>       &#125;<br><br>       <span class="hljs-keyword">return</span> s;<br>   &#125;<br></code></pre></td></tr></table></figure>

<h5 id="5、信号量"><a href="#5、信号量" class="headerlink" title="5、信号量"></a>5、信号量</h5><p><strong><code>RSemaphore semaphore= redisson.getSemaphore(&quot;park&quot;);   </code>  &#x2F;&#x2F; redis中key为park，值为一个数字</strong></p>
<ul>
<li><code>semaphore.acquire() </code>    &#x2F;&#x2F; 获取一个信号    &#x2F;&#x2F; 每次执行acquire方法都会使这个数字减1，到0就阻塞了<ul>
<li><code>boolean b = park.tryAcquire(); </code>    &#x2F;&#x2F; 不阻塞，不到0就返回true；到0就返回false</li>
</ul>
</li>
<li><code>park.release();  </code>       &#x2F;&#x2F; 释放一个信号      &#x2F;&#x2F; 每次执行release方法都会使这个数字 +1</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"> 	<span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 车库停车</span><br><span class="hljs-comment">     * 信号量也可以用作分布式限流</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-comment">// 停车  </span><br>    <span class="hljs-meta">@GetMapping(&quot;/park&quot;)</span><br>    <span class="hljs-meta">@ResponseBody</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">park</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>        <span class="hljs-type">RSemaphore</span> <span class="hljs-variable">park</span> <span class="hljs-operator">=</span> redisson.getSemaphore(<span class="hljs-string">&quot;park&quot;</span>);  <span class="hljs-comment">// redis中key为park，值为一个数字</span><br><span class="hljs-comment">//        park.acquire();  // 获取一个信号，获取一个值,占一个车位   // 每次执行acquire方法都会使这个数字减1，到0就阻塞了</span><br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> park.tryAcquire();  <span class="hljs-comment">// 不阻塞，不到0就返回true；到0就返回false</span><br>        <span class="hljs-keyword">if</span> (b) &#123;<br>            <span class="hljs-comment">// 执行复杂的业务</span><br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;error&quot;</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;停车成功 ok = &gt; &quot;</span> + b;<br>    &#125;<br><br>    <span class="hljs-comment">// 车开走</span><br>    <span class="hljs-meta">@GetMapping(&quot;/go&quot;)</span><br>    <span class="hljs-meta">@ResponseBody</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">go</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>        <span class="hljs-type">RSemaphore</span> <span class="hljs-variable">park</span> <span class="hljs-operator">=</span> redisson.getSemaphore(<span class="hljs-string">&quot;park&quot;</span>);<br>        park.release();  <span class="hljs-comment">// 释放一个信号，释放一个车位  // 每次执行release方法都会使这个数字 +1</span><br><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;车开走 ok&quot;</span>;<br>    &#125;<br></code></pre></td></tr></table></figure>

<h5 id="6、闭锁"><a href="#6、闭锁" class="headerlink" title="6、闭锁"></a>6、闭锁</h5><p><strong><code>RCountDownLatch door = redisson.getCountDownLatch(&quot;door&quot;);</code>  在redis中 key为door ，值为一个数字</strong></p>
<ul>
<li><code>door.trySetCount(5); </code>  &#x2F;&#x2F; 代表有5个班  &#x2F;&#x2F; 在redis中创建一条数据   door : 5</li>
<li><code>door.await();</code>    &#x2F;&#x2F; 等待闭锁都完成    &#x2F;&#x2F; 当redis中的 door变成0的时候就不阻塞了，否则就阻塞</li>
<li><code>door.countDown(); </code>   &#x2F;&#x2F; 计数 -1  闭锁</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">    * 闭锁测试</span><br><span class="hljs-comment">    * 放假锁门</span><br><span class="hljs-comment">    * 总共5个班级，全部走完了，就可以锁门</span><br><span class="hljs-comment">    */</span><br>   <span class="hljs-meta">@GetMapping(&quot;/lockDoor&quot;)</span><br>   <span class="hljs-meta">@ResponseBody</span><br>   <span class="hljs-keyword">public</span> String <span class="hljs-title function_">lockDoor</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>       <span class="hljs-type">RCountDownLatch</span> <span class="hljs-variable">door</span> <span class="hljs-operator">=</span> redisson.getCountDownLatch(<span class="hljs-string">&quot;door&quot;</span>);<br>       door.trySetCount(<span class="hljs-number">5</span>);  <span class="hljs-comment">// 代表有5个班  // 在redis中创建一条数据   door : 5</span><br>       door.await();  <span class="hljs-comment">// 等待闭锁都完成    // 当redis中的 door变成0的时候就不阻塞了，否则就阻塞</span><br><br>       <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;放假啦。。。&quot;</span>;<br>   &#125;<br><br>   <span class="hljs-meta">@GetMapping(&quot;/gogogo/&#123;id&#125;&quot;)</span><br>   <span class="hljs-meta">@ResponseBody</span><br>   <span class="hljs-keyword">public</span> String <span class="hljs-title function_">gogogo</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;id&quot;)</span> Long id)</span> &#123;<br>       <span class="hljs-type">RCountDownLatch</span> <span class="hljs-variable">door</span> <span class="hljs-operator">=</span> redisson.getCountDownLatch(<span class="hljs-string">&quot;door&quot;</span>);<br>       door.countDown();  <span class="hljs-comment">// 计数 -1    闭锁</span><br><br>       <span class="hljs-keyword">return</span> id + <span class="hljs-string">&quot;班的人都走了。。。&quot;</span>;<br>   &#125;<br></code></pre></td></tr></table></figure>

<h5 id="7、缓存数据一致性问题"><a href="#7、缓存数据一致性问题" class="headerlink" title="7、缓存数据一致性问题"></a>7、缓存数据一致性问题</h5><p><em>缓存中的数据如何和数据库保持一致 【 缓存数据一致性问题 】，有两种解决方案：</em></p>
<ul>
<li>双写模式：把数据库改完，同时修改缓存中的数据</li>
<li>* 失效模式：把数据库改完，同时删除缓存中的数据  【 <code>redis.del(&quot;catalogJSON&quot;);</code>  】 然后等待下一次查询的时候，主动更新</li>
</ul>
<h6 id="解决方案："><a href="#解决方案：" class="headerlink" title="解决方案："></a>解决方案：</h6><blockquote>
<ul>
<li>无论是双写模式还是失效模式，都会导致缓存的不一致问题，即多个实例同时更新会出事，怎么办?</li>
<li>1、如果是用户纬度数据（订单数据、用户数据），这种并发几率非常小，不用考虑这个问题，缓存数据加上过期时间，每隔一段时间触发读的主动更新即可；</li>
<li>2、如果是菜单，商品介绍等基础数据，也可以使用canal 订阅binlog 的方式；</li>
<li>* 3、缓存数据 + 过期时间 也足够解决大部分业务对于缓存的要求；</li>
<li>* 4、通过加锁保证并发读写，写写的时候按顺序排好队。读读无所谓。所以适合使用读写锁。（业务不关心脏数据，允许临时脏数据可忽略）。</li>
<li>总结：</li>
<li>我们能放入缓存的数据本就不应该是实时性、一致性要求超高的。所以缓存数据的时候加上过期时间，保证每天拿到当前最新数据即可；</li>
<li>我们不应该过度设计，增加系统的复杂性；</li>
<li>遇到实时性、一致性要求高的数据，就应该查数据库，即使慢点。</li>
</ul>
<p><strong>1、缓存的所有数据都有过期时间，数据过期下一次查询会触发主动更新；</strong></p>
<p>**2、读写数据的时候，加上分布式的读写锁。 【 少量写，大量读的时候使用读写锁 】 **</p>
</blockquote>
<h4 id="3、SpringCache"><a href="#3、SpringCache" class="headerlink" title="3、SpringCache"></a>3、SpringCache</h4><h5 id="1、简介"><a href="#1、简介" class="headerlink" title="1、简介"></a>1、简介</h5><ul>
<li>Spring从3.1开始定义了<code>org.springframework.cache.Cache</code> 和 <code>org.springframework.cache.CacheManager</code> 两个接口来统一不同的缓存技术；并支持使用JCache（JSR-107）注解简化开发； <ul>
<li><code>org.springframework.cache.Cache</code> 接口 来操作缓存中的增删改查数据</li>
<li><code>org.springframework.cache.CacheManager</code> 接口 来管理缓存</li>
</ul>
</li>
<li>Cache 接口为缓存的组件规范定义，包含缓存的各种操作集合：Cache 接口下Spring 提供了各种 xxxCache 的实现；如：RedisCache、EhCache、ConcurrentMapCache 等；</li>
<li>每次调用需要缓存功能的方法时，Spring 会检查指定参数的指定的目标方法是否已经被调用过；如果有就直接从缓存中获取方法调用后的结果，如果没有就调用方法并缓存结果后返回给用户，下次调用直接从缓存中获取；</li>
<li>使用Spring 缓存抽象时，我们需要关注以下两点：<ul>
<li>1、确定方法需要被缓存 以及它们的缓存策略</li>
<li>2、从缓存中读取之前缓存存储的数据</li>
</ul>
</li>
</ul>
<h6 id="常用注解："><a href="#常用注解：" class="headerlink" title="常用注解："></a>常用注解：</h6><ul>
<li>@Cacheable：触发 将数据保存到缓存中</li>
<li>@CacheEvict：触发 将数据从缓存中删除</li>
<li>@CachePut：触发 不影响方法执行，更新缓存</li>
<li>@Caching：触发 组合以上多个缓存操作</li>
<li>@CacheConfig：在类级别共享缓存的相同配置</li>
</ul>
<h5 id="2、整合SpringCache，简化缓存开发-【-使用redis作为缓存-】"><a href="#2、整合SpringCache，简化缓存开发-【-使用redis作为缓存-】" class="headerlink" title="2、整合SpringCache，简化缓存开发 【 使用redis作为缓存 】"></a>2、整合SpringCache，简化缓存开发 【 使用redis作为缓存 】</h5><h6 id="1、引入-spring-boot-starter-cache-依赖"><a href="#1、引入-spring-boot-starter-cache-依赖" class="headerlink" title="1、引入 spring-boot-starter-cache 依赖"></a>1、引入 <code>spring-boot-starter-cache</code> 依赖</h6><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs xml">   <span class="hljs-comment">&lt;!--整合SpringCache--&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-cache<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>   <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-comment">&lt;!--整合redis作为缓存--&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>   <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<h6 id="2、写配置"><a href="#2、写配置" class="headerlink" title="2、写配置"></a>2、写配置</h6><ul>
<li>自动配置了哪些？  【 在 <code>CacheAutoConfiguration</code> 中 】<ul>
<li>1、CacheAutoConfiguration 会导入 RedisCacheConfiguration；</li>
<li>2、RedisCacheConfiguration自动配好了CachaManager（缓存管理器）</li>
</ul>
</li>
<li>我们需要配置哪些？<ul>
<li>配置使用Redis作为缓存</li>
</ul>
</li>
</ul>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-comment">## 配置SpringCache</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"># 缓存的类型 [ 配置使用Redis作为缓存 ]</span><br><span class="hljs-attr">spring.cache.type</span>=<span class="hljs-string">redis</span><br><span class="hljs-comment"># 缓存的名字 (如果配置了缓存的名字，以后缓存的名字都按照这个来写)</span><br><span class="hljs-comment">#spring.cache.cache-names=qq,qqq</span><br><span class="hljs-comment"># 缓存的存活时间  毫秒</span><br><span class="hljs-attr">spring.cache.redis.time-to-live</span>=<span class="hljs-string">3600000</span><br><span class="hljs-comment"># 是否开启缓存key的前缀 [ 默认 true ]</span><br><span class="hljs-attr">spring.cache.redis.use-key-prefix</span>=<span class="hljs-string">true</span><br><span class="hljs-comment"># 缓存key的前缀  【 如果指定了前缀，就用指定的前缀；如果没有，就默认使用缓存的名字作为前缀 】  【 推荐默认不指定前缀 】</span><br><span class="hljs-comment">#spring.cache.redis.key-prefix=CACHE_</span><br><span class="hljs-comment"># 是否缓存空值 【 防止缓存穿透 】</span><br><span class="hljs-attr">spring.cache.redis.cache-null-values</span>=<span class="hljs-string">true</span><br></code></pre></td></tr></table></figure>

<h6 id="3、测试使用缓存"><a href="#3、测试使用缓存" class="headerlink" title="3、测试使用缓存"></a>3、测试使用缓存</h6><h6 id="3-1、开启缓存功能"><a href="#3-1、开启缓存功能" class="headerlink" title="3.1、开启缓存功能"></a>3.1、开启缓存功能</h6><p>在启动类上加上注解 <code>@EnableCaching  </code> 开启缓存功能</p>
<h6 id="3-2、只需要使用注解就能完成缓存操作"><a href="#3-2、只需要使用注解就能完成缓存操作" class="headerlink" title="3.2、只需要使用注解就能完成缓存操作"></a>3.2、只需要使用注解就能完成缓存操作</h6><p>在方法上加上注解</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">     *  1、每一个需要缓存的数据，都来指定要放到哪个名字的缓存 【 缓存的分区（按照业务类型分） 】</span><br><span class="hljs-comment">     *  2、代表当前方法的结果需要缓存，</span><br><span class="hljs-comment">     *      1）如果缓存中有，方法就不用调用了，直接从缓存中拿数据；</span><br><span class="hljs-comment">     *      2）如果缓存中没有，就查出真实数据（方法的结果）放到缓存中</span><br><span class="hljs-comment">     *  3、<span class="hljs-doctag">@Cacheable</span> 注解的默认行为</span><br><span class="hljs-comment">     *      1）、如果缓存中有，方法就不用调用了，直接从缓存中拿数据；</span><br><span class="hljs-comment">     *      2）、缓存的key默认格式    缓存的名字::SimpleKey []</span><br><span class="hljs-comment">     *      3）、缓存的value的值     默认使用jdk序列化机制将序列化后的数据存到redis</span><br><span class="hljs-comment">     *      4）、默认ttl时间是 -1  代表永不过期</span><br><span class="hljs-comment">     *    自定义操作：</span><br><span class="hljs-comment">     *      1）、指定生成的缓存使用的key  【 key属性，接收一个spEl表达式 】</span><br><span class="hljs-comment">     *          spEl的详细语法：https://docs.spring.io/spring-framework/docs/5.3.31/reference/html/integration.html#cache-spel-context</span><br><span class="hljs-comment">     *      2）、指定缓存的数据的存活时间  【 在配置文件中修改ttl  spring.cache.redis.time-to-live=3600000 】</span><br><span class="hljs-comment">     *      3）、将数据保存为JSON格式  【  】</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Cacheable(value = &#123;&quot;category&quot;&#125;,key = &quot;#root.method.name&quot;)</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> List&lt;CategoryEntity&gt; <span class="hljs-title function_">getLevel1Categorys</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;CategoryServiceImpl.getLevel1Categorys&quot;</span>);<br>        <span class="hljs-type">long</span> <span class="hljs-variable">start</span> <span class="hljs-operator">=</span> System.currentTimeMillis();<br>        List&lt;CategoryEntity&gt; entities = baseMapper.selectList(<span class="hljs-keyword">new</span> <span class="hljs-title class_">QueryWrapper</span>&lt;CategoryEntity&gt;().eq(<span class="hljs-string">&quot;parent_cid&quot;</span>, <span class="hljs-number">0</span>));<br>        <span class="hljs-type">long</span> <span class="hljs-variable">end</span> <span class="hljs-operator">=</span> System.currentTimeMillis();<br><span class="hljs-comment">//        System.out.println(&quot;消耗时间： &quot; + (end - start));</span><br>        <span class="hljs-keyword">return</span> entities;<br>    &#125;<br></code></pre></td></tr></table></figure>

<h6 id="3-3、将数据保存为JSON格式"><a href="#3-3、将数据保存为JSON格式" class="headerlink" title="3.3、将数据保存为JSON格式"></a>3.3、将数据保存为JSON格式</h6><p><strong>配置一个Bean：    <code>RedisCacheConfiguration</code></strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.alibaba.fastjson.support.spring.GenericFastJsonRedisSerializer;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.boot.autoconfigure.cache.CacheProperties;<br><span class="hljs-keyword">import</span> org.springframework.boot.context.properties.EnableConfigurationProperties;<br><span class="hljs-keyword">import</span> org.springframework.cache.annotation.EnableCaching;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><span class="hljs-keyword">import</span> org.springframework.data.redis.cache.RedisCacheConfiguration;<br><span class="hljs-keyword">import</span> org.springframework.data.redis.serializer.RedisSerializationContext;<br><span class="hljs-keyword">import</span> org.springframework.data.redis.serializer.StringRedisSerializer;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> taoao</span><br><span class="hljs-comment"> * 自定义缓存配置</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@EnableCaching</span>  <span class="hljs-comment">// 开启缓存功能</span><br><span class="hljs-meta">@EnableConfigurationProperties(CacheProperties.class)</span>  <span class="hljs-comment">// 开启属性配置的绑定功能</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyCacheConfig</span> &#123;<br><br>    <span class="hljs-comment">// 方法1，自动注入； 方法2：写道方法参数上</span><br><span class="hljs-comment">//    @Autowired</span><br><span class="hljs-comment">//    CacheProperties cacheProperties;</span><br><br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * application.properties 配置文件中的东西没有用上</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span><br>    RedisCacheConfiguration <span class="hljs-title function_">redisCacheConfiguration</span><span class="hljs-params">(CacheProperties cacheProperties)</span> &#123;<br>        <span class="hljs-type">RedisCacheConfiguration</span> <span class="hljs-variable">config</span> <span class="hljs-operator">=</span> RedisCacheConfiguration.defaultCacheConfig();<br>        <span class="hljs-comment">// 设置key为String</span><br>        config = config.serializeKeysWith(RedisSerializationContext.SerializationPair.fromSerializer(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringRedisSerializer</span>()));<br>        <span class="hljs-comment">// 设置value为JSON</span><br>        config = config.serializeValuesWith(RedisSerializationContext.SerializationPair.fromSerializer(<span class="hljs-keyword">new</span> <span class="hljs-title class_">GenericFastJsonRedisSerializer</span>()));<br><br>        CacheProperties.<span class="hljs-type">Redis</span> <span class="hljs-variable">redisProperties</span> <span class="hljs-operator">=</span> cacheProperties.getRedis();<br>        <span class="hljs-comment">// 将配置文件中的所有配置都生效</span><br>        <span class="hljs-keyword">if</span> (redisProperties.getTimeToLive() != <span class="hljs-literal">null</span>) &#123;<br>            config = config.entryTtl(redisProperties.getTimeToLive());<br>        &#125;<br>        <span class="hljs-keyword">if</span> (redisProperties.getKeyPrefix() != <span class="hljs-literal">null</span>) &#123;<br>            config = config.prefixKeysWith(redisProperties.getKeyPrefix());<br>        &#125;<br>        <span class="hljs-keyword">if</span> (!redisProperties.isCacheNullValues()) &#123;<br>            config = config.disableCachingNullValues();<br>        &#125;<br>        <span class="hljs-keyword">if</span> (!redisProperties.isUseKeyPrefix()) &#123;<br>            config = config.disableKeyPrefix();<br>        &#125;<br><br><br>        <span class="hljs-keyword">return</span> config;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h6 id="3-4、删除缓存操作"><a href="#3-4、删除缓存操作" class="headerlink" title="3.4、删除缓存操作"></a>3.4、删除缓存操作</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@CacheEvict</span> 缓存失效模式的使用 【 当有更新操作时，删除原来的缓存 】 ,指定区域value，指定key就是查询数据时的key，也就是方法名字</span><br><span class="hljs-comment">     * &lt;p&gt;</span><br><span class="hljs-comment">     * 同时进行多种缓存操作</span><br><span class="hljs-comment">     * 方法1：同时进行多种缓存操作  <span class="hljs-doctag">@Caching</span>(evict = &#123;</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@CacheEvict</span>(value = &#123;&quot;category&quot;&#125;, key = &quot;&#x27;getLevel1Categorys&#x27;&quot;),</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@CacheEvict</span>(value = &#123;&quot;category&quot;&#125;,key = &quot;&#x27;getCatalogJson&#x27;&quot;)</span><br><span class="hljs-comment">     * &#125;)</span><br><span class="hljs-comment">     * 方法2：指定删除某个分区中的所有数据  <span class="hljs-doctag">@CacheEvict</span>(value = &quot;category&quot;,allEntries = true)  【 allEntries = true  删除category 分区中的所有数据 】</span><br><span class="hljs-comment">     * &lt;p&gt;</span><br><span class="hljs-comment">     * 存储同一类型的数据，都可以指定成同一个分区。</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Transactional</span><br>    <span class="hljs-meta">@Override</span><br><span class="hljs-comment">//    @CacheEvict(value = &#123;&quot;category&quot;&#125;, key = &quot;&#x27;getLevel1Categorys&#x27;&quot;)  // 删除缓存</span><br><span class="hljs-comment">//    @Caching(evict = &#123;</span><br><span class="hljs-comment">//            @CacheEvict(value = &#123;&quot;category&quot;&#125;, key = &quot;&#x27;getLevel1Categorys&#x27;&quot;),</span><br><span class="hljs-comment">//            @CacheEvict(value = &#123;&quot;category&quot;&#125;,key = &quot;&#x27;getCatalogJson&#x27;&quot;)</span><br><span class="hljs-comment">//    &#125;)</span><br>    <span class="hljs-meta">@CacheEvict(value = &quot;category&quot;, allEntries = true)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateCascade</span><span class="hljs-params">(CategoryEntity category)</span> &#123;<br>        <span class="hljs-built_in">this</span>.updateById(category);<br>        categoryBrandRelationService.updateCategory(category.getCatId(), category.getName());<br><br>        <span class="hljs-comment">// 双写模式：把数据库改完，同时修改缓存中的数据</span><br>        <span class="hljs-comment">// 失效模式：把数据库改完，同时删除缓存中的数据  redis.del(&quot;catalogJSON&quot;);  然后等待下一次查询的时候，主动更新</span><br>    &#125;<br></code></pre></td></tr></table></figure>

<h5 id="3、-、SpringCache的特点"><a href="#3、-、SpringCache的特点" class="headerlink" title="3、 、SpringCache的特点"></a>3、 、SpringCache的特点</h5><blockquote>
<p>1、读模式：</p>
<ul>
<li>缓存穿透：查询一个永不存在的数据。 解决：缓存空数据</li>
<li>缓存击穿：大量并发进来同时查询一个正好过期的数据。 解决：加锁  【 SpringCache默认是没有加锁的 （@Cacheable注解可以通过设置sync属性&#x3D;true加锁） 】</li>
<li>@Cacheable(value &#x3D; {“category”}, key &#x3D; “#root.method.name”, sync &#x3D; true）</li>
<li>缓存雪崩：大量key同时过期。 解决：加随机时间；指定过期时间就行。</li>
</ul>
<p>2、写模式：（缓存与数据库一致）<br>   1、读写加锁。（适用于读多写少的系统）<br>   2、引入Canal中间件。感知到MySQL的更新去更新缓存<br>   3、读多写多的直接去数据库查询<br><strong>原理：</strong><br>SpringCache中有一个CacheManager缓存管理器；  【 比如RedisCacheManager 】<br>缓存管理器可以造出很多的缓存组件Cache；  【 比如RedisCache 】<br>缓存组件负责缓存的读写；<br><strong>总结：</strong></p>
<ul>
<li>常规数据（读多写少，即时性和一致性要求不高的数据）可以使用SpringCache；写模式（只要缓存的数据有过期时间就足够了）</li>
<li>特殊数据：特殊设计</li>
</ul>
</blockquote>
<h3 id="八、异步-线程池-（JUC）"><a href="#八、异步-线程池-（JUC）" class="headerlink" title="八、异步 &amp; 线程池 （JUC）"></a>八、异步 &amp; 线程池 （JUC）</h3><h4 id="1、线程"><a href="#1、线程" class="headerlink" title="1、线程"></a>1、线程</h4><p><strong>将所有的多线程异步任务都交给线程池执行</strong></p>
<h5 id="1、初始化线程的4种方式"><a href="#1、初始化线程的4种方式" class="headerlink" title="1、初始化线程的4种方式"></a>1、初始化线程的4种方式</h5><blockquote>
<ul>
<li><p>1）、继承Thread</p>
</li>
<li><p>测试代码：</p>
</li>
</ul>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>    System.out.println(<span class="hljs-string">&quot;main...start...&quot;</span>);<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * - 1）、继承Thread</span><br><span class="hljs-comment">     * - 2）、实现Runnable接口</span><br><span class="hljs-comment">     * - 3）、实现Callable 接口 + FutureTask（可以拿到返回结果，可以处理异常）</span><br><span class="hljs-comment">     * - 4）、线程池</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-type">Thread01</span> <span class="hljs-variable">thread</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread01</span>();<br>    thread.start();  <span class="hljs-comment">// 启动线程</span><br><br>    System.out.println(<span class="hljs-string">&quot;main...end...&quot;</span>);<br><br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 1）、继承Thread</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Thread01</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Thread</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;当前线程： &quot;</span> + Thread.currentThread().getId());<br>        <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">10</span> / <span class="hljs-number">2</span>;<br>        System.out.println(<span class="hljs-string">&quot;运行结果：&quot;</span> + i);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>运行结果：</li>
</ul>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">main...start...<br>main...end...<br>当前线程： <span class="hljs-number">12</span><br>运行结果：<span class="hljs-number">5</span><br></code></pre></td></tr></table></figure>

<ul>
<li><p>2）、实现Runnable接口</p>
</li>
<li><p>测试代码：</p>
</li>
</ul>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>       System.out.println(<span class="hljs-string">&quot;main...start...&quot;</span>);<br>       <span class="hljs-comment">/**</span><br><span class="hljs-comment">        * - 1）、继承Thread</span><br><span class="hljs-comment">        *         Thread01 thread = new Thread01();</span><br><span class="hljs-comment">        *         thread.start();  // 启动线程</span><br><span class="hljs-comment">        * - 2）、实现Runnable接口</span><br><span class="hljs-comment">        * - 3）、实现Callable 接口 + FutureTask（可以拿到返回结果，可以处理异常）</span><br><span class="hljs-comment">        * - 4）、线程池</span><br><span class="hljs-comment">        */</span><br><br>       <span class="hljs-type">Runnable01</span> <span class="hljs-variable">runnable01</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Runnable01</span>();<br>       <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(runnable01).start();<br><br>       System.out.println(<span class="hljs-string">&quot;main...end...&quot;</span>);<br><br>   &#125;<br><br>   <span class="hljs-comment">/**</span><br><span class="hljs-comment">    * 2）、实现Runnable接口</span><br><span class="hljs-comment">    */</span><br>   <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Runnable01</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Runnable</span> &#123;<br>       <span class="hljs-meta">@Override</span><br>       <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>           System.out.println(<span class="hljs-string">&quot;当前线程： &quot;</span> + Thread.currentThread().getId());<br>           <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">10</span> / <span class="hljs-number">2</span>;<br>           System.out.println(<span class="hljs-string">&quot;Runnable01运行结果：&quot;</span> + i);<br>       &#125;<br>   &#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>运行结果</li>
</ul>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">main...start...<br>main...end...<br>当前线程： <span class="hljs-number">12</span><br>Runnable01运行结果：<span class="hljs-number">5</span><br></code></pre></td></tr></table></figure>

<ul>
<li><p>3）、实现Callable 接口 + FutureTask（可以拿到返回结果，可以处理异常）</p>
</li>
<li><p>测试代码：</p>
</li>
</ul>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ExecutionException, InterruptedException &#123;<br>       System.out.println(<span class="hljs-string">&quot;main...start...&quot;</span>);<br>       <span class="hljs-comment">/**</span><br><span class="hljs-comment">        * - 1）、继承Thread</span><br><span class="hljs-comment">        *         Thread01 thread = new Thread01();</span><br><span class="hljs-comment">        *         thread.start();  // 启动线程</span><br><span class="hljs-comment">        *</span><br><span class="hljs-comment">        * - 2）、实现Runnable接口</span><br><span class="hljs-comment">        *         Runnable01 runnable01 = new Runnable01();</span><br><span class="hljs-comment">        *         new Thread(runnable01).start();</span><br><span class="hljs-comment">        *</span><br><span class="hljs-comment">        * - 3）、实现Callable 接口 + FutureTask（可以拿到返回结果，可以处理异常）</span><br><span class="hljs-comment">        * - 4）、线程池</span><br><span class="hljs-comment">        */</span><br></code></pre></td></tr></table></figure>


<pre><code class="hljs">     FutureTask&lt;Integer&gt; futureTask = new FutureTask&lt;&gt;(new Callable01());
     new Thread(futureTask).start();
                   
     // get() 方法的作用是： 阻塞等待整个线程执行完成，获取返回结果
     Integer res = futureTask.get();
     System.out.println(&quot;res = &quot; + res);
                   
     System.out.println(&quot;main...end...&quot;);
                   
 &#125;
                   
 /**
  * 3）、实现Callable 接口 + FutureTask（可以拿到返回结果，可以处理异常）
  * public static class Callable01 implements Callable&lt;Integer&gt;   这里的泛型指的是返回值的类型
  */
 public static class Callable01 implements Callable&lt;Integer&gt; &#123;
                   
     @Override
     public Integer call() throws Exception &#123;
         System.out.println(&quot;当前线程： &quot; + Thread.currentThread().getId());
         int i = 10 / 2;
         System.out.println(&quot;Callable01运行结果：&quot; + i);
         return i;
     &#125;
 &#125;
</code></pre>
 <figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs stylus">&gt;- 运行结果：<br><br> ```java<br> <span class="hljs-selector-tag">main</span>..<span class="hljs-selector-class">.start</span>...<br> 当前线程： <span class="hljs-number">12</span><br> Callable01运行结果：<span class="hljs-number">5</span><br> res = <span class="hljs-number">5</span><br> <span class="hljs-selector-tag">main</span>..<span class="hljs-selector-class">.end</span>...<br></code></pre></td></tr></table></figure>

<ul>
<li><p><strong>4）、线程池</strong></p>
</li>
<li><p>测试代码：</p>
</li>
</ul>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ExecutionException, InterruptedException &#123;<br>        System.out.println(<span class="hljs-string">&quot;main...start...&quot;</span>);<br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * - 1）、继承Thread</span><br><span class="hljs-comment">         *         Thread01 thread = new Thread01();</span><br><span class="hljs-comment">         *         thread.start();  // 启动线程</span><br><span class="hljs-comment">         *</span><br><span class="hljs-comment">         * - 2）、实现Runnable接口</span><br><span class="hljs-comment">         *         Runnable01 runnable01 = new Runnable01();</span><br><span class="hljs-comment">         *         new Thread(runnable01).start();</span><br><span class="hljs-comment">         *</span><br><span class="hljs-comment">         * - 3）、实现Callable 接口 + FutureTask（可以拿到返回结果，可以处理异常）</span><br><span class="hljs-comment">         *         FutureTask&lt;Integer&gt; futureTask = new FutureTask&lt;&gt;(new Callable01());</span><br><span class="hljs-comment">         *         new Thread(futureTask).start();</span><br><span class="hljs-comment">         *         // get() 方法的作用是： 阻塞等待整个线程执行完成，获取返回结果</span><br><span class="hljs-comment">         *         Integer res = futureTask.get();</span><br><span class="hljs-comment">         *         System.out.println(&quot;res = &quot; + res);</span><br><span class="hljs-comment">         *</span><br><span class="hljs-comment">         * - 4）、线程池</span><br><span class="hljs-comment">         *      给线程池直接提交任务。</span><br><span class="hljs-comment">         */</span><br><br>        <span class="hljs-comment">// 当前系统中线程池只有一个，每个异步任务提交给线程池，让它自己去执行</span><br>        <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executorService</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(<span class="hljs-number">10</span>);<br><br>        <span class="hljs-comment">// executorService.execute(new Runnable01());</span><br>        Future&lt;Integer&gt; future = executorService.submit(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Callable01</span>());<br>        <span class="hljs-type">Integer</span> <span class="hljs-variable">res</span> <span class="hljs-operator">=</span> future.get();<br>        System.out.println(<span class="hljs-string">&quot;res = &quot;</span> + res);<br><br>        System.out.println(<span class="hljs-string">&quot;main...end...&quot;</span>);<br><br>    &#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>运行结果：</li>
</ul>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">main...start...<br>当前线程： <span class="hljs-number">12</span><br>Callable01运行结果：<span class="hljs-number">5</span><br>res = <span class="hljs-number">5</span><br>main...end...<br></code></pre></td></tr></table></figure>

<p><strong>区别：</strong></p>
<ul>
<li>1、2方式不能得到返回值。3可以得到返回值</li>
<li>1、2、3 都不能达到资源控制的效果</li>
<li><strong>4 可以控制资源， 好处：性能稳定。</strong></li>
</ul>
</blockquote>
<p>方式1和方式2：主进程无法获取线程的运算结果</p>
<p>方式3：主进程可以获取线程的运算结果，但是不利于控制服务器种的线程资源。可能导致服务器资源耗尽</p>
<p>方式4：通过以下两种方式初始化线程池</p>
<ul>
<li><pre><code class="java">Executors.newFiexedThreadPool(3);
// 或者
new ThreadPoolExecutor(corePoolSize, maximumPoolSize, keepAliveTime, TimeUnit unit, workQueue, threadFactory, handler);
<figure class="highlight node-repl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs node-repl"><br>**通过线程池性能稳定，也可以获取执行结果，并捕获异常。但是，在业务复杂情况下，一个异步调用可能会依赖于另一个异步调用的执行结果。	**<br><br>##### 2、线程池<br><br>###### 1、创建线程池的两种方式<br><br>- 方式1）、`Executors` 工具类<br>- 方式2）、原生方式：`ThreadPoolExecutor executor = new ThreadPoolExecutor()`<br><br><span class="hljs-meta prompt_">&gt;</span> <span class="language-javascript"><span class="hljs-string">`ThreadPoolExecutor executor = new ThreadPoolExecutor( 有7个参数 );`</span></span><br><span class="hljs-meta prompt_">&gt;</span><br><span class="hljs-meta prompt_">&gt;</span> <span class="language-javascript"><span class="hljs-string">``</span><span class="hljs-string">`java</span></span><br><span class="hljs-meta prompt_">&gt;</span> <span class="language-javascript"><span class="hljs-string">ThreadPoolExecutor executor = new ThreadPoolExecutor(5,  // 核心线程数量5</span></span><br><span class="hljs-meta prompt_">&gt;</span> <span class="language-javascript"><span class="hljs-string">  200,    //最大线程数量200</span></span><br><span class="hljs-meta prompt_">&gt;</span> <span class="language-javascript"><span class="hljs-string">  10,  // 最大存活时间10秒</span></span><br><span class="hljs-meta prompt_">&gt;</span> <span class="language-javascript"><span class="hljs-string">  TimeUnit.SECONDS,</span></span><br><span class="hljs-meta prompt_">&gt;</span> <span class="language-javascript"><span class="hljs-string">  new LinkedBlockingQueue&lt;&gt;(100000),  // new LinkedBlockingQueue&lt;&gt;() 这个队列默认可以保存Integer的最大值个线程，可能会导致系统内存不够，需要指定数量</span></span><br><span class="hljs-meta prompt_">&gt;</span> <span class="language-javascript"><span class="hljs-string">  Executors.defaultThreadFactory(),  // 默认的线程工厂</span></span><br><span class="hljs-meta prompt_">&gt;</span> <span class="language-javascript"><span class="hljs-string">  new ThreadPoolExecutor.AbortPolicy());  // 丢弃策略</span></span><br></code></pre></td></tr></table></figure>
&gt;
&gt; - **7大参数：**
&gt; - `int corePoolSize`,
&gt;   - 核心线程数【只要线程池不销毁就会一直存在】（线程池创建好以后就准备就绪的线程数量，就等待来接收异步任务去执行）   相当于new了 n 个Thread
&gt; - `int maximumPoolSize`,
&gt;   - 最大线程数量；控制资源
&gt; - `long keepAliveTime`,
&gt;   - 存活时间；如果当前的线程数量大于核心线程数量。  只要线程空闲大于指定的存活时间，就释放空闲的线程（最大线程数量-核心线程数 超出线程数的线程的存活时间 ）
&gt; - `TimeUnit unit`,
&gt;   - 存活时间的单位
&gt; - `BlockingQueue&lt;Runnable&gt; workQueue`,
&gt;   - 阻塞队列。如果任务有很多，比最大线程数量还多，多余出来的任务就会放在阻塞队列中，只要有线程空闲了，就会从阻塞队列中取出来新的任务继续执行
&gt; - `ThreadFactory threadFactory`,
&gt;   - 线程的创建工厂。
&gt; - `RejectedExecutionHandler handler`
&gt;   - 如果阻塞队列满了，按照指定的拒绝策略拒绝执行任务
&gt;
&gt; **运行流程：**
&gt;
&gt; - 1、线程池创建，准备好**core数量**的核心线程，准备接受任务。
&gt; - 2、新的任务进来，用**core**准备好的空闲线程执行。
&gt;   - 1）、**core**满了，就将再进来的任务放入**阻塞队列**中。空闲的**core**就会自己去**阻塞队列**获取任务执行；
&gt;   - 2）、**阻塞队列**满了，就直接开新线程执行，最大只能开到**max指定的数量**；
&gt;   - 3）、**max**都执行好了，**max**减去**core**数量空闲的线程会在**存活时间**指定的时间后自动销毁。最终保持在**core**大小；
&gt;   - 4）、如果线程开到了**max**的数量，还有新任务进来，就会使用**reject**指定的拒绝策略进行处理
&gt; - 3、所有的线程创建都是由指定的**factory**创建的。
&gt;
&gt; **面试的列子：**一个线程池 core 7 、max 20 、 queue 50 ， 100个并发进来是怎么分配的？
&gt;
&gt; - 7个线程立即执行，50个进入队列，再开13个新线程，剩下的30个默认拒绝策略。
&gt; - 如果不想抛弃多余的并发，可以使用CallerRunsPolicy策略，去同步执行run方法，而不是异步new Thread去执行start方法
</code></pre>
</li>
</ul>
<h5 id="3、常见的线程池"><a href="#3、常见的线程池" class="headerlink" title="3、常见的线程池"></a>3、常见的线程池</h5><ul>
<li><code>newCachedThreadPool</code><ul>
<li>创建一个可缓存的线程池，如果线程池长度超过处理的需要，可灵活回收空闲线程；如果没有可回收的，就创建新线程。</li>
</ul>
</li>
<li><code>newFixedThreadPool</code><ul>
<li>创建一个定长的线程池，可以控制线程的最大并发数，超出的线程会在队列中等待。</li>
</ul>
</li>
<li><code>newScheduledThreadPool</code><ul>
<li>创建一个定长的线程池，支持定时及周期性任务执行。</li>
</ul>
</li>
<li><code>newSingleThreadExecutor</code><ul>
<li>创建一个单线程化的线程池，它只会用唯一的工作线程来执行任务，保证所有任务挨个执行。</li>
</ul>
</li>
</ul>
<h5 id="4、开发中为什么使用线程池"><a href="#4、开发中为什么使用线程池" class="headerlink" title="4、开发中为什么使用线程池"></a>4、开发中为什么使用线程池</h5><blockquote>
<ul>
<li>降低资源的消耗</li>
<li>通过重复利用已经创建好的线程降低线程的创建和销毁带来的损耗</li>
<li>提高响应速度</li>
<li>因为线程池中的线程数没有超过线程池的最大上限时，有的线程处于等待分配任务的状态，当任务来时无需创建新的线程就能执行</li>
<li>提高线程的可管理性</li>
<li>线程池会根据当前系统的特点对池内的线程进行优化处理，减少创建和销毁线程带来的系统开销。无限的创建和销毁线程不仅消耗系统资源，还降低系统的稳定性，使用线程池进行统一分配。</li>
</ul>
</blockquote>
<h4 id="2、CompletableFuture-异步编排"><a href="#2、CompletableFuture-异步编排" class="headerlink" title="2、CompletableFuture 异步编排"></a>2、CompletableFuture 异步编排</h4><h5 id="1、创建异步对象"><a href="#1、创建异步对象" class="headerlink" title="1、创建异步对象"></a>1、创建异步对象</h5><p><strong>CompletableFuture 提供了四个静态方法来创建一个异步操作。</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> CompletableFuture&lt;Void&gt; <span class="hljs-title function_">runAsync</span><span class="hljs-params">(Runnable runnable)</span><br><br>   <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> CompletableFuture&lt;Void&gt; <span class="hljs-title function_">runAsync</span><span class="hljs-params">(Runnable runnable, Executor executor)</span><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;U&gt; CompletableFuture&lt;U&gt; <span class="hljs-title function_">supplyAsync</span><span class="hljs-params">(Supplier&lt;U&gt; supplier)</span><br><br>   <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;U&gt; CompletableFuture&lt;U&gt; <span class="hljs-title function_">supplyAsync</span><span class="hljs-params">(Supplier&lt;U&gt; supplier, Executor executor)</span><br></code></pre></td></tr></table></figure>

<ul>
<li>1、runAsync 都是没有返回结果的；supplyAsync 都是可以获取返回结果的；</li>
<li>2、可以传入自定义的线程池，否则就用默认的线程池；</li>
</ul>
<h6 id="1、runAsync-测试"><a href="#1、runAsync-测试" class="headerlink" title="1、runAsync 测试"></a>1、runAsync 测试</h6><ul>
<li><p>测试代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(<span class="hljs-number">10</span>);<br>  <br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>  <br>    System.out.println(<span class="hljs-string">&quot;main...start...&quot;</span>);<br>  <br>    CompletableFuture&lt;Void&gt; future = CompletableFuture.runAsync(() -&gt; &#123;<br>        System.out.println(<span class="hljs-string">&quot;当前线程 : &quot;</span> + Thread.currentThread().getId());<br>        <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">10</span> / <span class="hljs-number">2</span>;<br>        System.out.println(<span class="hljs-string">&quot;运行结果 ： &quot;</span> + i);<br>    &#125;, executor);<br>  <br>    System.out.println(<span class="hljs-string">&quot;main...end...&quot;</span>);<br>  <br>&#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p>测试结果：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">main...start...<br>main...end...<br>当前线程 : <span class="hljs-number">12</span>  <br>运行结果 ： <span class="hljs-number">5</span><br></code></pre></td></tr></table></figure></li>
</ul>
<h6 id="2、supplyAsync-测试"><a href="#2、supplyAsync-测试" class="headerlink" title="2、supplyAsync 测试"></a>2、supplyAsync 测试</h6><ul>
<li><p>测试代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(<span class="hljs-number">10</span>);<br>  <br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ExecutionException, InterruptedException &#123;<br>  <br>    System.out.println(<span class="hljs-string">&quot;main...start...&quot;</span>);<br>  <br>    CompletableFuture&lt;Integer&gt; future = CompletableFuture.supplyAsync(() -&gt; &#123;<br>        System.out.println(<span class="hljs-string">&quot;当前线程 : &quot;</span> + Thread.currentThread().getId());<br>        <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">10</span> / <span class="hljs-number">2</span>;<br>        System.out.println(<span class="hljs-string">&quot;运行结果 ： &quot;</span> + i);<br>        <span class="hljs-keyword">return</span> i;<br>    &#125;, executor);<br>  <br>    System.out.println(<span class="hljs-string">&quot;future.get() = &quot;</span> + future.get());<br>  <br>    System.out.println(<span class="hljs-string">&quot;main...end...&quot;</span>);<br>  <br>&#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p>测试结果：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">main...start...<br>当前线程 : <span class="hljs-number">12</span><br>运行结果 ： <span class="hljs-number">5</span><br>future.get() = <span class="hljs-number">5</span><br>main...end...<br></code></pre></td></tr></table></figure></li>
</ul>
<h5 id="2、计算完成时回调方法"><a href="#2、计算完成时回调方法" class="headerlink" title="2、计算完成时回调方法"></a>2、计算完成时回调方法</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> CompletableFuture&lt;T&gt; <span class="hljs-title function_">whenComplete</span><span class="hljs-params">(BiConsumer&lt;? <span class="hljs-built_in">super</span> T, ? <span class="hljs-built_in">super</span> Throwable&gt; action)</span><br>        <br><span class="hljs-keyword">public</span> CompletableFuture&lt;T&gt; <span class="hljs-title function_">whenCompleteAsync</span><span class="hljs-params">(BiConsumer&lt;? <span class="hljs-built_in">super</span> T, ? <span class="hljs-built_in">super</span> Throwable&gt; action)</span><br>    <br><span class="hljs-keyword">public</span> CompletableFuture&lt;T&gt; <span class="hljs-title function_">whenCompleteAsync</span><span class="hljs-params">(BiConsumer&lt;? <span class="hljs-built_in">super</span> T, ? <span class="hljs-built_in">super</span> Throwable&gt; action, Executor executor)</span><br><br><span class="hljs-keyword">public</span> CompletableFuture&lt;T&gt; <span class="hljs-title function_">exceptionally</span><span class="hljs-params">(Function&lt;Throwable, ? extends T&gt; fn)</span><br></code></pre></td></tr></table></figure>

<ul>
<li>whenComplete 可以处理正常和异常的计算结果，exceptionally 处理异常情况。</li>
<li>whenComplete 和 whenCompelteAsync 的区别：<ul>
<li>whenComplete：是执行当前任务的线程 继续执行whenComplete的任务</li>
<li>whenCompleteAsync：是执行把whenCompleteAsync 这个任务继续提交给线程池来进行执行</li>
</ul>
</li>
<li><strong>方法不以Async结尾，意味着Action使用相同的线程执行；</strong></li>
<li><strong>而Async 可能会使用其他线程执行（如果是使用相同的线程池，也可能会被同一个线程选中执行）</strong></li>
</ul>
<h6 id="1、测试代码"><a href="#1、测试代码" class="headerlink" title="1、测试代码"></a>1、测试代码</h6><ul>
<li><pre><code class="java">    public static ExecutorService executor = Executors.newFixedThreadPool(10);

    public static void main(String[] args) throws ExecutionException, InterruptedException &#123;

        System.out.println(&quot;main...start...&quot;);

        CompletableFuture&lt;Integer&gt; future = CompletableFuture.supplyAsync(() -&gt; &#123;
            System.out.println(&quot;当前线程 : &quot; + Thread.currentThread().getId());
            int i = 10 / 0;
            System.out.println(&quot;运行结果 ： &quot; + i);
            return i;
        &#125;, executor).whenComplete((res, exc) -&gt; &#123;
            // 虽然能得到异常信息，但是没法修改返回数据 （类似于监听器）
            System.out.println(&quot;异步任务成功完成了。。。结果是：&quot; + res + &quot; ; 异常是：&quot; + exc);
        &#125;).exceptionally(throwable -&gt; &#123;
            // 可以感知异常，同时返回默认值
            return 10;
        &#125;);
        //  如果出现异常，那么 exceptionally 方法的返回值，就是这里的返回值
        System.out.println(&quot;future.get() = &quot; + future.get());
        
        System.out.println(&quot;main...end...&quot;);
    &#125;
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs livecodeserver"><br>- ```java<br>  main...<span class="hljs-built_in">start</span>...<br>  当前线程 : <span class="hljs-number">12</span><br>  异步任务成功完成了。。。结果是：<span class="hljs-literal">null</span> ; 异常是：java.util.concurrent.CompletionException: java.lang.ArithmeticException: / <span class="hljs-keyword">by</span> <span class="hljs-literal">zero</span><br>  future.<span class="hljs-built_in">get</span>() = <span class="hljs-number">10</span><br>  main...<span class="hljs-keyword">end</span>...<br></code></pre></td></tr></table></figure>
</code></pre>
</li>
</ul>
<h5 id="3、handle-方法"><a href="#3、handle-方法" class="headerlink" title="3、handle 方法"></a>3、handle 方法</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> &lt;U&gt; CompletableFuture&lt;U&gt; <span class="hljs-title function_">handle</span><span class="hljs-params">(BiFunction&lt;? <span class="hljs-built_in">super</span> T, Throwable, ? extends U&gt; fn)</span><br><br><span class="hljs-keyword">public</span> &lt;U&gt; CompletableFuture&lt;U&gt; <span class="hljs-title function_">handleAsync</span><span class="hljs-params">(BiFunction&lt;? <span class="hljs-built_in">super</span> T, Throwable, ? extends U&gt; fn)</span> <br><br><span class="hljs-keyword">public</span> &lt;U&gt; CompletableFuture&lt;U&gt; <span class="hljs-title function_">handleAsync</span><span class="hljs-params">(BiFunction&lt;? <span class="hljs-built_in">super</span> T, Throwable, ? extends U&gt; fn, Executor executor)</span><br></code></pre></td></tr></table></figure>

<p><strong>和completef方法一样，可对结果做最后的处理（可处理异常），可改变返回值。</strong></p>
<h6 id="1、测试代码-1"><a href="#1、测试代码-1" class="headerlink" title="1、测试代码"></a>1、测试代码</h6><ul>
<li><pre><code class="java">public static ExecutorService executor = Executors.newFixedThreadPool(10);

    public static void main(String[] args) throws ExecutionException, InterruptedException &#123;

        System.out.println(&quot;main...start...&quot;);

        //handle方法  方法执行完成后的**处理**（无论是成功完成还是失败完成）
        CompletableFuture&lt;Integer&gt; future = CompletableFuture.supplyAsync(() -&gt; &#123;
            System.out.println(&quot;当前线程：&quot; + Thread.currentThread().getId());
            int i = 10 / 0;
            System.out.println(&quot;运行结果：&quot; + i);
            return i;
        &#125;, executor).handle((result, throwable) -&gt; &#123;
            if (result != null) &#123;
                return result;
            &#125;
            if (throwable != null) &#123;
                return -1;
            &#125;
            return 0;
        &#125;);
        System.out.println(&quot;future.get() = &quot; + future.get());

        System.out.println(&quot;main...end...&quot;);
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><br>- 运行结果：<br><br>  ```java<br>  <span class="hljs-selector-tag">main</span>..<span class="hljs-selector-class">.start</span>...<br>  当前线程：<span class="hljs-number">12</span><br>  future<span class="hljs-selector-class">.get</span>() = -<span class="hljs-number">1</span><br>  <span class="hljs-selector-tag">main</span>..<span class="hljs-selector-class">.end</span>...<br></code></pre></td></tr></table></figure>
</code></pre>
</li>
</ul>
<h5 id="4、线程串行化方法"><a href="#4、线程串行化方法" class="headerlink" title="4、线程串行化方法"></a>4、线程串行化方法</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> CompletableFuture&lt;Void&gt; <span class="hljs-title function_">thenRun</span><span class="hljs-params">(Runnable action)</span><br><br><span class="hljs-keyword">public</span> CompletableFuture&lt;Void&gt; <span class="hljs-title function_">thenRunAsync</span><span class="hljs-params">(Runnable action)</span><br><br><span class="hljs-keyword">public</span> CompletableFuture&lt;Void&gt; <span class="hljs-title function_">thenRunAsync</span><span class="hljs-params">(Runnable action, Executor executor)</span><br><br>    <br><span class="hljs-keyword">public</span> CompletableFuture&lt;Void&gt; <span class="hljs-title function_">thenAccept</span><span class="hljs-params">(Consumer&lt;? <span class="hljs-built_in">super</span> T&gt; action)</span><br><br><span class="hljs-keyword">public</span> CompletableFuture&lt;Void&gt; <span class="hljs-title function_">thenAcceptAsync</span><span class="hljs-params">(Consumer&lt;? <span class="hljs-built_in">super</span> T&gt; action)</span><br><br><span class="hljs-keyword">public</span> CompletableFuture&lt;Void&gt; <span class="hljs-title function_">thenAcceptAsync</span><span class="hljs-params">(Consumer&lt;? <span class="hljs-built_in">super</span> T&gt; action, Executor executor)</span><br>    <br>    <br><span class="hljs-keyword">public</span> &lt;U&gt; CompletableFuture&lt;U&gt; <span class="hljs-title function_">thenApply</span><span class="hljs-params">(Function&lt;? <span class="hljs-built_in">super</span> T,? extends U&gt; fn)</span><br><br><span class="hljs-keyword">public</span> &lt;U&gt; CompletableFuture&lt;U&gt; <span class="hljs-title function_">thenApplyAsync</span><span class="hljs-params">(Function&lt;? <span class="hljs-built_in">super</span> T,? extends U&gt; fn)</span><br><br><span class="hljs-keyword">public</span> &lt;U&gt; CompletableFuture&lt;U&gt; <span class="hljs-title function_">thenApplyAsync</span><span class="hljs-params">(Function&lt;? <span class="hljs-built_in">super</span> T,? extends U&gt; fn, Executor executor)</span><br></code></pre></td></tr></table></figure>

<ul>
<li>thenRun方法：只要上面的任务执行完成，就开始执行thenRun，只是处理完任务后，执行thenRun的后续操作。【不能感知上一步的执行结果，且没有返回值】</li>
<li>thenAccept方法：消费处理结果。接收任务的处理结果，并消费处理，无返回结果。【可以感知上一步的执行结果，没有返回值】</li>
<li>thenApply方法：当一个线程依赖另一个线程时，获取上一个任务返回的结果，并返回当前任务的返回值。【可以感知上一步的zhi型结果，并返回当前任务的返回值】</li>
<li>带有Async默认是异步执行的。</li>
</ul>
<h6 id="1、thenRunAsync测试"><a href="#1、thenRunAsync测试" class="headerlink" title="1、thenRunAsync测试"></a>1、thenRunAsync测试</h6><ul>
<li><p>测试代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(<span class="hljs-number">10</span>);<br>  <br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ExecutionException, InterruptedException &#123;<br>  <br>      System.out.println(<span class="hljs-string">&quot;main...start...&quot;</span>);<br>  <br>      CompletableFuture&lt;Void&gt; future = CompletableFuture.supplyAsync(() -&gt; &#123;<br>          System.out.println(<span class="hljs-string">&quot;任务1当前线程：&quot;</span> + Thread.currentThread().getId());<br>          <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">10</span> / <span class="hljs-number">4</span>;<br>          System.out.println(<span class="hljs-string">&quot;运行结果：&quot;</span> + i);<br>          <span class="hljs-keyword">return</span> i;<br>      &#125;, executor).thenRunAsync(() -&gt; &#123;<br>          System.out.println(<span class="hljs-string">&quot;任务2启动了&quot;</span>);<br>      &#125;, executor);<br>  <br>  <br>      System.out.println(<span class="hljs-string">&quot;main...end...&quot;</span>);<br></code></pre></td></tr></table></figure>
</li>
<li><p>运行结果：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java">main...start...<br>任务<span class="hljs-number">1</span>当前线程：<span class="hljs-number">12</span><br>运行结果：<span class="hljs-number">2</span><br>任务<span class="hljs-number">2</span>启动了<br>future.get() = <span class="hljs-literal">null</span><br>main...end...<br></code></pre></td></tr></table></figure></li>
</ul>
<h6 id="2、thenAcceptAsync测试"><a href="#2、thenAcceptAsync测试" class="headerlink" title="2、thenAcceptAsync测试"></a>2、thenAcceptAsync测试</h6><ul>
<li><p>测试代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(<span class="hljs-number">10</span>);<br>  <br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ExecutionException, InterruptedException &#123;<br>  <br>      System.out.println(<span class="hljs-string">&quot;main...start...&quot;</span>);<br>  <br>      CompletableFuture&lt;Integer&gt; future = CompletableFuture.supplyAsync(() -&gt; &#123;<br>          System.out.println(<span class="hljs-string">&quot;任务1当前线程：&quot;</span> + Thread.currentThread().getId());<br>          <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">10</span> / <span class="hljs-number">4</span>;<br>          System.out.println(<span class="hljs-string">&quot;运行结果：&quot;</span> + i);<br>          <span class="hljs-keyword">return</span> i;<br>      &#125;, executor).thenApplyAsync((i) -&gt; &#123;<br>          System.out.println(<span class="hljs-string">&quot;任务2启动了，这是任务1的返回结果：&quot;</span> + i);<br>          <span class="hljs-keyword">return</span> i + <span class="hljs-number">100</span>;<br>      &#125;, executor);<br>      System.out.println(<span class="hljs-string">&quot;future.get() = &quot;</span> + future.get());<br>  <br>  <br>      System.out.println(<span class="hljs-string">&quot;main...end...&quot;</span>);<br></code></pre></td></tr></table></figure>
</li>
<li><p>运行结果</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java">main...start...<br>任务<span class="hljs-number">1</span>当前线程：<span class="hljs-number">12</span><br>运行结果：<span class="hljs-number">2</span><br>任务<span class="hljs-number">2</span>启动了，这是任务<span class="hljs-number">1</span>的返回结果： <span class="hljs-number">2</span><br>future.get() = <span class="hljs-literal">null</span><br>main...end...<br></code></pre></td></tr></table></figure></li>
</ul>
<h6 id="3、thenApplyAsync测试"><a href="#3、thenApplyAsync测试" class="headerlink" title="3、thenApplyAsync测试"></a>3、thenApplyAsync测试</h6><ul>
<li><p>测试代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(<span class="hljs-number">10</span>);<br>  <br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ExecutionException, InterruptedException &#123;<br>  <br>      System.out.println(<span class="hljs-string">&quot;main...start...&quot;</span>);<br>  <br>      CompletableFuture&lt;Void&gt; future = CompletableFuture.supplyAsync(() -&gt; &#123;<br>          System.out.println(<span class="hljs-string">&quot;任务1当前线程：&quot;</span> + Thread.currentThread().getId());<br>          <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">10</span> / <span class="hljs-number">4</span>;<br>          System.out.println(<span class="hljs-string">&quot;运行结果：&quot;</span> + i);<br>          <span class="hljs-keyword">return</span> i;<br>      &#125;, executor).thenRunAsync(() -&gt; &#123;<br>          System.out.println(<span class="hljs-string">&quot;任务2启动了&quot;</span>);<br>      &#125;, executor);<br>  <br>  <br>      System.out.println(<span class="hljs-string">&quot;main...end...&quot;</span>);<br></code></pre></td></tr></table></figure>
</li>
<li><p>运行结果</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java">main...start...<br>任务<span class="hljs-number">1</span>当前线程：<span class="hljs-number">12</span><br>运行结果：<span class="hljs-number">2</span><br>任务<span class="hljs-number">2</span>启动了，这是任务<span class="hljs-number">1</span>的返回结果：<span class="hljs-number">2</span><br>future.get() = <span class="hljs-number">102</span><br>main...end...<br></code></pre></td></tr></table></figure></li>
</ul>
<h5 id="5、两任务组合-都要完成"><a href="#5、两任务组合-都要完成" class="headerlink" title="5、两任务组合 - 都要完成"></a>5、两任务组合 - 都要完成</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> CompletableFuture&lt;Void&gt; <span class="hljs-title function_">runAfterBoth</span><span class="hljs-params">(CompletionStage&lt;?&gt; other, Runnable action)</span><br><br><span class="hljs-keyword">public</span> CompletableFuture&lt;Void&gt; <span class="hljs-title function_">runAfterBothAsync</span><span class="hljs-params">(CompletionStage&lt;?&gt; other, Runnable action)</span><br><br><span class="hljs-keyword">public</span> CompletableFuture&lt;Void&gt; <span class="hljs-title function_">runAfterBothAsync</span><span class="hljs-params">(CompletionStage&lt;?&gt; other, Runnable action, Executor executor)</span><br>    <br><br><span class="hljs-keyword">public</span> &lt;U&gt; CompletableFuture&lt;Void&gt; <span class="hljs-title function_">thenAcceptBoth</span><span class="hljs-params">(CompletionStage&lt;? extends U&gt; other, BiConsumer&lt;? <span class="hljs-built_in">super</span> T, ? <span class="hljs-built_in">super</span> U&gt; action)</span><br><br><span class="hljs-keyword">public</span> &lt;U&gt; CompletableFuture&lt;Void&gt; <span class="hljs-title function_">thenAcceptBothAsync</span><span class="hljs-params">(CompletionStage&lt;? extends U&gt; other, BiConsumer&lt;? <span class="hljs-built_in">super</span> T, ? <span class="hljs-built_in">super</span> U&gt; action)</span><br><br><span class="hljs-keyword">public</span> &lt;U&gt; CompletableFuture&lt;Void&gt; <span class="hljs-title function_">thenAcceptBothAsync</span><span class="hljs-params">(CompletionStage&lt;? extends U&gt; other,BiConsumer&lt;? <span class="hljs-built_in">super</span> T, ? <span class="hljs-built_in">super</span> U&gt; action, Executor executor)</span><br><br><br><span class="hljs-keyword">public</span> &lt;U,V&gt; CompletableFuture&lt;V&gt; <span class="hljs-title function_">thenCombine</span><span class="hljs-params">(CompletionStage&lt;? extends U&gt; other, BiFunction&lt;? <span class="hljs-built_in">super</span> T,? <span class="hljs-built_in">super</span> U,? extends V&gt; fn)</span><br>    <br><span class="hljs-keyword">public</span> &lt;U,V&gt; CompletableFuture&lt;V&gt; <span class="hljs-title function_">thenCombineAsync</span><span class="hljs-params">(CompletionStage&lt;? extends U&gt; other, BiFunction&lt;? <span class="hljs-built_in">super</span> T,? <span class="hljs-built_in">super</span> U,? extends V&gt; fn)</span><br><br><span class="hljs-keyword">public</span> &lt;U,V&gt; CompletableFuture&lt;V&gt; <span class="hljs-title function_">thenCombineAsync</span><span class="hljs-params">(CompletionStage&lt;? extends U&gt; other, BiFunction&lt;? <span class="hljs-built_in">super</span> T,? <span class="hljs-built_in">super</span> U,? extends V&gt; fn, Executor executor)</span><br></code></pre></td></tr></table></figure>

<p><strong>两个任务必须都完成，才会触发该任务</strong></p>
<ul>
<li>runAfterBoth：组合两个future，不需要获取future的结果，只需两个future处理完任务后，处理该任务。</li>
<li>thenAccpetBoth：组合两个future，获取两个future的返回结果，然后处理任务，没有返回值。</li>
<li>thenCombine：组合两个future，获取两个future的返回结果，并返回当前任务的返回值。</li>
</ul>
<h6 id="1、runAfterAsync测试"><a href="#1、runAfterAsync测试" class="headerlink" title="1、runAfterAsync测试"></a>1、runAfterAsync测试</h6><ul>
<li><p>测试代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 两个都完成</span><br><span class="hljs-comment"> */</span><br>CompletableFuture&lt;Integer&gt; future01 = CompletableFuture.supplyAsync(() -&gt; &#123;<br>    System.out.println(<span class="hljs-string">&quot;任务1线程启动：&quot;</span> + Thread.currentThread().getId());<br>    <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">10</span> / <span class="hljs-number">4</span>;<br>    System.out.println(<span class="hljs-string">&quot;任务1线程结束：&quot;</span>);<br>    <span class="hljs-keyword">return</span> i;<br>&#125;, executor);<br>CompletableFuture&lt;String&gt; future02 = CompletableFuture.supplyAsync(() -&gt; &#123;<br>    System.out.println(<span class="hljs-string">&quot;任务2线程启动：&quot;</span> + Thread.currentThread().getId());<br>    System.out.println(<span class="hljs-string">&quot;任务2线程结束：&quot;</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;hello&quot;</span>;<br>&#125;, executor);<br>  <br>future01.runAfterBothAsync(future02, () -&gt; &#123;<br>    System.out.println(<span class="hljs-string">&quot;任务3开始。。。&quot;</span>);<br>&#125;, executor);<br></code></pre></td></tr></table></figure>
</li>
<li><p>运行结果</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java">main...start...<br>任务<span class="hljs-number">1</span>线程启动：<span class="hljs-number">12</span><br>任务<span class="hljs-number">1</span>线程结束：<br>任务<span class="hljs-number">2</span>线程启动：<span class="hljs-number">13</span><br>任务<span class="hljs-number">2</span>线程结束：<br>main...end...<br>任务<span class="hljs-number">3</span>开始。。。<br></code></pre></td></tr></table></figure></li>
</ul>
<h6 id="2、thenAcceptBothAsync测试"><a href="#2、thenAcceptBothAsync测试" class="headerlink" title="2、thenAcceptBothAsync测试"></a>2、thenAcceptBothAsync测试</h6><ul>
<li><p>测试代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 两个都完成</span><br><span class="hljs-comment"> */</span><br>CompletableFuture&lt;Integer&gt; future01 = CompletableFuture.supplyAsync(() -&gt; &#123;<br>    System.out.println(<span class="hljs-string">&quot;任务1线程启动：&quot;</span> + Thread.currentThread().getId());<br>    <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">10</span> / <span class="hljs-number">4</span>;<br>    System.out.println(<span class="hljs-string">&quot;任务1线程结束：&quot;</span>);<br>    <span class="hljs-keyword">return</span> i;<br>&#125;, executor);<br>CompletableFuture&lt;String&gt; future02 = CompletableFuture.supplyAsync(() -&gt; &#123;<br>    System.out.println(<span class="hljs-string">&quot;任务2线程启动：&quot;</span> + Thread.currentThread().getId());<br>    System.out.println(<span class="hljs-string">&quot;任务2线程结束：&quot;</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;hello&quot;</span>;<br>&#125;, executor);<br>  <br>future01.thenAcceptBothAsync(future02, (v1, v2) -&gt; &#123;<br>    System.out.println(<span class="hljs-string">&quot;任务3开始。。。之前的结果：&quot;</span> + v1 + <span class="hljs-string">&quot; , &quot;</span> + v2);<br>&#125;, executor);<br></code></pre></td></tr></table></figure>
</li>
<li><p>运行结果：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java">main...start...<br>任务<span class="hljs-number">1</span>线程启动：<span class="hljs-number">12</span><br>任务<span class="hljs-number">1</span>线程结束：<br>任务<span class="hljs-number">2</span>线程启动：<span class="hljs-number">13</span><br>任务<span class="hljs-number">2</span>线程结束：<br>main...end...<br>任务<span class="hljs-number">3</span>开始。。。之前的结果：<span class="hljs-number">2</span> , hello<br></code></pre></td></tr></table></figure></li>
</ul>
<h6 id="3、thenCombineAsync测试"><a href="#3、thenCombineAsync测试" class="headerlink" title="3、thenCombineAsync测试"></a>3、thenCombineAsync测试</h6><ul>
<li><p>测试代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 两个都完成</span><br><span class="hljs-comment"> */</span><br>CompletableFuture&lt;Integer&gt; future01 = CompletableFuture.supplyAsync(() -&gt; &#123;<br>    System.out.println(<span class="hljs-string">&quot;任务1线程启动：&quot;</span> + Thread.currentThread().getId());<br>    <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">10</span> / <span class="hljs-number">4</span>;<br>    System.out.println(<span class="hljs-string">&quot;任务1线程结束：&quot;</span>);<br>    <span class="hljs-keyword">return</span> i;<br>&#125;, executor);<br>CompletableFuture&lt;String&gt; future02 = CompletableFuture.supplyAsync(() -&gt; &#123;<br>    System.out.println(<span class="hljs-string">&quot;任务2线程启动：&quot;</span> + Thread.currentThread().getId());<br>    System.out.println(<span class="hljs-string">&quot;任务2线程结束：&quot;</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;hello&quot;</span>;<br>&#125;, executor);<br>  <br>CompletableFuture&lt;String&gt; future = future01.thenCombineAsync(future02, (v1, v2) -&gt; &#123;<br>    <span class="hljs-keyword">return</span> v1 + <span class="hljs-string">&quot;:&quot;</span> + v2 + <span class="hljs-string">&quot; -&gt; Haha&quot;</span>;<br>&#125;, executor);<br>System.out.println(<span class="hljs-string">&quot;future.get() = &quot;</span> + future.get());<br></code></pre></td></tr></table></figure>
</li>
<li><p>运行结果：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java">main...start...<br>任务<span class="hljs-number">1</span>线程启动：<span class="hljs-number">12</span><br>任务<span class="hljs-number">1</span>线程结束：<br>任务<span class="hljs-number">2</span>线程启动：<span class="hljs-number">13</span><br>任务<span class="hljs-number">2</span>线程结束：<br>future.get() = <span class="hljs-number">2</span>:hello -&gt; Haha<br>main...end...<br></code></pre></td></tr></table></figure></li>
</ul>
<h5 id="6、两任务组合-一个完成"><a href="#6、两任务组合-一个完成" class="headerlink" title="6、两任务组合 - 一个完成"></a>6、两任务组合 - 一个完成</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> CompletableFuture&lt;Void&gt; <span class="hljs-title function_">runAfterEither</span><span class="hljs-params">(CompletionStage&lt;?&gt; other, Runnable action)</span> <br><br><span class="hljs-keyword">public</span> CompletableFuture&lt;Void&gt; <span class="hljs-title function_">runAfterEitherAsync</span><span class="hljs-params">(CompletionStage&lt;?&gt; other, Runnable action)</span><br><br><span class="hljs-keyword">public</span> CompletableFuture&lt;Void&gt; <span class="hljs-title function_">runAfterEitherAsync</span><span class="hljs-params">(CompletionStage&lt;?&gt; other, Runnable action, Executor executor)</span><br>    <br>    <br><span class="hljs-keyword">public</span> CompletableFuture&lt;Void&gt; <span class="hljs-title function_">acceptEither</span><span class="hljs-params">(CompletionStage&lt;? extends T&gt; other, Consumer&lt;? <span class="hljs-built_in">super</span> T&gt; action)</span> <br><br><span class="hljs-keyword">public</span> CompletableFuture&lt;Void&gt; <span class="hljs-title function_">acceptEitherAsync</span><span class="hljs-params">(CompletionStage&lt;? extends T&gt; other, Consumer&lt;? <span class="hljs-built_in">super</span> T&gt; action)</span><br><br><span class="hljs-keyword">public</span> CompletableFuture&lt;Void&gt; <span class="hljs-title function_">acceptEitherAsync</span><span class="hljs-params">(CompletionStage&lt;? extends T&gt; other, Consumer&lt;? <span class="hljs-built_in">super</span> T&gt; action, Executor executor)</span> <br>    <br>    <br><span class="hljs-keyword">public</span> &lt;U&gt; CompletableFuture&lt;U&gt; <span class="hljs-title function_">applyToEither</span><span class="hljs-params">(CompletionStage&lt;? extends T&gt; other, Function&lt;? <span class="hljs-built_in">super</span> T, U&gt; fn)</span><br><br><span class="hljs-keyword">public</span> &lt;U&gt; CompletableFuture&lt;U&gt; <span class="hljs-title function_">applyToEitherAsync</span><span class="hljs-params">(CompletionStage&lt;? extends T&gt; other, Function&lt;? <span class="hljs-built_in">super</span> T, U&gt; fn)</span><br><br><span class="hljs-keyword">public</span> &lt;U&gt; CompletableFuture&lt;U&gt; <span class="hljs-title function_">applyToEitherAsync</span><span class="hljs-params">(CompletionStage&lt;? extends T&gt; other, Function&lt;? <span class="hljs-built_in">super</span> T, U&gt; fn, Executor executor)</span> <br></code></pre></td></tr></table></figure>

<p><strong>当两个任务中，任意一个future任务完成的时候，执行任务</strong></p>
<ul>
<li>runAfterEither方法：两个任务有一个执行完成，不需要获取future的结果，处理任务，也没有返回值</li>
<li>acceptEither方法：两个任务有一个执行完成，获取它的返回值，处理任务，没有新的返回值</li>
<li>applyToEither方法：两个任务有一个执行完成，获取它的返回值，处理任务并有新的返回值</li>
</ul>
<h6 id="1、runAfterEitherAsync测试"><a href="#1、runAfterEitherAsync测试" class="headerlink" title="1、runAfterEitherAsync测试"></a>1、runAfterEitherAsync测试</h6><ul>
<li><p>测试代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 两个任务只要有一个完成，就执行任务3</span><br><span class="hljs-comment"> */</span><br>CompletableFuture&lt;Integer&gt; future01 = CompletableFuture.supplyAsync(() -&gt; &#123;<br>    System.out.println(<span class="hljs-string">&quot;任务1线程启动：&quot;</span> + Thread.currentThread().getId());<br>    <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">10</span> / <span class="hljs-number">4</span>;<br>    System.out.println(<span class="hljs-string">&quot;任务1线程结束：&quot;</span>);<br>    <span class="hljs-keyword">return</span> i;<br>&#125;, executor);<br>CompletableFuture&lt;Integer&gt; future02 = CompletableFuture.supplyAsync(() -&gt; &#123;<br>    System.out.println(<span class="hljs-string">&quot;任务2线程启动：&quot;</span> + Thread.currentThread().getId());<br>    <span class="hljs-keyword">try</span> &#123;<br>        Thread.sleep(<span class="hljs-number">3000</span>);<br>    &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>        e.printStackTrace();<br>    &#125;<br>    System.out.println(<span class="hljs-string">&quot;任务2线程结束：&quot;</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">222</span>;<br>&#125;, executor);<br>  <br>future01.runAfterEitherAsync(future02, () -&gt; &#123;<br>    System.out.println(<span class="hljs-string">&quot;任务3开始执行&quot;</span>);<br>&#125;, executor);<br></code></pre></td></tr></table></figure>
</li>
<li><p>运行结果：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java">main...start...<br>任务<span class="hljs-number">1</span>线程启动：<span class="hljs-number">12</span><br>任务<span class="hljs-number">1</span>线程结束：<br>任务<span class="hljs-number">2</span>线程启动：<span class="hljs-number">13</span><br>main...end...<br>任务<span class="hljs-number">3</span>开始执行<br>任务<span class="hljs-number">2</span>线程结束：<br></code></pre></td></tr></table></figure></li>
</ul>
<h6 id="2、acceptEitherAsync测试"><a href="#2、acceptEitherAsync测试" class="headerlink" title="2、acceptEitherAsync测试"></a>2、acceptEitherAsync测试</h6><ul>
<li><p>测试代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 两个任务只要有一个完成，就执行任务3</span><br><span class="hljs-comment"> */</span><br>CompletableFuture&lt;Integer&gt; future01 = CompletableFuture.supplyAsync(() -&gt; &#123;<br>    System.out.println(<span class="hljs-string">&quot;任务1线程启动：&quot;</span> + Thread.currentThread().getId());<br>    <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">10</span> / <span class="hljs-number">4</span>;<br>    System.out.println(<span class="hljs-string">&quot;任务1线程结束：&quot;</span>);<br>    <span class="hljs-keyword">return</span> i;<br>&#125;, executor);<br>CompletableFuture&lt;Integer&gt; future02 = CompletableFuture.supplyAsync(() -&gt; &#123;<br>    System.out.println(<span class="hljs-string">&quot;任务2线程启动：&quot;</span> + Thread.currentThread().getId());<br>    <span class="hljs-keyword">try</span> &#123;<br>        Thread.sleep(<span class="hljs-number">3000</span>);<br>    &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>        e.printStackTrace();<br>    &#125;<br>    System.out.println(<span class="hljs-string">&quot;任务2线程结束：&quot;</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">222</span>;<br>&#125;, executor);<br>  <br>future01.acceptEitherAsync(future02, (res) -&gt; &#123;<br>    System.out.println(<span class="hljs-string">&quot;任务3开始执行，任务3之前的结果：&quot;</span> + res);<br>&#125;, executor);<br></code></pre></td></tr></table></figure>
</li>
<li><p>运行结果：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java">main...start...<br>任务<span class="hljs-number">1</span>线程启动：<span class="hljs-number">12</span><br>任务<span class="hljs-number">1</span>线程结束：<br>任务<span class="hljs-number">2</span>线程启动：<span class="hljs-number">13</span><br>main...end...<br>任务<span class="hljs-number">3</span>开始执行，任务<span class="hljs-number">3</span>之前的结果：<span class="hljs-number">2</span><br>任务<span class="hljs-number">2</span>线程结束：<br></code></pre></td></tr></table></figure></li>
</ul>
<h6 id="3、applyToEitherAsync测试"><a href="#3、applyToEitherAsync测试" class="headerlink" title="3、applyToEitherAsync测试"></a>3、applyToEitherAsync测试</h6><ul>
<li><p>测试代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 两个任务只要有一个完成，就执行任务3</span><br><span class="hljs-comment"> */</span><br>CompletableFuture&lt;Integer&gt; future01 = CompletableFuture.supplyAsync(() -&gt; &#123;<br>    System.out.println(<span class="hljs-string">&quot;任务1线程启动：&quot;</span> + Thread.currentThread().getId());<br>    <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">10</span> / <span class="hljs-number">4</span>;<br>    System.out.println(<span class="hljs-string">&quot;任务1线程结束：&quot;</span>);<br>    <span class="hljs-keyword">return</span> i;<br>&#125;, executor);<br>CompletableFuture&lt;Integer&gt; future02 = CompletableFuture.supplyAsync(() -&gt; &#123;<br>    System.out.println(<span class="hljs-string">&quot;任务2线程启动：&quot;</span> + Thread.currentThread().getId());<br>    <span class="hljs-keyword">try</span> &#123;<br>        Thread.sleep(<span class="hljs-number">3000</span>);<br>    &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>        e.printStackTrace();<br>    &#125;<br>    System.out.println(<span class="hljs-string">&quot;任务2线程结束：&quot;</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">222</span>;<br>&#125;, executor);<br>  <br>CompletableFuture&lt;Integer&gt; future03 = future01.applyToEitherAsync(future02, (res) -&gt; &#123;<br>    System.out.println(<span class="hljs-string">&quot;任务3开始执行，任务3之前的结果：&quot;</span> + res);<br>    <span class="hljs-keyword">return</span> res + <span class="hljs-number">100</span>;<br>&#125;, executor);<br>System.out.println(<span class="hljs-string">&quot;future03.get() = &quot;</span> + future03.get());<br></code></pre></td></tr></table></figure>
</li>
<li><p>运行结果：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java">main...start...<br>任务<span class="hljs-number">1</span>线程启动：<span class="hljs-number">12</span><br>任务<span class="hljs-number">1</span>线程结束：<br>任务<span class="hljs-number">2</span>线程启动：<span class="hljs-number">13</span><br>任务<span class="hljs-number">3</span>开始执行，任务<span class="hljs-number">3</span>之前的结果：<span class="hljs-number">2</span><br>future03.get() = <span class="hljs-number">102</span><br>main...end...<br>任务<span class="hljs-number">2</span>线程结束：<br></code></pre></td></tr></table></figure></li>
</ul>
<h5 id="7、多任务组合"><a href="#7、多任务组合" class="headerlink" title="7、多任务组合"></a>7、多任务组合</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> CompletableFuture&lt;Void&gt; <span class="hljs-title function_">allOf</span><span class="hljs-params">(CompletableFuture&lt;?&gt;... cfs)</span><br>    <br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> CompletableFuture&lt;Object&gt; <span class="hljs-title function_">anyOf</span><span class="hljs-params">(CompletableFuture&lt;?&gt;... cfs)</span><br></code></pre></td></tr></table></figure>

<ul>
<li>allOf方法：等待所有任务完成</li>
<li>anyOf方法：只要有一个任务完成</li>
</ul>
<h6 id="1、allOf-测试"><a href="#1、allOf-测试" class="headerlink" title="1、allOf 测试"></a>1、allOf 测试</h6><ul>
<li><p>测试代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java">CompletableFuture&lt;String&gt; futureImg = CompletableFuture.supplyAsync(() -&gt; &#123;<br>    System.out.println(<span class="hljs-string">&quot;查询商品的图片信息&quot;</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;hello.jpg&quot;</span>;<br>&#125;, executor);<br>CompletableFuture&lt;String&gt; futureAttr = CompletableFuture.supplyAsync(() -&gt; &#123;<br>    System.out.println(<span class="hljs-string">&quot;查询商品的属性信息&quot;</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;黑色 + 256G&quot;</span>;<br>&#125;, executor);<br>CompletableFuture&lt;String&gt; futureDesc = CompletableFuture.supplyAsync(() -&gt; &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        Thread.sleep(<span class="hljs-number">3000</span>);<br>        System.out.println(<span class="hljs-string">&quot;查询商品介绍&quot;</span>);<br>    &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>        e.printStackTrace();<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;华为&quot;</span>;<br>&#125;, executor);<br>  <br>CompletableFuture&lt;Void&gt; future = CompletableFuture.allOf(futureImg, futureAttr, futureDesc);<br>future.get();  <span class="hljs-comment">// 等待所有结果完成</span><br>  <br><span class="hljs-comment">// 获取这三个任务的返回值</span><br>System.out.println(futureImg.get() + <span class="hljs-string">&quot;===&gt;&quot;</span> + futureAttr.get() + <span class="hljs-string">&quot;===&gt;&quot;</span> + futureDesc.get());<br></code></pre></td></tr></table></figure>
</li>
<li><p>运行结果：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java">main...start...<br>查询商品的图片信息<br>查询商品的属性信息<br>查询商品介绍<br>hello.jpg===&gt;黑色 + 256G===&gt;华为<br>main...end...<br></code></pre></td></tr></table></figure></li>
</ul>
<h6 id="2、anyOf-测试"><a href="#2、anyOf-测试" class="headerlink" title="2、anyOf 测试"></a>2、anyOf 测试</h6><ul>
<li><pre><code class="java">    CompletableFuture&lt;String&gt; futureImg = CompletableFuture.supplyAsync(() -&gt; &#123;
        System.out.println(&quot;查询商品的图片信息&quot;);
        return &quot;hello.jpg&quot;;
    &#125;, executor);
    CompletableFuture&lt;String&gt; futureAttr = CompletableFuture.supplyAsync(() -&gt; &#123;
        System.out.println(&quot;查询商品的属性信息&quot;);
        return &quot;黑色 + 256G&quot;;
    &#125;, executor);
    CompletableFuture&lt;String&gt; futureDesc = CompletableFuture.supplyAsync(() -&gt; &#123;
        try &#123;
            Thread.sleep(3000);
            System.out.println(&quot;查询商品介绍&quot;);
        &#125; catch (InterruptedException e) &#123;
            e.printStackTrace();
        &#125;
        return &quot;华为&quot;;
    &#125;, executor);
  
    CompletableFuture&lt;Object&gt; future = CompletableFuture.anyOf(futureImg, futureAttr, futureDesc);
    future.get();  // 等待有一个结果完成
  
    // 获取最先执行完成的任务的返回值
    System.out.println(&quot;返回值：&quot; + future.get());
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><br>- 运行结果：<br><br>  ```java<br>  <span class="hljs-selector-tag">main</span>..<span class="hljs-selector-class">.start</span>...<br>  查询商品的图片信息<br>  查询商品的属性信息<br>  返回值：hello<span class="hljs-selector-class">.jpg</span><br>  <span class="hljs-selector-tag">main</span>..<span class="hljs-selector-class">.end</span>...<br>  查询商品介绍<br></code></pre></td></tr></table></figure>
</code></pre>
</li>
</ul>
<h3 id="九、SpringSession"><a href="#九、SpringSession" class="headerlink" title="九、SpringSession"></a>九、SpringSession</h3><p><strong>整合SpringSession解决不同服务之间Session共享的问题</strong></p>
<h4 id="1、整合SpringSession（使用redis存储session）"><a href="#1、整合SpringSession（使用redis存储session）" class="headerlink" title="1、整合SpringSession（使用redis存储session）"></a>1、整合SpringSession（使用redis存储session）</h4><h5 id="1、导入依赖-2"><a href="#1、导入依赖-2" class="headerlink" title="1、导入依赖"></a>1、导入依赖</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--整合SpringSession完成Session共享的问题--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.session<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-session-data-redis<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<h5 id="2、application-properties配置文件配置"><a href="#2、application-properties配置文件配置" class="headerlink" title="2、application.properties配置文件配置"></a>2、application.properties配置文件配置</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span> <br>  <span class="hljs-attr">session:</span><br>    <span class="hljs-comment"># 使用redis存储session信息</span><br>    <span class="hljs-attr">store-type:</span> <span class="hljs-string">redis</span><br>  <span class="hljs-attr">redis:</span><br>    <span class="hljs-attr">host:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.100</span><span class="hljs-number">.135</span><br>    <span class="hljs-attr">port:</span> <span class="hljs-number">6379</span><br><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">servlet:</span><br>    <span class="hljs-attr">session:</span><br>      <span class="hljs-comment"># session的超时时间</span><br>      <span class="hljs-attr">timeout:</span> <span class="hljs-string">30m</span><br></code></pre></td></tr></table></figure>

<h5 id="3、启动类上加上注解，开启SpringSession"><a href="#3、启动类上加上注解，开启SpringSession" class="headerlink" title="3、启动类上加上注解，开启SpringSession"></a>3、启动类上加上注解，开启SpringSession</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-meta">@EnableRedisHttpSession</span>  <span class="hljs-comment">// 整合Redis，开启SpringSession</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GulimallAuthServerApplication</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        SpringApplication.run(GulimallAuthServerApplication.class, args);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="4、自定义session域，设置子域session共享；指定存到redis中的session的序列化机制为json"><a href="#4、自定义session域，设置子域session共享；指定存到redis中的session的序列化机制为json" class="headerlink" title="4、自定义session域，设置子域session共享；指定存到redis中的session的序列化机制为json"></a>4、自定义session域，设置子域session共享；指定存到redis中的session的序列化机制为json</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.alibaba.fastjson.support.spring.GenericFastJsonRedisSerializer;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><span class="hljs-keyword">import</span> org.springframework.data.redis.serializer.GenericJackson2JsonRedisSerializer;<br><span class="hljs-keyword">import</span> org.springframework.data.redis.serializer.RedisSerializer;<br><span class="hljs-keyword">import</span> org.springframework.session.web.http.CookieSerializer;<br><span class="hljs-keyword">import</span> org.springframework.session.web.http.DefaultCookieSerializer;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 指定cookie中session的作用域为 .gulimall.com</span><br><span class="hljs-comment"> * 指定存到redis中的session的序列化机制为json</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> taoao</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GulimallSessionConfig</span> &#123;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> CookieSerializer <span class="hljs-title function_">cookieSerializer</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">DefaultCookieSerializer</span> <span class="hljs-variable">cookieSerializer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultCookieSerializer</span>();<br>        cookieSerializer.setDomainName(<span class="hljs-string">&quot;gulimall.com&quot;</span>);  <span class="hljs-comment">// 指定session的域</span><br>        cookieSerializer.setCookieName(<span class="hljs-string">&quot;GULISESSION&quot;</span>);  <span class="hljs-comment">// 还可以指定session的名字</span><br>        <span class="hljs-keyword">return</span> cookieSerializer;<br>    &#125;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> RedisSerializer&lt;Object&gt; <span class="hljs-title function_">springSessionDefaultRedisSerializer</span><span class="hljs-params">()</span> &#123;<br><span class="hljs-comment">//        return new GenericFastJsonRedisSerializer();</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">GenericJackson2JsonRedisSerializer</span>();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="十、消息队列MQ"><a href="#十、消息队列MQ" class="headerlink" title="十、消息队列MQ"></a>十、消息队列MQ</h3><h4 id="1、概述"><a href="#1、概述" class="headerlink" title="1、概述"></a>1、概述</h4><ul>
<li>1、大多应用中，可通过消息服务中间件来提升系统异步通信、扩展解耦能力</li>
<li>2、消息服务中的两个重要概念：<ul>
<li><strong>消息代理（message broker）</strong>和<strong>目的地（destination）</strong></li>
<li>当消息发送者发送消息以后，将由消息代理接管，消息代理保证消息传递到指定目的地。</li>
</ul>
</li>
<li>3、消息队列主要有两种形式的目的地：<ul>
<li>1、<strong>队列（queue）</strong>：点对点消息通信（point-to-point）</li>
<li>2、<strong>主题（topic）</strong>：发布（publish）&#x2F;订阅（subscribe）消息通信</li>
</ul>
</li>
<li>4、点对点式：<ul>
<li>消息发送者发送消息，消息代理将其放入一个队列中，消息接收者从队列中获取消息内容，消息读取后被移出队列</li>
<li>消息只有唯一的发送者和接受者，但并不是说只能有一个接收者</li>
</ul>
</li>
<li>5、发布订阅式：<ul>
<li>发送者（发布者）发送消息到主题，多个接收者（订阅者）监听（订阅）这个主题，那么就会在消息到达同时受到消息</li>
</ul>
</li>
<li>6、JMS（Java Message Service）JAVA消息服务<ul>
<li>基于JVM消息代理的规范。ActiveMQ、HornetMQ是JMS实现的</li>
</ul>
</li>
<li>7、AMQP（Advanced Message Queuing Protocol）<ul>
<li>高级消息队列协议，也是一个消息代理的规范，兼容JMS</li>
<li>RabbitMQ是AMQP的实现</li>
</ul>
</li>
</ul>
<h4 id="2、docker安装RebbitMQ"><a href="#2、docker安装RebbitMQ" class="headerlink" title="2、docker安装RebbitMQ"></a>2、docker安装RebbitMQ</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker run -d --name rabbitmq -p 5671:5671 -p 5672:5672 -p 4369:4369 -p 25672:25672 -p 15671:15671 -p 15672:15672 --restart=always  rabbitmq:management<br></code></pre></td></tr></table></figure>

<p><strong>之后浏览器访问：<code>192.168.100.135:15672</code>就可以访问RabbitMQl了，默认的用户名密码都是 <code>guest</code></strong></p>
<h4 id="3、SpringBoot整合RabbitMQ"><a href="#3、SpringBoot整合RabbitMQ" class="headerlink" title="3、SpringBoot整合RabbitMQ"></a>3、SpringBoot整合RabbitMQ</h4><h5 id="1、引入依赖"><a href="#1、引入依赖" class="headerlink" title="1、引入依赖"></a>1、引入依赖</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--整合RabbitMQ--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>引入依赖之后，RabbitAutoConfiguration就会自动生效，就会给容器中自动配置了CachingConnectionFactory（连接工厂）、RabbitTemplate、AmqpAdmin、RabbitMessagingTemplate</p>
<h5 id="2、在application-yml中配置RabbitMQ的连接信息"><a href="#2、在application-yml中配置RabbitMQ的连接信息" class="headerlink" title="2、在application.yml中配置RabbitMQ的连接信息"></a>2、在<code>application.yml</code>中配置RabbitMQ的连接信息</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment">### application.yml</span><br><span class="hljs-comment"># RabbitMQ 连接信息</span><br><span class="hljs-attr">spring:</span> <br>  <span class="hljs-attr">rabbitmq:</span><br>    <span class="hljs-attr">host:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.100</span><span class="hljs-number">.135</span><br>    <span class="hljs-attr">port:</span> <span class="hljs-number">5672</span><br>    <span class="hljs-attr">virtual-host:</span> <span class="hljs-string">/</span><br>    <span class="hljs-attr">username:</span> <span class="hljs-string">guest</span><br>    <span class="hljs-attr">password:</span> <span class="hljs-string">guest</span><br></code></pre></td></tr></table></figure>

<h5 id="3、在启动类上使用-EnableRabbit注解开始功能"><a href="#3、在启动类上使用-EnableRabbit注解开始功能" class="headerlink" title="3、在启动类上使用@EnableRabbit注解开始功能"></a>3、在启动类上使用<code>@EnableRabbit</code>注解开始功能</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-meta">@EnableDiscoveryClient</span><br><span class="hljs-meta">@EnableRabbit</span>  <span class="hljs-comment">// 开启RabbitMQ</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GulimallOrderApplication</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        SpringApplication.run(GulimallOrderApplication.class, args);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="4、测试：利用AmqpAdmin创建交换机"><a href="#4、测试：利用AmqpAdmin创建交换机" class="headerlink" title="4、测试：利用AmqpAdmin创建交换机"></a>4、测试：利用AmqpAdmin创建交换机</h5><h6 id="4-1、代码"><a href="#4-1、代码" class="headerlink" title="4.1、代码"></a>4.1、代码</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 可以帮助我们创建队列、绑定关系等等</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-meta">@Autowired</span><br>  AmqpAdmin amqpAdmin;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 1、如何创建Exchange、Queue、Binding</span><br><span class="hljs-comment">   * 1）、使用AmqpAdmin进行创建</span><br><span class="hljs-comment">   * 2、如何收发消息</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-meta">@Test</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createExchange</span><span class="hljs-params">()</span> &#123;<br>      <span class="hljs-comment">// 创建交换机  交换机名字叫：hello.java.exchange  是否持久化：是   是否自动删除：不</span><br>      <span class="hljs-type">DirectExchange</span> <span class="hljs-variable">directExchange</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DirectExchange</span>(<span class="hljs-string">&quot;hello.java.exchange&quot;</span>, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>);<br>      <span class="hljs-comment">// 利用amqpAdmin声明交换机</span><br>      amqpAdmin.declareExchange(directExchange);<br>      log.info(<span class="hljs-string">&quot;exchange[&#123;&#125;] create success&quot;</span>, <span class="hljs-string">&quot;hello.java.exchange&quot;</span>);<br>  &#125;<br></code></pre></td></tr></table></figure>

<h6 id="4-2、效果图"><a href="#4-2、效果图" class="headerlink" title="4.2、效果图"></a>4.2、效果图</h6><p><img src="/img/guli_img/Java%E5%88%9B%E5%BB%BARabbitMQ%E7%9A%84%E4%BA%A4%E6%8D%A2%E6%9C%BA%E6%88%90%E5%8A%9F%E6%95%88%E6%9E%9C.png" alt="Java创建RabbitMQ的交换机成功效果"></p>
<h5 id="5、测试：利用AmqpAdmin创建队列"><a href="#5、测试：利用AmqpAdmin创建队列" class="headerlink" title="5、测试：利用AmqpAdmin创建队列"></a>5、测试：利用AmqpAdmin创建队列</h5><h6 id="5-1、代码"><a href="#5-1、代码" class="headerlink" title="5.1、代码"></a>5.1、代码</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createQueue</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// 创建一个队列 队列名字叫：hello.java.queue  是否持久化：是   是否排他：不（可以被其他连接连接）   是否自动删除：不</span><br>    <span class="hljs-type">Queue</span> <span class="hljs-variable">queue</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Queue</span>(<span class="hljs-string">&quot;hello.java.queue&quot;</span>, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>);<br>    <span class="hljs-comment">// 声明队列</span><br>    amqpAdmin.declareQueue(queue);<br>    log.info(<span class="hljs-string">&quot;queue[&#123;&#125;] create success&quot;</span>, <span class="hljs-string">&quot;hello.java.queue&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<h6 id="5-2、效果图"><a href="#5-2、效果图" class="headerlink" title="5.2、效果图"></a>5.2、效果图</h6><p><img src="/img/guli_img/Java%E5%88%9B%E5%BB%BA%E9%98%9F%E5%88%97%E6%88%90%E5%8A%9F%E6%95%88%E6%9E%9C.png" alt="Java创建队列成功效果"></p>
<h5 id="6、测试：利用AmqpAdmin将交换机和队列进行绑定"><a href="#6、测试：利用AmqpAdmin将交换机和队列进行绑定" class="headerlink" title="6、测试：利用AmqpAdmin将交换机和队列进行绑定"></a>6、测试：利用AmqpAdmin将交换机和队列进行绑定</h5><h6 id="6-1、代码"><a href="#6-1、代码" class="headerlink" title="6.1、代码"></a>6.1、代码</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createBinding</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// 交换机与队列建立绑定关系 【将exchange指定的交换机和destination目的地进行绑定，使用routingKey作为指定的路由键】</span><br>    <span class="hljs-comment">// 【参数】：目的地：（队列）hello.java.queue   目的地类型：（跟队列还是交换机进行绑定）Binding.DestinationType.QUEUE   交换机：hello.java.exchange   路由键：hello.java   自定义参数：</span><br>    <span class="hljs-type">Binding</span> <span class="hljs-variable">binding</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Binding</span>(<span class="hljs-string">&quot;hello.java.queue&quot;</span>, Binding.DestinationType.QUEUE, <span class="hljs-string">&quot;hello.java.exchange&quot;</span>, <span class="hljs-string">&quot;hello.java&quot;</span>, <span class="hljs-literal">null</span>);<br>    amqpAdmin.declareBinding(binding);<br>    log.info(<span class="hljs-string">&quot;binding success&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<h6 id="6-2、效果图"><a href="#6-2、效果图" class="headerlink" title="6.2、效果图"></a>6.2、效果图</h6><p><img src="/img/guli_img/Java%E4%BA%A4%E6%8D%A2%E6%9C%BA%E7%BB%91%E5%AE%9A%E9%98%9F%E5%88%97%E7%BB%91%E5%AE%9A%E6%88%90%E5%8A%9F%E6%95%88%E6%9E%9C.png" alt="Java交换机绑定队列绑定成功效果"></p>
<h4 id="3、发送接收消息"><a href="#3、发送接收消息" class="headerlink" title="3、发送接收消息"></a>3、发送接收消息</h4><h5 id="1-1、测试：利用RabbitTemplate给交换机发送消息"><a href="#1-1、测试：利用RabbitTemplate给交换机发送消息" class="headerlink" title="1.1、测试：利用RabbitTemplate给交换机发送消息"></a>1.1、测试：利用RabbitTemplate给交换机发送消息</h5><h6 id="1、代码"><a href="#1、代码" class="headerlink" title="1、代码"></a>1、代码</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 可以帮助我们发送消息</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Autowired</span><br>RabbitTemplate rabbitTemplate;<br><br><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendMessageTest</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// 给哪个交换机发送消息   路由键是什么   消息内容</span><br>    rabbitTemplate.convertAndSend(<span class="hljs-string">&quot;hello.java.exchange&quot;</span>, <span class="hljs-string">&quot;hello.java&quot;</span>, <span class="hljs-string">&quot;Hello World!&quot;</span>);<br>    log.info(<span class="hljs-string">&quot;message send success [&#123;&#125;]&quot;</span>, <span class="hljs-string">&quot;Hello World!&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<h6 id="2、效果图"><a href="#2、效果图" class="headerlink" title="2、效果图"></a>2、效果图</h6><p><img src="/img/guli_img/Java%E7%BB%99%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%8F%91%E9%80%81%E6%B6%88%E6%81%AF%E6%88%90%E5%8A%9F%E6%95%88%E6%9E%9C.png" alt="Java给交换机发送消息成功效果.png"></p>
<h6 id="3、消息也可以不使用Java序列化，而是使用JSON"><a href="#3、消息也可以不使用Java序列化，而是使用JSON" class="headerlink" title="3、消息也可以不使用Java序列化，而是使用JSON"></a>3、消息也可以不使用Java序列化，而是使用JSON</h6><ul>
<li><p>1、给容器中放一个MessageConverter的bean，指定消息转换器为JSON的（如果不指定消息转换器，默认是Java序列化）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.springframework.amqp.support.converter.Jackson2JsonMessageConverter;<br><span class="hljs-keyword">import</span> org.springframework.amqp.support.converter.MessageConverter;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> taoao</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyRabbitConfig</span> &#123;<br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> MessageConverter <span class="hljs-title function_">messageConverter</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jackson2JsonMessageConverter</span>();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p>2、再次原封不动的使用上面的RabbitTemplate发送消息，这次的消息就是JSON格式的了</p>
<p><img src="/img/guli_img/Java%E7%BB%99%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%8F%91%E9%80%81%E6%B6%88%E6%81%AF%E6%8C%87%E5%AE%9A%E6%B6%88%E6%81%AF%E8%BD%AC%E6%8D%A2%E5%99%A8%E6%95%88%E6%9E%9C.png" alt="Java给交换机发送消息指定消息转换器效果.png"></p>
</li>
</ul>
<h5 id="3-2、测试：利用-RabbitListener注解监听队列，接收消息"><a href="#3-2、测试：利用-RabbitListener注解监听队列，接收消息" class="headerlink" title="3.2、测试：利用@RabbitListener注解监听队列，接收消息"></a>3.2、测试：利用<code>@RabbitListener</code>注解监听队列，接收消息</h5><p><strong>@RabbitListener注解既可以标在类上，也可以标在方法上</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@RabbitListener</span> 监听队列，接收消息</span><br><span class="hljs-comment">     * ---------注解的参数： queues 声明需要监听的队列，是个数组</span><br><span class="hljs-comment">     * --、方法接收消息时的参数  可以写以下几种类型</span><br><span class="hljs-comment">     * -------方法0、Object obj   【 可以直接写成Object类型， 】</span><br><span class="hljs-comment">     * -------方法1、Message message  【 原生消息详细信息，包含消息头、消息体 】</span><br><span class="hljs-comment">     * -------方法2、OrderReturnReasonEntity 【 可以直接写发送消息的类型 】</span><br><span class="hljs-comment">     * -------方法3、Channel channel  【 当前传输数据的通道 】</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * --、 队列可以有很多人来监听。只要有一个人收到此消息，队列就会删除这条消息 【 只能有一个人接收 】</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@RabbitListener(queues = &#123;&quot;hello.java.queue&quot;&#125;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">receiveMessage</span><span class="hljs-params">(Message message,</span><br><span class="hljs-params">                               OrderReturnReasonEntity content,</span><br><span class="hljs-params">                               Channel channel)</span> &#123;<br>        <span class="hljs-comment">// 拿到消息体</span><br>        <span class="hljs-type">byte</span>[] body = message.getBody();<br><br>        <span class="hljs-comment">// 消息头的属性信息</span><br>        <span class="hljs-type">MessageProperties</span> <span class="hljs-variable">messageProperties</span> <span class="hljs-operator">=</span> message.getMessageProperties();<br><br>        System.out.println(<span class="hljs-string">&quot;参数的第一种写法：原生消息：&quot;</span> + message);<br>        System.out.println(<span class="hljs-string">&quot;参数的第二种写法：直接写消息的类型：&quot;</span> + content);<br>        System.out.println(<span class="hljs-string">&quot;参数的第三种写法：接收消息的通道：&quot;</span> + channel);<br>    &#125;<br></code></pre></td></tr></table></figure>

<h5 id="3-3、测试：利用-RabbitListener注解和-RabbitHandler注解监听同一个队列不同类型的消息"><a href="#3-3、测试：利用-RabbitListener注解和-RabbitHandler注解监听同一个队列不同类型的消息" class="headerlink" title="3.3、测试：利用@RabbitListener注解和@RabbitHandler注解监听同一个队列不同类型的消息"></a>3.3、测试：利用@RabbitListener注解和@RabbitHandler注解监听同一个队列不同类型的消息</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RabbitListener(queues = &#123;&quot;hello.java.queue&quot;&#125;)</span><br><span class="hljs-meta">@Service(&quot;orderItemService&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderItemServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">OrderItemService</span> &#123;<br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 如果这个队列接收多种类型的消息，可以将<span class="hljs-doctag">@RabbitListener</span>注解标注在类上，代表监听哪个队列</span><br><span class="hljs-comment">     * 然后在不同的方法上使用<span class="hljs-doctag">@RabbitHandler</span>注解，分别接收不同类型的消息,比如OrderReturnReasonEntity类型和OrderEntity类型</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> entity</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@RabbitHandler</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">receiveMessage1</span><span class="hljs-params">(OrderReturnReasonEntity entity)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;接收到的第一种消息：&quot;</span> + entity);<br>    &#125;<br><br>    <span class="hljs-meta">@RabbitHandler</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">receiveMessage2</span><span class="hljs-params">(OrderEntity entity)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;接收到的第二种消息：&quot;</span> + entity);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="4、可靠投递—发送端确认"><a href="#4、可靠投递—发送端确认" class="headerlink" title="4、可靠投递—发送端确认"></a>4、可靠投递—发送端确认</h4><h5 id="4-1、在application-yml中进行配置"><a href="#4-1、在application-yml中进行配置" class="headerlink" title="4.1、在application.yml中进行配置"></a>4.1、在application.yml中进行配置</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">rabbitmq:</span><br>    <span class="hljs-attr">host:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.100</span><span class="hljs-number">.135</span><br>    <span class="hljs-attr">port:</span> <span class="hljs-number">5672</span><br>    <span class="hljs-attr">virtual-host:</span> <span class="hljs-string">/</span><br>    <span class="hljs-attr">username:</span> <span class="hljs-string">guest</span><br>    <span class="hljs-attr">password:</span> <span class="hljs-string">guest</span><br>    <span class="hljs-comment"># 开启发送端确认  消息抵达broker确认</span><br>    <span class="hljs-attr">publisher-confirms:</span> <span class="hljs-literal">true</span><br>    <span class="hljs-comment"># 开启发送端确认  消息抵达queue确认</span><br>    <span class="hljs-attr">publisher-returns:</span> <span class="hljs-literal">true</span><br>    <span class="hljs-comment"># 如果消息抵达了队列，就会以异步的方式优先执行publisher-returns这个回调</span><br>    <span class="hljs-attr">template:</span><br>      <span class="hljs-attr">mandatory:</span> <span class="hljs-literal">true</span><br></code></pre></td></tr></table></figure>

<h5 id="4-2、定制RabbitTemplate"><a href="#4-2、定制RabbitTemplate" class="headerlink" title="4.2、定制RabbitTemplate"></a>4.2、定制RabbitTemplate</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyRabbitConfig</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    RabbitTemplate rabbitTemplate;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 定制RabbitTemplate  【 设置确认回调 】</span><br><span class="hljs-comment">     * 1、服务器收到消息就回调</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@PostConstruct</span>  <span class="hljs-comment">// 在MyRabbitConfig这个配置类的构造器创建完（MyRabbitConfig对象创建完）之后，调用这个方法</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initRabbitTemplate</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// 设置确认回调</span><br>        rabbitTemplate.setConfirmCallback(<span class="hljs-keyword">new</span> <span class="hljs-title class_">RabbitTemplate</span>.ConfirmCallback() &#123;<br>            <span class="hljs-comment">/**</span><br><span class="hljs-comment">             * 当交换机收到消息，就会自动回调这个方法</span><br><span class="hljs-comment">             * 1、只要消息抵达Broker，ack就是true</span><br><span class="hljs-comment">             * <span class="hljs-doctag">@param</span> correlationData correlation data for the callback. 当前消息的唯一关联数据【 唯一id 】</span><br><span class="hljs-comment">             * <span class="hljs-doctag">@param</span> ack true for ack, false for nack 消息是否成功收到</span><br><span class="hljs-comment">             * <span class="hljs-doctag">@param</span> cause An optional cause, for nack, when available, otherwise null. 失败的原因</span><br><span class="hljs-comment">             */</span><br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">confirm</span><span class="hljs-params">(CorrelationData correlationData, <span class="hljs-type">boolean</span> ack, String cause)</span> &#123;<br>                System.out.println(<span class="hljs-string">&quot;confirm...correlationData[&quot;</span> + correlationData + <span class="hljs-string">&quot;]===&gt;ack[&quot;</span> + ack + <span class="hljs-string">&quot;]===&gt;cause[&quot;</span> + cause + <span class="hljs-string">&quot;]&quot;</span>);<br>            &#125;<br>        &#125;);<br><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * 设置消息抵达队列的确认回调</span><br><span class="hljs-comment">         * 1、只要消息抵达queue</span><br><span class="hljs-comment">         */</span><br>        rabbitTemplate.setReturnCallback(<span class="hljs-keyword">new</span> <span class="hljs-title class_">RabbitTemplate</span>.ReturnCallback() &#123;<br>            <span class="hljs-comment">/**</span><br><span class="hljs-comment">             * 失败回调 【 消息抵达queue不会触发 】</span><br><span class="hljs-comment">             * 只要消息没有抵达queue，就触发这个失败回调</span><br><span class="hljs-comment">             * <span class="hljs-doctag">@param</span> message the returned message. 哪个消息投递到queue失败，消息的详细信息</span><br><span class="hljs-comment">             * <span class="hljs-doctag">@param</span> replyCode the reply code.  回复的状态码</span><br><span class="hljs-comment">             * <span class="hljs-doctag">@param</span> replyText the reply text. 回复的文本内容</span><br><span class="hljs-comment">             * <span class="hljs-doctag">@param</span> exchange the exchange. 当时这个消息发给哪个交换机</span><br><span class="hljs-comment">             * <span class="hljs-doctag">@param</span> routingKey the routing key. 当时这个消息用的哪个路由键</span><br><span class="hljs-comment">             */</span><br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">returnedMessage</span><span class="hljs-params">(Message message, <span class="hljs-type">int</span> replyCode, String replyText, String exchange, String routingKey)</span> &#123;<br>                System.out.println(<span class="hljs-string">&quot;Fail Message[&quot;</span> + message + <span class="hljs-string">&quot;]==&gt;replyCode[&quot;</span> + replyCode + <span class="hljs-string">&quot;]===&gt;replyText[&quot;</span> + replyText + <span class="hljs-string">&quot;]===&gt;exchange[&quot;</span> + exchange + <span class="hljs-string">&quot;]==&gt;routingKey[&quot;</span> + routingKey + <span class="hljs-string">&quot;]&quot;</span>);<br>            &#125;<br>        &#125;);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="5、可靠抵达—Ack消息确认机制"><a href="#5、可靠抵达—Ack消息确认机制" class="headerlink" title="5、可靠抵达—Ack消息确认机制"></a>5、可靠抵达—Ack消息确认机制</h4><ul>
<li>消费端确认：保证每个消息被正确消费，此时broker才可以删除这个消息</li>
<li>1、默认是自动确认的，只要消息接收到，客户端会自动确认，broker就会移除这个消息<ul>
<li>问题：收到很多消息了，自动回复给服务器ack（确认），只有一个消息处理成功，这时宕机了，剩下的消息就会丢失。</li>
<li>所以需要手动确认 【 处理一个，确认一个 】</li>
</ul>
</li>
</ul>
<h5 id="5-1、开启手动确认消息"><a href="#5-1、开启手动确认消息" class="headerlink" title="5.1、开启手动确认消息"></a>5.1、开启手动确认消息</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">rabbitmq:</span><br>    <span class="hljs-attr">host:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.100</span><span class="hljs-number">.135</span><br>    <span class="hljs-attr">port:</span> <span class="hljs-number">5672</span><br>    <span class="hljs-attr">virtual-host:</span> <span class="hljs-string">/</span><br>    <span class="hljs-attr">username:</span> <span class="hljs-string">guest</span><br>    <span class="hljs-attr">password:</span> <span class="hljs-string">guest</span><br>    <span class="hljs-attr">publisher-confirms:</span> <span class="hljs-literal">true</span><br>    <span class="hljs-attr">publisher-returns:</span> <span class="hljs-literal">true</span><br>    <span class="hljs-attr">template:</span><br>      <span class="hljs-attr">mandatory:</span> <span class="hljs-literal">true</span><br>      <span class="hljs-comment"># 手动ack消息 (手动确认消息)</span><br>    <span class="hljs-attr">listener:</span><br>      <span class="hljs-attr">simple:</span><br>        <span class="hljs-attr">acknowledge-mode:</span> <span class="hljs-string">manual</span><br></code></pre></td></tr></table></figure>

<h5 id="5-2、在接收消息时使用channel接收消息，手动确认-拒绝收到消息"><a href="#5-2、在接收消息时使用channel接收消息，手动确认-拒绝收到消息" class="headerlink" title="5.2、在接收消息时使用channel接收消息，手动确认\拒绝收到消息"></a>5.2、在接收消息时使用channel接收消息，手动确认\拒绝收到消息</h5><p><strong>只要不手动确认收到消息，消息就一直在queue中存在</strong></p>
<blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java">&gt;<span class="hljs-comment">// 确认接收消息</span><br>&gt;<span class="hljs-comment">// 两个参数：第一个：消息的标识    第二个：是否批量确认（channel有很多消息，true代表批量确认；false代表单个确认）</span><br>&gt;channel.basicAck(deliveryTag, <span class="hljs-literal">false</span>);  <span class="hljs-comment">// 确认收到消息</span><br><br>&gt;<span class="hljs-comment">// 确认不接收消息 (方式1)</span><br>&gt;<span class="hljs-comment">// 三个参数：消息的标识  是否批量拒绝  是否重新放入队列</span><br>&gt;channel.basicNack(deliveryTag, <span class="hljs-literal">false</span>, <span class="hljs-literal">true</span>);<br>&gt;<span class="hljs-comment">// 确认不接收消息 (方式2)</span><br>&gt;<span class="hljs-comment">// 两个参数：消息的标识   是否重新放入队列</span><br>&gt;channel.basicReject(deliveryTag, <span class="hljs-literal">true</span>);<br></code></pre></td></tr></table></figure>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java">	 <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 在接收消息时使用channl接收消息，手动确认收到消息</span><br><span class="hljs-comment">     * 只要不手动确认收到消息，消息就一直在queue中存在，即使Java服务器宕机，消息也不会丢失</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> message</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> content</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> channel</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@RabbitHandler</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">receiveMessage</span><span class="hljs-params">(Message message,</span><br><span class="hljs-params">                               Channel channel)</span> &#123;<br>        <span class="hljs-comment">// 消息的标识，是在channel内自增的</span><br>        <span class="hljs-type">long</span> <span class="hljs-variable">deliveryTag</span> <span class="hljs-operator">=</span> message.getMessageProperties().getDeliveryTag();<br><span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">if</span> (deliveryTag % <span class="hljs-number">2</span> == <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-comment">// 确认接收消息</span><br>                <span class="hljs-comment">// 两个参数：第一个：消息的标识    第二个：是否批量确认（channel有很多消息，true代表批量确认；false代表单个确认）</span><br>                channel.basicAck(deliveryTag, <span class="hljs-literal">false</span>);  <span class="hljs-comment">// 确认收到消息</span><br>                System.out.println(<span class="hljs-string">&quot;收到了消息：&quot;</span> + deliveryTag);<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-comment">// 确认不接收消息 (方式1)</span><br>                <span class="hljs-comment">// 三个参数：消息的标识  是否批量拒绝  是否重新放入队列</span><br>                channel.basicNack(deliveryTag, <span class="hljs-literal">false</span>, <span class="hljs-literal">true</span>);<br>                <span class="hljs-comment">// 确认不接收消息 (方式2)</span><br>                <span class="hljs-comment">// 两个参数：消息的标识   是否重新放入队列</span><br>                <span class="hljs-comment">// channel.basicReject();</span><br>                System.out.println(<span class="hljs-string">&quot;没有收到货物：&quot;</span> + deliveryTag);<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            <span class="hljs-comment">// 网络中断了</span><br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure>



	<div class="row">
    <embed src="/pdf/gulimall/RabbitMQ.pdf" width="100%" height="550" type="application/pdf">
	</div>




<h3 id="十一、接口幂等性"><a href="#十一、接口幂等性" class="headerlink" title="十一、接口幂等性"></a>十一、接口幂等性</h3>

	<div class="row">
    <embed src="/pdf/gulimall/接口幂等性.pdf" width="100%" height="550" type="application/pdf">
	</div>










































<h2 id="2、项目中的小技巧"><a href="#2、项目中的小技巧" class="headerlink" title="2、项目中的小技巧"></a>2、项目中的小技巧</h2><blockquote>
<p>1、整合MyBatis-Plus</p>
<ul>
<li>1）、导入依赖</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.baomidou<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.2.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<ul>
<li>2）、配置<br>1、配置数据源；<br>   1）、导入数据库的驱动<br>   2）、在application.yml配置数据源的相关信息<br>2、配置MyBatis-Plus；<br>   1）、使用<code>@MapperScan</code><br>   2）、告诉MyBatis-Plus，sql映射文件位置</li>
</ul>
<p>2、逻辑删除<br>步骤 1: 配置<code>com.baomidou.mybatisplus.core.config.GlobalConfig$DbConfig</code></p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">mybatis-plus:</span><br>   <span class="hljs-attr">global-config:</span><br>       <span class="hljs-attr">db-config:</span><br>           <span class="hljs-attr">logic-delete-field:</span> <span class="hljs-string">flag</span> <span class="hljs-comment"># 全局逻辑删除的实体字段名(since 3.3.0,配置后可以忽略不配置步骤2)</span><br>           <span class="hljs-attr">logic-delete-value:</span> <span class="hljs-number">1</span> <span class="hljs-comment"># 逻辑已删除值(默认为 1)</span><br>           <span class="hljs-attr">logic-not-delete-value:</span> <span class="hljs-number">0</span> <span class="hljs-comment"># 逻辑未删除值(默认为 0)</span><br></code></pre></td></tr></table></figure>

<p>步骤 2: 实体类字段上加上<code>@TableLogic</code>注解</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@TableLogic</span><br><span class="hljs-keyword">private</span> Integer deleted;<br></code></pre></td></tr></table></figure>

<p>3、JSR303数据校验</p>
<ul>
<li>1）、给Bean中的字段添加校验注解，并定义自己的message 提示  【<code> javax.validation.constraints</code> 包下 】</li>
<li>2）、开启校验功能 ： 在Controller接口接收参数时，使用 @Valid 注解<br>效果：校验错误以后会有默认的响应</li>
<li>3）、给校验的bean后紧跟一个BindingResult，就可以获取到校验的结果  【 <code>public R save(@Valid @RequestBody BrandEntity brand, BindingResult result)&#123;&#125;</code> 】</li>
<li>4）、分组检验（多场景的复杂校验）<ul>
<li>步骤：<br>1、首先创建好多个空接口，用作不同的分组<br>2、给校验注解标注 groups 字段，指定 ”步骤1“中创建的空接口<br>3、Controller 中，接口上使用【 <code>@Validated(分组（空接口）.class)</code> 】注解  【【     <code>public R save(@Validated(AddGroup.class) @RequestBody BrandEntity rand) &#123;&#125;</code> 】】<br>注意：<br>   1、@Validated 注解如果不指定分组，那么都会生效<br>   2、@Validated(value&#x3D;{分组.class}) 注解如果指定了分组，那么它只会校验对应分组的数据是否正常</li>
</ul>
</li>
<li>5）、自定义校验<br>步骤：<br>   1、编写一个自定义的校验注解<br>   2、编写一个自定义的校验器<br>   3、关联这个校验器和这个校验注解</li>
</ul>
<p>4、统一异常处理</p>
<ul>
<li>1）、对于抛出的异常，可以创建统一异常处理类，<ul>
<li>1、使用 <code>@RestControllerAdvice(basePackages=&quot;需要异常处理的包&quot;) </code>注解标注这个类</li>
<li>2、使用 <code>@ExceptionHandler(value=&quot;具体的异常类型.class&quot;) </code>注解标注其中的方法， 【 返回值类型：R、 参数：具体的异常类型 】</li>
</ul>
</li>
<li>2）、对于常见的异常状态码以及提示消息，可以创建枚举类统一管理</li>
</ul>
<p>5、VO<br>作用：<br>接收页面传递来的数据，封装对象<br>将业务处理完的对象，封装成页面要用的数据</p>
<p>6、Controller 只接收请求 和 接收和校验数据<br>Service 接收 Controller 传来的数据，进行业务处理<br>Controller 接收 Service 处理完的数据，封装成页面指定的Vo</p>
<p>7、To ： 不同服务之间传递的pojo 就是 To</p>
<p>8、feign 使用步骤<br>步骤：</p>
<ul>
<li>1、将调用者 与 被调用者 都注册到注册中心中</li>
<li>2、在调用者的启动类中加上 <code>@EnableFeignClients</code> 注解</li>
<li>3、在调用者中创建接口，指定被调用者的完整方法签名 【 @FeignClient(“gulimall-coupon”)  &#x2F;&#x2F; 调用哪个远程服务         】<br>【 public interface CouponFeignService {                      】<br>【                                                             】<br>【     @PostMapping(“&#x2F;coupon&#x2F;spubounds&#x2F;save”)                    】<br>【     R saveSpuBounds(@RequestBody SpuBoundTo spuBoundTo);       】<br>【 }                                                             】</li>
</ul>
<p>9、设置服务占用的最大内存  【 VM options   -Xmx100m 】</p>
<p>10、设置批量启动服务<br>步骤：<br>1、Edit Configurations…<br>2、点击 + 号   —&gt;   Compound    —&gt;   依次把服务加进来</p>
<p>11、Spring中日期格式化<br>在application.yml 中配置： spring.jackson.data-format: yyyy-MM-dd HH:mm:ss</p>
<p>12、整个事务出现异常后 无需回滚的两种方式<br>方式1： try  catch 掉异常<br>拿try包裹住可能发生异常的代码，catch中啥也不用干</p>
<p>  13、模板引擎</p>
<ul>
<li>1）、引入thymeleaf-starter依赖； 关闭了缓存</li>
<li>2）、静态资源都放在static 文件夹下就可以按照路径直接访问</li>
<li>3）、页面放在templates 下，直接访问<br>SpringBoot访问项目的时候，默认会找index.html</li>
<li>4)、页面修改不重启服务器的情况下实时更新<br>1、引入SpringBoot中的dev-tools依赖<br>2、在配置类中关闭thymeleaf的缓存<br>3、修改完html页面后， 摁 Ctrl + F9</li>
</ul>
<p> 14、整合redis</p>
<ul>
<li><p>1）、引入 <code>spring-boot-starter-data-redis</code> 依赖</p>
</li>
<li><p>2）、简单配置redis的host等信息</p>
</li>
<li><p>3）、使用SpringBoot自动配置好的StringRedisTemplate 来操作redis</p>
<p>lettuce 和 jedis 都是操作redis 的底层的客户端。Spring对他俩再次封装，封装成了RedisTemplate;</p>
</li>
</ul>
<p> 15、整合redisson作为分布式锁等功能的框架<br>  1）、引入依赖</p>
<pre><code class="hljs">     <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.redisson<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>redisson<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.12.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>       <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>
</code></pre>
<p>  2）、配置redisson</p>
<p> 16、整合SpringCache，简化缓存开发 【 使用redis作为缓存 】<br> 1）、引入 <code>spring-boot-starter-cache</code> 依赖</p>
<pre><code class="hljs">     <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-cache<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>       <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>       <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>
</code></pre>
<p> 2）、写配置</p>
<ul>
<li><p>自动配置了哪些？  【 在 <code>CacheAutoConfiguration</code> 中 】</p>
<ul>
<li>1、CacheAutoConfiguration 会导入 RedisCacheConfiguration；</li>
<li>2、RedisCacheConfiguration自动配好了CachaManager（缓存管理器）</li>
</ul>
</li>
<li><p>我们需要配置哪些？</p>
<p>配置使用Redis作为缓存<br>缓存的类型 [ 配置使用Redis作为缓存 ]<br>spring.cache.type&#x3D;redis</p>
</li>
<li><p>3）、测试使用缓存<br>3.1、开启缓存功能<br> 在启动类上加上注解 <code>@EnableCaching  </code> 开启缓存功能<br>3.2、只需要使用注解就能完成缓存操作  @Cacheable</p>
</li>
<li><p>4）、原理：<br>缓存的自动配置（CacheAutoConfiguration）导入了RedisCacheConfiguration；<br>RedisCacheConfiguration注入了缓存管理器（RedisCacheManager）<br>    缓存管理器会按照配置文件中配的缓存名字来 初始化所有的缓存；<br>        每个初始化缓存决定使用什么配置<br>            如果redisConfiguration有就用，没有就用默认配置<br>所以想改缓存的配置，只需要给容器中放一个RedisCacheConfiguration即可，就会应用到当前缓存管理器（RedisCacheManager）管理的所有缓存分区中</p>
</li>
<li><p>5）、SpringCache的不足<br>1、读模式：<br>    缓存穿透：查询一个永不存在的数据。 解决：缓存空数据<br>    缓存击穿：大量并发进来同时查询一个正好过期的数据。 解决：加锁  【 SpringCache默认是没有加锁的 （@Cacheable注解可以通过设置sync属性&#x3D;true加锁） 】<br>        @Cacheable(value &#x3D; {“category”}, key &#x3D; “#root.method.name”, sync &#x3D; true)<br>    缓存雪崩：大量key同时过期。 解决：加随机时间；指定过期时间就行。<br>2、写模式：（缓存与数据库一致）<br>    1、读写加锁。（适用于读多写少的系统）<br>    2、引入Canal中间件。感知到MySQL的更新去更新缓存<br>    3、读多写多的直接去数据库查询<br>  原理：<br>SpringCache中有一个CacheManager缓存管理器；  【 比如RedisCacheManager 】<br>缓存管理器可以造出很多的缓存组件Cache；  【 比如RedisCache 】<br>缓存组件负责缓存的读写；<br>  总结：<br>常规数据（读多写少，即时性和一致性要求不高的数据）可以使用SpringCache；写模式（只要缓存的数据有过期时间就足够了）<br>特殊数据：特殊设计</p>
</li>
</ul>
<p> 17、将线程池交给Spring进行管理<br>  1）、编写配置类MyThreadConfig，使用@Configuration注解；将ThreadPoolExecutor交给Spring进行管理，使用@Bean注解<br>  2）、编写自定义配置类ThreadPoolConfigProperties，使用@ConfigurationProperties(prefix &#x3D; “gulimall.thread”)     指定配置的前缀；使用@Component将这个类交给Spring进行管理；使用@Data注解引入getter、setter方法</p>
<pre><code class="hljs">    既可以在ThreadPoolConfigProperties 类中使用@Component 注解
    也可以在MyThreadConfig 类中使用@EnableConfigurationProperties(ThreadPoolConfigProperties.class) 注解
</code></pre>
<p>  3）、加入依赖：<code>spring-boot-configuration-processor</code>之后，在application.yml中就有自动提示了</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml">  <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>   <br>   <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-configuration-processor<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">optional</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">optional</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>4)、在application.yml进行配置</p>
<p>18、当service层需要给controller层返回异常数据时，但是service层的方法没有对应的返回值，可以使用异常机制<br>      1）、自定义异常类，实现RuntimeException类；编写构造方法可以指定异常的具体内容<br>      2）、在service层中，不符合要求的代码处，throw抛出自定义异常， throws进行声明<br>      3）、在controller层中 通过try catch进行捕获处理</p>
</blockquote>
<h4 id="19、密码加密"><a href="#19、密码加密" class="headerlink" title="19、密码加密"></a>19、密码加密</h4><h5 id="1、MD5-MD5盐值加密-介绍"><a href="#1、MD5-MD5盐值加密-介绍" class="headerlink" title="1、MD5 &amp; MD5盐值加密 介绍"></a>1、<strong>MD5 &amp; MD5盐值加密</strong> 介绍</h5><ul>
<li>MD5：<ul>
<li>Message Digest algorithm 5，信息摘要算法<ul>
<li>压缩性：任意长度的数据，算出的MD5值长度都是固定的</li>
<li>容易计算：从原数据计算出MD5值很容易</li>
<li>抗修改性：对原数据进行任何改动，哪怕只修改1个字节，所得到的MD5值都有很大区别</li>
<li>强抗碰撞：想找到两个不同的数据，使它们具有相同的MD5值，是非常困难的</li>
</ul>
</li>
</ul>
</li>
<li>加盐：<ul>
<li>通过生成随机数与MD5生成的字符串进行组合</li>
<li>数据库同时存储MD5值与salt值。验证正确性时使用salt进行MD5即可</li>
</ul>
</li>
</ul>
<h5 id="2、Spring-提供好了盐值加密的方法，不用提供额外的salt字段"><a href="#2、Spring-提供好了盐值加密的方法，不用提供额外的salt字段" class="headerlink" title="2、Spring 提供好了盐值加密的方法，不用提供额外的salt字段"></a>2、Spring 提供好了盐值加密的方法，不用提供额外的salt字段</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">BCryptPasswordEncoder</span> <span class="hljs-variable">passwordEncoder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BCryptPasswordEncoder</span>();<br><span class="hljs-type">String</span> <span class="hljs-variable">encode</span> <span class="hljs-operator">=</span> passwordEncoder.encode(<span class="hljs-string">&quot;明文密码&quot;</span>);  <span class="hljs-comment">// 返回值encode 就是加密完成的密码，直接存数据库即可</span><br><br><span class="hljs-comment">// 要想验证密码对不对使用以下办法</span><br><span class="hljs-type">boolean</span> <span class="hljs-variable">matches</span> <span class="hljs-operator">=</span> passwordEncoder.matches(<span class="hljs-string">&quot;用户新输入的明文密码&quot;</span>, <span class="hljs-string">&quot;数据库存储的加密完成的密码&quot;</span>);  <span class="hljs-comment">// 可以验证密码是否正确</span><br></code></pre></td></tr></table></figure>

<h4 id="20、Feign远程调用丢失请求头问题解决"><a href="#20、Feign远程调用丢失请求头问题解决" class="headerlink" title="20、Feign远程调用丢失请求头问题解决"></a>20、Feign远程调用丢失请求头问题解决</h4><p><strong>因为Feign进行远程调用会新构建一个请求，这个新请求不携带任何信息</strong></p>
<ul>
<li>1、往Spring容器中加入Feign的拦截器，加上浏览器发送请求时的cookie信息</li>
<li>2、使用RequestContextHolder 拿到浏览器进来的请求</li>
<li>3、给拦截器的requestTemplate 添加上请求头信息即可</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> feign.RequestInterceptor;<br><span class="hljs-keyword">import</span> feign.RequestTemplate;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><span class="hljs-keyword">import</span> org.springframework.web.context.request.RequestContextHolder;<br><span class="hljs-keyword">import</span> org.springframework.web.context.request.ServletRequestAttributes;<br><br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletRequest;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> taoao</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GuliFeignConfig</span> &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 往Spring容器中加入Feign的拦截器，加上浏览器发送请求时的cookie信息</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean(&quot;requestInterceptor&quot;)</span><br>    <span class="hljs-keyword">public</span> RequestInterceptor <span class="hljs-title function_">requestInterceptor</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RequestInterceptor</span>() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">apply</span><span class="hljs-params">(RequestTemplate requestTemplate)</span> &#123;<br>                <span class="hljs-comment">// 1、使用RequestContextHolder 拿到浏览器进来的请求</span><br>                <span class="hljs-type">ServletRequestAttributes</span> <span class="hljs-variable">requestAttributes</span> <span class="hljs-operator">=</span> (ServletRequestAttributes) RequestContextHolder.getRequestAttributes();<br>                <span class="hljs-type">HttpServletRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> requestAttributes.getRequest();<br><br>                <span class="hljs-comment">// 2、同步请求头数据 （同步cookie）</span><br>                <span class="hljs-type">String</span> <span class="hljs-variable">cookie</span> <span class="hljs-operator">=</span> request.getHeader(<span class="hljs-string">&quot;Cookie&quot;</span>);<br>                <span class="hljs-comment">// 给Feign远程调用时的请求，添加上cookie</span><br>                requestTemplate.header(<span class="hljs-string">&quot;Cookie&quot;</span>, cookie);<br><br>            &#125;<br>        &#125;;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>


                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E6%8A%80%E6%9C%AF/" class="category-chain-item">技术</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/Java/" class="print-no-link">#Java</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>谷粒商城</div>
      <div>http://example.com/2024/02/26/谷粒商城/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>John Doe</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2024年2月26日</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>更新于</div>
          <div>2024年3月4日</div>
        </div>
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2024/02/26/SSM/" title="SSM">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">SSM</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <i class="iconfont icon-love"></i> <a href="https://syea01.github.io" target="_blank" rel="nofollow noopener"><span>首页</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        总访问量 
        <span id="busuanzi_value_site_pv"></span>
         次
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        总访客数 
        <span id="busuanzi_value_site_uv"></span>
         人
      </span>
    
    
  
</div>

  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>







  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
